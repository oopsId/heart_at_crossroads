<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heart at Crossroads</title>
    <link rel="stylesheet" href="/heart_at_crossroads/styles.css">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'GoodVibesCyr', cursive;
            color: #fff;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        #background {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            transition: background-image 0.5s ease-in-out;
        }
        #parallax-layer1, #parallax-layer2 {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            transition: transform 0.5s ease-in-out;
        }
        #character-left, #character-right {
            position: absolute;
            bottom: 0;
            width: 40%;
            height: 80%;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: bottom;
            transition: opacity 0.5s ease-in-out;
        }
        #character-left {
            left: 0;
        }
        #character-right {
            right: 0;
        }
        #dialogue-box {
            position: absolute;
            bottom: 10%;
            left: 10%;
            width: 80%;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: opacity 0.3s ease-in-out;
        }
        #choices {
            margin-top: 20px;
        }
        .choice-btn {
            background: #fff;
            color: #000;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'GoodVibesCyr', cursive;
        }
        .choice-btn:hover {
            background: #ddd;
        }
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/heart_at_crossroads/assets/backgrounds/start_screen.png') no-repeat center/cover;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #start-btn {
            padding: 20px 40px;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="background"></div>
        <div id="parallax-layer1"></div>
        <div id="parallax-layer2"></div>
        <div id="character-left"></div>
        <div id="character-right"></div>
        <div id="dialogue-box">
            <div id="speaker"></div>
            <div id="dialogue-text"></div>
            <div id="choices"></div>
        </div>
        <div id="start-screen">
            <button id="start-btn">Start</button>
        </div>
    </div>

    <script>
        const backgroundElement = document.getElementById('background');
        const parallaxLayer1 = document.getElementById('parallax-layer1');
        const parallaxLayer2 = document.getElementById('parallax-layer2');
        const charLeft = document.getElementById('character-left');
        const charRight = document.getElementById('character-right');
        const dialogueBox = document.getElementById('dialogue-box');
        const speakerElement = document.getElementById('speaker');
        const dialogueElement = document.getElementById('dialogue-text');
        const choicesElement = document.getElementById('choices');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');

        let currentChapter = null;
        let currentSceneIndex = 0;
        let stats = {
            relationships: { anna: 0, vika: 0, dima: 0, mark: 0, sergey: 0, lesha: 0 },
            diamonds: 10,
            crown: 0,
            leaf: 0,
            language: 'ru'
        };

        // –ê—Å—Å–µ—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–π –≥–ª–∞–≤—ã
        const images = [
            '/heart_at_crossroads/assets/backgrounds/start_screen.png',
            '/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png',
            '/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png',
            '/heart_at_crossroads/assets/backgrounds/bg_webstudio_day.png',
            '/heart_at_crossroads/assets/characters/anna/anna_sad_style2.png',
            '/heart_at_crossroads/assets/characters/anna/anna_neutral_style2.png',
            '/heart_at_crossroads/assets/characters/anna/anna_happy_style2.png',
            '/heart_at_crossroads/assets/characters/vika/vika_smile_style1.png',
            '/heart_at_crossroads/assets/characters/vika/vika_neutral_style1.png',
            '/heart_at_crossroads/assets/characters/vika/vika_happy_style1.png',
            '/heart_at_crossroads/assets/characters/dima/dima_happy_style1.png',
            '/heart_at_crossroads/assets/characters/mark/mark_neutral_style1.png',
            '/heart_at_crossroads/assets/characters/sergey/sergey_smile_style1.png',
            '/heart_at_crossroads/assets/ui/crown.png',
            '/heart_at_crossroads/assets/ui/diamonds.png',
            '/heart_at_crossroads/assets/ui/heart.png',
            '/heart_at_crossroads/assets/ui/leaf.png'
        ];

        const availableBackgrounds = [
            'bg_apartment_morning', 'bg_phone_messenger', 'bg_webstudio_day'
        ];
        const availableCharacters = [
            'anna_sad_style2', 'anna_neutral_style2', 'anna_happy_style2',
            'vika_smile_style1', 'vika_neutral_style1', 'vika_happy_style1',
            'dima_happy_style1', 'mark_neutral_style1', 'sergey_smile_style1'
        ];

        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤
        function preloadAssets() {
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤—ã
        async function loadChapter(chapterId) {
            if (chapterId > 1) {
                showChapterPlaceholder(chapterId);
                return;
            }
            try {
                const response = await fetch(`/heart_at_crossroads/data/chapter${chapterId}.json`);
                currentChapter = await response.json();
                currentSceneIndex = 0;
                showScene();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã:', error);
            }
        }

        // –ü–æ–∫–∞–∑ —Å—Ü–µ–Ω—ã
        function showScene() {
            const scene = currentChapter.scenes[currentSceneIndex];
            applyScene(scene);
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã
        function applyScene(scene) {
            // –§–æ–Ω
            let newBackground = scene.background || 'bg_apartment_morning';
            if (!availableBackgrounds.includes(newBackground)) {
                backgroundElement.style.backgroundImage = "url('/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png')";
                dialogueElement.innerHTML += "<p style='color: red;'>[–ó–∞–≥–ª—É—à–∫–∞: –§–æ–Ω " + newBackground + " –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]</p>";
            } else {
                backgroundElement.style.backgroundImage = `url('/heart_at_crossroads/assets/backgrounds/${newBackground}.png')`;
            }

            // –ü–µ—Ä—Å–æ–Ω–∞–∂–∏
            charLeft.style.opacity = '0';
            charRight.style.opacity = '0';
            if (scene.characterLeft && availableCharacters.includes(scene.characterLeft)) {
                charLeft.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${scene.characterLeft.split('_')[0]}/${scene.characterLeft}.png')`;
                charLeft.style.opacity = '1';
            } else if (scene.characterLeft) {
                dialogueElement.innerHTML += "<p style='color: red;'>[–ó–∞–≥–ª—É—à–∫–∞: –ü–µ—Ä—Å–æ–Ω–∞–∂ " + scene.characterLeft + " –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]</p>";
            }
            if (scene.characterRight && availableCharacters.includes(scene.characterRight)) {
                charRight.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${scene.characterRight.split('_')[0]}/${scene.characterRight}.png')`;
                charRight.style.opacity = '1';
            } else if (scene.characterRight) {
                dialogueElement.innerHTML += "<p style='color: red;'>[–ó–∞–≥–ª—É—à–∫–∞: –ü–µ—Ä—Å–æ–Ω–∞–∂ " + scene.characterRight + " –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]</p>";
            }

            // –ó–≤—É–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞)
            if (scene.sound || scene.music) {
                console.log("[–ó–∞–≥–ª—É—à–∫–∞: –ó–≤—É–∫ " + (scene.sound || scene.music) + " –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç]");
            }

            // –î–∏–∞–ª–æ–≥
            speakerElement.textContent = scene.speaker[stats.language];
            dialogueElement.textContent = scene.text[stats.language];

            // –í—ã–±–æ—Ä—ã
            choicesElement.innerHTML = '';
            if (scene.choices) {
                scene.choices.forEach(choice => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = choice.text[stats.language];
                    if (choice.cost && stats.diamonds < choice.cost) {
                        btn.disabled = true;
                        btn.textContent += ` (${choice.cost} üíé)`;
                    }
                    btn.onclick = () => makeChoice(choice);
                    choicesElement.appendChild(btn);
                });
            } else {
                dialogueBox.onclick = nextScene;
            }
        }

        // –°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞
        function nextScene() {
            currentSceneIndex++;
            if (currentSceneIndex >= currentChapter.scenes.length) {
                loadChapter(2); // –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ç–æ—Ä–æ–π –≥–ª–∞–≤–µ (–≤—ã–∑–æ–≤–µ—Ç –∑–∞–≥–ª—É—à–∫—É)
            } else {
                showScene();
            }
        }

        // –í—ã–±–æ—Ä
        function makeChoice(choice) {
            if (choice.cost) {
                stats.diamonds -= choice.cost;
            }
            if (choice.effects) {
                applyEffects(choice.effects);
            }
            if (choice.nextScene) {
                currentSceneIndex = choice.nextScene;
                showScene();
            } else if (choice.nextChapter) {
                loadChapter(choice.nextChapter);
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        function applyEffects(effects) {
            Object.keys(effects).forEach(key => {
                if (key === 'relationships') {
                    Object.keys(effects[key]).forEach(char => {
                        stats.relationships[char] += effects[key][char];
                    });
                } else {
                    stats[key] += effects[key];
                }
            });
        }

        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≥–ª–∞–≤ 2 –∏ –≤—ã—à–µ
        function showChapterPlaceholder(chapterId) {
            dialogueBox.innerHTML = `<p style='color: yellow;'>–ì–ª–∞–≤–∞ ${chapterId} –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>`;
            choicesElement.innerHTML = '';
            backgroundElement.style.backgroundImage = "url('/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png')";
            charLeft.style.opacity = '0';
            charRight.style.opacity = '0';
        }

        // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã
        startBtn.onclick = () => {
            startScreen.style.display = 'none';
            dialogueBox.style.opacity = '1';
            preloadAssets();
            loadChapter(1);
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        dialogueBox.style.opacity = '0';
    </script>
</body>
</html>
