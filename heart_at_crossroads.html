<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сердце на перекрёстке</title>
    <style>
        /* Стили остаются без изменений */
        @font-face {
            font-family: 'LobsterTwo';
            src: url('/heart_at_crossroads/assets/fonts/LobsterTwo-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'GreatVibes';
            src: url('/heart_at_crossroads/assets/fonts/GreatVibes-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoodVibesCyr';
            src: url('/heart_at_crossroads/assets/fonts/GoodVibesCyr.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        .parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: 0% center;
            background-repeat: no-repeat;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slideBackground 60s linear infinite;
            z-index: 1;
            transition: opacity 1s ease;
        }
        @keyframes slideBackground {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }
        .character-left, .character-right {
            position: absolute;
            bottom: 0;
            width: 70%;
            max-width: 100vw;
            height: 100vh;
            max-height: 100vh;
            background-position: bottom center;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 2;
            transition: opacity 1s ease, transform 0.3s ease, filter 0.3s ease;
            animation: appear 0.5s ease-in-out forwards;
        }
        @keyframes appear {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes shiver {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .shiver {
            animation: shiver 0.5s infinite;
        }
        .heartbeat {
            animation: heartbeat 1s 3;
        }
        .character-left { left: -15%; transform: translateX(0); }
        .character-right { right: -15%; transform: translateX(0); }
        .character-speaker {
            transform: scale(1.1);
            filter: brightness(1.2);
            z-index: 3;
        }
        .character-non-speaker {
            transform: scale(1);
            filter: brightness(1);
            z-index: 2;
        }
        .dialogue-box {
            position: absolute;
            bottom: 20%;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(93, 64, 55, 0.8), rgba(93, 64, 55, 0.4));
            color: #F5F0E1;
            padding: 2px 20px 20px;
            text-align: center;
            z-index: 3;
            transition: opacity 1s ease, bottom 0.3s ease;
            opacity: 1;
            min-height: 150px;
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-sizing: border-box;
        }
        #speaker-name {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #E6D5C0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #dialogue-text {
            margin: 5px 0;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .choice-btn {
            display: block;
            margin: 10px auto;
            padding: 10px;
            width: 90%;
            background: linear-gradient(to bottom, #F5F0E1, #E6D5C0);
            color: #5D4037;
            border: 1px solid rgba(93, 64, 55, 0.2);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            white-space: normal;
            min-height: 44px;
            height: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 5px rgba(93, 64, 55, 0.3);
        }
        .choice-btn:disabled {
            background: linear-gradient(to bottom, #666, #555);
            opacity: 0.7;
            box-shadow: none;
        }
        .choice-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #E6D5C0, #D4BEA6);
            box-shadow: 0 3px 7px rgba(93, 64, 55, 0.4);
        }
        #menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 4;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            max-width: calc(100% - 20px);
            overflow-x: auto;
            white-space: nowrap;
        }
        #menu div {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        #menu img {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }
        #menu span {
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #menu-btn, #stats {
            margin: 0 5px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.8), rgba(160, 120, 90, 0.8));
            color: #5D4037;
            border: none;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #menu-btn:hover, #stats:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.9), rgba(160, 120, 90, 0.9));
        }
        .choice-feedback {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            z-index: 4;
            animation: flyUp 3s ease-out forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh); opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            width: 5px;
            height: 5px;
            opacity: 0.7;
        }
        @keyframes flyUp {
            0% { bottom: 50%; opacity: 1; }
            50% { bottom: 60%; opacity: 0.8; }
            100% { bottom: 70%; opacity: 0; }
        }
        .fade-out {
            opacity: 0;
            transition: opacity 1s ease;
        }
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/heart_at_crossroads/assets/backgrounds/start_screen.png') center/cover no-repeat #FFF5E6;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }
        #start-screen h1 {
            color: #A67C52;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        #start-screen h1.ru {
            font-family: 'GoodVibesCyr', sans-serif;
        }
        #start-screen h1.en {
            font-family: 'GreatVibes', sans-serif;
        }
        #start-screen h1 span:first-child {
            font-size: 48px;
        }
        #start-screen h1 span:last-child {
            font-size: 40px;
        }
        .start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            position: relative;
        }
        .start-buttons button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .start-buttons button:nth-child(1) {
            left: -30px;
        }
        .start-buttons button:nth-child(2) {
            left: 30px;
        }
        .start-buttons button:nth-child(3) {
            left: -30px;
        }
        #gallery-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: absolute;
            left: -130px;
            top: 50%;
            transform: translateY(-50%);
        }
        .start-buttons button:hover, #gallery-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background: rgba(245, 240, 225, 0.9);
        }
        #password-form {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #password-input {
            padding: 12px;
            font-size: 16px;
            border-radius: 20px;
            border: 1px solid rgba(93, 64, 55, 0.3);
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            width: 220px;
            text-align: center;
        }
        #password-submit {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #back-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(200, 180, 160, 0.6);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .placeholder-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            z-index: 10;
        }
        #progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #333;
            z-index: 4;
            display: none;
        }
        #progress {
            width: 0%;
            height: 100%;
            background: #DEB887;
            transition: width 0.5s ease;
        }
        #language-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid #fff;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            z-index: 6;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .memory-notification {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.7), rgba(160, 120, 90, 0.7));
            color: #5D4037;
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        #debug-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(255, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
        #timer-countdown {
            position: absolute;
            bottom: calc(20% + 50px);
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            color: #ff4444;
            font-weight: bold;
            z-index: 4;
        }
        @keyframes flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
            100% { filter: brightness(1); }
        }
        .flash-svg { animation: flash 0.5s ease; }
        .choice-btn { z-index: 5; }
        .error-message {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
        }
        .phone-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            width: 240px;
            height: 400px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1 id="title" data-ru="Сердце<br>на перекрёстке" data-en="Heart<br>at the Crossroads">
            <span>Сердце</span>
            <span>на перекрёстке</span>
        </h1>
        <div class="start-buttons">
            <button id="start-game" data-ru="Начать игру" data-en="Start Game">Начать игру</button>
            <button id="continue-game" data-ru="Продолжить" data-en="Continue">Продолжить</button>
            <button id="show-password" data-ru="Ввести пароль" data-en="Enter Password">Ввести пароль</button>
            <button id="gallery-btn" data-ru="Галерея" data-en="Gallery">Галерея</button>
        </div>
        <div id="password-form">
            <input type="text" id="password-input" placeholder="Введите пароль">
            <button id="password-submit" data-ru="Войти" data-en="Login">Войти</button>
        </div>
        <button id="language-btn">
            <span id="language-icon">🇷🇺</span>
        </button>
    </div>
    <div id="game-container">
        <div class="parallax-bg" id="background" style="display: none;"></div>
        <div class="character-left" id="character-left" style="display: none;"></div>
        <div class="character-right" id="character-right" style="display: none;"></div>
        <div class="dialogue-box" id="dialogue-box" style="display: none;">
            <p id="speaker-name"></p>
            <p id="dialogue-text"></p>
        </div>
        <div id="progress-bar" style="display: none;">
            <div id="progress"></div>
        </div>
        <div id="menu" style="display: none;">
            <div id="diamonds">
                <img src="/heart_at_crossroads/assets/ui/diamonds.png" alt="Бриллианты">
                <span id="diamonds-count">10</span>
            </div>
            <button id="menu-btn" data-ru="Меню" data-en="Menu">Меню</button>
            <button id="stats">Статы</button>
        </div>
        <div id="particles" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3;"></div>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script>
        // Проверка Telegram
        const isTelegram = !!(window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe);
        if (isTelegram) {
            try {
                Telegram.WebApp.ready();
                console.log('Telegram Web App инициализирован');
            } catch (error) {
                console.error('Ошибка инициализации Telegram:', error);
                alert('Ошибка Telegram Web App. Функции могут быть ограничены.');
            }
        } else {
            console.log('Запуск в браузере');
        }

        const userId = isTelegram ? Telegram.WebApp.initDataUnsafe.user?.id : null;
        let currentChapter = 1;
        let currentScene = 0;
        let choices = [];
        let stats = {
            crown: 0,
            heart: 0,
            leaf: 0,
            diamonds: 10,
            relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
            appearance: "style1",
            isAuthorized: false,
            memories: [],
            language: "ru",
            hasReturnedViaMenu: false,
            completionCount: 0
        };
        let isTyping = false;
        let scriptData = null;
        let currentBackground = null;
        const correctPassword = "umbertoeco";
        const tempPassword = "999000";

        function playSound(sound) {
            if (sound) {
                const audio = new Audio(`/heart_at_crossroads/assets/sounds/${sound}`);
                audio.play()
                    .catch(error => {
                        console.error(`Ошибка воспроизведения звука ${sound}:`, error);
                        showErrorMessage(stats.language === "ru" ? `Звук ${sound} не найден` : `Sound ${sound} not found`);
                    });
            }
        }

        function playMusic(music) {
            if (music) {
                if (window.currentMusic) window.currentMusic.pause();
                window.currentMusic = new Audio(`/heart_at_crossroads/assets/sounds/${music}`);
                window.currentMusic.loop = true;
                window.currentMusic.play()
                    .catch(error => {
                        console.error(`Ошибка воспроизведения музыки ${music}:`, error);
                        showErrorMessage(stats.language === "ru" ? `Музыка ${music} не найдена` : `Music ${music} not found`);
                    });
            }
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // Улучшенные функции хранения
        function saveToStorage(key, value) {
            return new Promise((resolve, reject) => {
                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.isVersionAtLeast && 
                        window.Telegram.WebApp.isVersionAtLeast('6.0')) {
                        window.Telegram.WebApp.CloudStorage.setItem(key, value)
                            .then(() => {
                                console.log(`Сохранено в Telegram CloudStorage: ${key}`);
                                resolve();
                            })
                            .catch(err => {
                                console.warn('Ошибка Telegram CloudStorage, переход на localStorage:', err);
                                localStorage.setItem(key, value);
                                console.log(`Сохранено в localStorage: ${key}`);
                                resolve();
                            });
                    } else {
                        localStorage.setItem(key, value);
                        console.log(`Сохранено в localStorage: ${key}`);
                        resolve();
                    }
                } catch (error) {
                    console.warn('Ошибка сохранения, переход на in-memory storage:', error);
                    if (!window._inMemoryStorage) window._inMemoryStorage = {};
                    window._inMemoryStorage[key] = value;
                    console.log(`Сохранено в in-memory storage: ${key}`);
                    resolve();
                }
            });
        }

        function getFromStorage(key) {
            return new Promise((resolve, reject) => {
                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.isVersionAtLeast && 
                        window.Telegram.WebApp.isVersionAtLeast('6.0')) {
                        window.Telegram.WebApp.CloudStorage.getItem(key)
                            .then(value => {
                                console.log(`Получено из Telegram CloudStorage: ${key}`);
                                resolve(value);
                            })
                            .catch(err => {
                                console.warn('Ошибка Telegram CloudStorage, переход на localStorage:', err);
                                const value = localStorage.getItem(key);
                                console.log(`Получено из localStorage: ${key}`);
                                resolve(value);
                            });
                    } else {
                        const value = localStorage.getItem(key);
                        console.log(`Получено из localStorage: ${key}`);
                        resolve(value);
                    }
                } catch (error) {
                    console.warn('Ошибка получения, переход на in-memory storage:', error);
                    if (!window._inMemoryStorage) window._inMemoryStorage = {};
                    const value = window._inMemoryStorage[key] || null;
                    console.log(`Получено из in-memory storage: ${key}`);
                    resolve(value);
                }
            });
        }

        function saveSession() {
            const sessionData = JSON.stringify({
                currentScene,
                currentChapter,
                stats,
                choices
            });
            saveToStorage('gameSession', sessionData)
                .then(() => {
                    console.log('Сессия успешно сохранена');
                })
                .catch(error => {
                    console.error('Ошибка сохранения сессии:', error);
                    showDebugMessage('Ошибка сохранения сессии');
                });
        }

        // Утилита для событий
        const addEventListeners = (element, events, handler) => {
            events.forEach(event => {
                element.addEventListener(event, handler);
                console.log(`Привязан ${event} к ${element.id}`);
            });
        };

        // Загрузка DOM
        document.addEventListener('DOMContentLoaded', () => {
            const startGameBtn = document.getElementById('start-game');
            const continueGameBtn = document.getElementById('continue-game');
            const showPasswordBtn = document.getElementById('show-password');
            const passwordSubmitBtn = document.getElementById('password-submit');
            const menuBtn = document.getElementById('menu-btn');
            const statsBtn = document.getElementById('stats');
            const galleryBtn = document.getElementById('gallery-btn');
            const languageBtn = document.getElementById('language-btn');
            const languageIcon = document.getElementById('language-icon');

            if (!startGameBtn) console.error('Кнопка start-game не найдена!');
            updateLanguage(stats.language);

            // Обработчики с логированием
            function handleStartGame(e) {
                e.preventDefault();
                console.log('handleStartGame вызван');
                checkTempPassword(() => startNewGame());
            }

            function handleContinueGame(e) {
                e.preventDefault();
                console.log('handleContinueGame вызван');
                checkTempPassword(() => loadSession(() => startGame()));
            }

            function handleShowPassword(e) {
                e.preventDefault();
                console.log('handleShowPassword вызван');
                document.getElementById('password-form').style.display = 'flex';
                document.querySelector('.start-buttons').style.display = 'none';
            }

            async function handlePasswordSubmit(e) {
                e.preventDefault();
                console.log('handlePasswordSubmit вызван');
                const inputPassword = document.getElementById('password-input').value;
                try {
                    if (inputPassword === tempPassword || inputPassword === correctPassword) {
                        if (inputPassword === correctPassword) {
                            let authorizedUsers = JSON.parse(await getFromStorage('authorized_users') || '[]');
                            if (userId && !authorizedUsers.includes(userId)) {
                                authorizedUsers.push(userId);
                                await saveToStorage('authorized_users', JSON.stringify(authorizedUsers));
                            }
                            stats.isAuthorized = true;
                        }
                        startNewGame();
                    } else {
                        alert(stats.language === "ru" ? 'Неверный пароль!' : 'Incorrect password!');
                    }
                } catch (error) {
                    console.error('Ошибка обработки пароля:', error);
                    alert(stats.language === "ru" ? 'Ошибка авторизации.' : 'Authorization error.');
                }
            }

            function handleMenu(e) {
                e.preventDefault();
                console.log('handleMenu вызван');
                stats.hasReturnedViaMenu = true;
                resetGameState();
                saveSession();
                showStartScreen();
            }

            function handleShowStats(e) {
                e.preventDefault();
                console.log('handleShowStats вызван');
                const statsText = stats.language === "ru" ?
                    `Короны: ${stats.crown}\nСердце: ${stats.heart}\nЛист: ${stats.leaf}\nБриллианты: ${stats.diamonds}\nОтношения:\nМарк: ${stats.relationships.mark}\nЛера: ${stats.relationships.lera}\nВика: ${stats.relationships.vika}\nСергей: ${stats.relationships.sergey}\nАнна: ${stats.relationships.anna}\nДима: ${stats.relationships.dima}\nЛёша: ${stats.relationships.lesha}` :
                    `Crowns: ${stats.crown}\nHeart: ${stats.heart}\nLeaf: ${stats.leaf}\nDiamonds: ${stats.diamonds}\nRelationships:\nMark: ${stats.relationships.mark}\nLera: ${stats.relationships.lera}\nVika: ${stats.relationships.vika}\nSergey: ${stats.relationships.sergey}\nAnna: ${stats.relationships.anna}\nDima: ${stats.relationships.dima}\nLesha: ${stats.relationships.lesha}`;
                alert(statsText);
            }

            function handleLanguageSwitch(e) {
                e.preventDefault();
                console.log('handleLanguageSwitch вызван');
                stats.language = stats.language === "ru" ? "en" : "ru";
                languageIcon.textContent = stats.language === "ru" ? "🇷🇺" : "🇬🇧";
                updateLanguage(stats.language);
                saveSession();
            }

            // Привязка событий
            addEventListeners(startGameBtn, ['click', 'touchstart'], handleStartGame);
            addEventListeners(continueGameBtn, ['click', 'touchstart'], handleContinueGame);
            addEventListeners(showPasswordBtn, ['click', 'touchstart'], handleShowPassword);
            addEventListeners(passwordSubmitBtn, ['click', 'touchstart'], handlePasswordSubmit);
            addEventListeners(menuBtn, ['click', 'touchstart'], handleMenu);
            addEventListeners(statsBtn, ['click', 'touchstart'], handleShowStats);
            addEventListeners(galleryBtn, ['click', 'touchstart'], (e) => e.preventDefault());
            addEventListeners(languageBtn, ['click', 'touchstart'], handleLanguageSwitch);

            // Кнопка "Назад"
            const backButton = document.createElement('button');
            backButton.id = 'back-button';
            backButton.textContent = stats.language === "ru" ? "Назад" : "Back";
            addEventListeners(backButton, ['click', 'touchstart'], (e) => {
                e.preventDefault();
                console.log('backButton вызван');
                document.getElementById('password-form').style.display = 'none';
                document.querySelector('.start-buttons').style.display = 'flex';
            });
            document.getElementById('password-form').appendChild(backButton);

            // Инициализация
            getFromStorage('last_session')
                .then(session => {
                    console.log('Сессия загружена:', session);
                    if (session) showStartScreen();
                    else checkAuthorization();
                })
                .catch(error => {
                    console.error('Ошибка загрузки сессии:', error);
                    showStartScreen();
                });
        });

        // Остальные функции
        function showStartScreen() {
            console.log('showStartScreen вызван');
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('language-btn').style.display = 'block';
            document.getElementById('game-container').style.display = 'none';
        }

        function resetGameState() {
            console.log('resetGameState вызван');
            currentChapter = 1;
            currentScene = 0;
            choices = [];
            stats = {
                crown: 0,
                heart: 0,
                leaf: 0,
                diamonds: 10,
                relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
                appearance: "style1",
                isAuthorized: stats.isAuthorized,
                memories: [],
                language: stats.language,
                hasReturnedViaMenu: true,
                completionCount: stats.completionCount
            };
            currentBackground = null;
        }

        function updateLanguage(lang) {
            console.log('updateLanguage вызван с языком:', lang);
            document.getElementById('start-game').textContent = document.getElementById('start-game').getAttribute(`data-${lang}`);
            document.getElementById('continue-game').textContent = document.getElementById('continue-game').getAttribute(`data-${lang}`);
            document.getElementById('show-password').textContent = document.getElementById('show-password').getAttribute(`data-${lang}`);
            document.getElementById('password-submit').textContent = document.getElementById('password-submit').getAttribute(`data-${lang}`);
            document.getElementById('menu-btn').textContent = document.getElementById('menu-btn').getAttribute(`data-${lang}`);
            document.getElementById('gallery-btn').textContent = document.getElementById('gallery-btn').getAttribute(`data-${lang}`);
            const title = document.getElementById('title');
            title.innerHTML = lang === "ru" ? '<span>Сердце</span><span>на перекрёстке</span>' : '<span>Heart</span><span>at the Crossroads</span>';
            title.className = lang === "ru" ? "ru" : "en";
        }

        async function checkAuthorization() {
            try {
                const authorizedUsers = (await getFromStorage('authorized_users')) || [];
                if (userId && authorizedUsers.includes(userId)) {
                    stats.isAuthorized = true;
                    startGame();
                } else {
                    showStartScreen();
                }
            } catch (error) {
                console.error('Ошибка авторизации:', error);
                showStartScreen();
            }
        }

        async function checkTempPassword(callback) {
            try {
                const granted = await getFromStorage('tempAccessGranted');
                if (granted) {
                    console.log('Временный доступ уже предоставлен');
                    callback();
                } else {
                    const input = prompt(stats.language === "ru" ? 'Игра закрыта на доработку. Введите пароль:' : 'Game is under refinement. Enter password:');
                    if (input === tempPassword || input === correctPassword) {
                        await saveToStorage('tempAccessGranted', true);
                        if (input === correctPassword) stats.isAuthorized = true;
                        console.log('Пароль верный, доступ предоставлен');
                        callback();
                    } else {
                        alert(stats.language === "ru" ? 'Неверный пароль!' : 'Incorrect password!');
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки пароля:', error);
                alert(stats.language === "ru" ? 'Ошибка доступа.' : 'Access error.');
            }
        }

        function startNewGame() {
            console.log('startNewGame вызван');
            resetGameState();
            saveSession();
            startGame();
        }

        async function loadSession(callback) {
            try {
                const session = await getFromStorage('last_session');
                if (session) {
                    currentChapter = session.currentChapter;
                    currentScene = session.currentScene;
                    choices = session.choices;
                    stats = { ...stats, ...session.stats };
                    console.log('Сессия загружена:', session);
                }
                if (callback) callback();
            } catch (error) {
                console.error('Ошибка загрузки сессии:', error);
            }
        }

           function showMessengerOverlay(sceneId) {
    console.log(`Создание оверлея для сцены ${sceneId}`);
    const existingOverlay = document.getElementById('messenger-overlay');
    if (existingOverlay) existingOverlay.remove();

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('id', 'messenger-overlay');
    svg.setAttribute('width', '240');
    svg.setAttribute('height', '400');
    svg.setAttribute('viewBox', '0 0 300 500');
    svg.classList.add('phone-overlay');

    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('x', '0');
    rect.setAttribute('y', '0');
    rect.setAttribute('width', '300');
    rect.setAttribute('height', '500');
    rect.setAttribute('fill', 'rgba(0, 0, 0, 0.7)');
    svg.appendChild(rect);

    const sceneData = scriptData.scenes.find(s => s.id === sceneId) || {};
    const speaker = sceneData.speaker ? sceneData.speaker[stats.language] : 'Unknown';

    const avatar = document.createElementNS('http://www.w3.org/2000/svg', 'image');
    avatar.setAttribute('x', '20');
    avatar.setAttribute('y', '20');
    avatar.setAttribute('width', '50');
    avatar.setAttribute('height', '50');
    avatar.setAttributeNS('http://www.w3.org/1999/xlink', 'href', 
        `/heart_at_crossroads/assets/characters/${speaker.toLowerCase()}/${speaker.toLowerCase()}_messenger_ava.png`);
    svg.appendChild(avatar);

    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', '80');
    text.setAttribute('y', '50');
    text.setAttribute('fill', '#fff');
    text.setAttribute('font-size', '16');
    text.textContent = speaker;
    svg.appendChild(text);

    const message = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    message.setAttribute('x', '20');
    message.setAttribute('y', '100');
    message.setAttribute('fill', '#fff');
    message.setAttribute('font-size', '14');
    message.textContent = sceneData.text ? sceneData.text[stats.language].substring(0, 100) : '';
    svg.appendChild(message);

    document.getElementById('game-container').appendChild(svg);
    return svg;
}

function createDefaultOverlay(sceneId, sceneData = {}) {
    console.log(`Создание стандартного оверлея для сцены ${sceneId}`);
    const overlay = document.createElement('div');
    overlay.classList.add('phone-overlay');
    overlay.style.background = 'url(/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png) no-repeat center/cover';
    
    const speaker = sceneData.speaker ? sceneData.speaker[stats.language] : 'Unknown';
    const avatar = document.createElement('img');
    avatar.src = `/heart_at_crossroads/assets/characters/${speaker.toLowerCase()}/${speaker.toLowerCase()}_messenger_ava.png`;
    avatar.style.width = '40px';
    avatar.style.height = '40px';
    avatar.style.position = 'absolute';
    avatar.style.top = '20px';
    avatar.style.left = '20px';
    avatar.onerror = () => console.warn(`Аватар для ${speaker} не найден`);
    overlay.appendChild(avatar);

    const name = document.createElement('div');
    name.textContent = speaker;
    name.style.position = 'absolute';
    name.style.top = '25px';
    name.style.left = '70px';
    name.style.color = '#fff';
    name.style.fontSize = '16px';
    overlay.appendChild(name);

    const message = document.createElement('div');
    message.textContent = sceneData.text ? sceneData.text[stats.language].substring(0, 100) : '';
    message.style.position = 'absolute';
    message.style.top = '70px';
    message.style.left = '20px';
    message.style.right = '20px';
    message.style.color = '#fff';
    message.style.fontSize = '14px';
    overlay.appendChild(message);

    document.getElementById('game-container').appendChild(overlay);
    return overlay;
}


        async function startGame() {
            try {
                console.log('startGame вызван');
                showDebugMessage('Инициализация игры...');
                document.getElementById('game-container').style.display = 'block';
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('language-btn').style.display = 'none';

                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:10;display:flex;justify-content:center;align-items:center;color:#fff;';
                loadingOverlay.innerHTML = '<span>Загрузка...</span>';
                document.body.appendChild(loadingOverlay);

                await preloadAssets(currentChapter);
                await loadChapter(currentChapter);

                document.getElementById('background').style.display = 'block';
                document.getElementById('character-left').style.display = 'block';
                document.getElementById('character-right').style.display = 'block';
                document.getElementById('dialogue-box').style.display = 'block';
                document.getElementById('menu').style.display = 'flex';
                document.getElementById('progress-bar').style.display = 'block';

                document.getElementById('stats').style.display = stats.isAuthorized ? 'block' : 'none';
                updateDiamondsDisplay();

                loadingOverlay.remove();
                showScene(currentScene);
            } catch (error) {
                console.error('Ошибка в startGame:', error);
                showDebugMessage(`Ошибка: ${error.message}`);
                alert(stats.language === "ru" ? 'Ошибка запуска игры.' : 'Game start error.');
                document.getElementById('loading-overlay')?.remove();
                showStartScreen();
            }
        }

        function updateDiamondsDisplay() {
            document.getElementById('diamonds-count').textContent = stats.diamonds;
        }

        function showDebugMessage(message) {
            let debugDiv = document.getElementById('debug-message');
            if (!debugDiv) {
                debugDiv = document.createElement('div');
                debugDiv.id = 'debug-message';
                document.body.appendChild(debugDiv);
            }
            debugDiv.textContent = message;
            setTimeout(() => debugDiv.remove(), 5000);
        }

        function checkAssetExists(url) {
            return fetch(url, { method: 'HEAD' })
                .then(res => res.ok)
                .catch(() => false);
        }
        

        async function preloadAssets(chapterId, options = {}) {
            console.log(`Начало загрузки ресурсов для главы: ${chapterId}`);
            const language = options.language || 'ru';
            const texts = {
                loading: language === 'ru' ? 'Загрузка' : 'Loading',
                imageNotFound: language === 'ru' ? 'Изображение не найдено' : 'Image not found',
                loadError: language === 'ru' ? 'Не удалось загрузить' : 'Failed to load'
            };
            const loadingStatus = document.createElement('div');
            loadingStatus.id = 'loading-status';
            loadingStatus.style.cssText = 'position: fixed; bottom: 10px; left: 10px; color: white; font-size: 12px; z-index: 11; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 3px;';
            document.body.appendChild(loadingStatus);
            const images = [
                '/heart_at_crossroads/assets/backgrounds/start_screen.png',
                '/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png',
                '/heart_at_crossroads/assets/backgrounds/bg_coffee_shop.png',
                '/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_day_trash.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_dusk_end.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_night.png',
                '/heart_at_crossroads/assets/backgrounds/bg_webstudio_day.png',
                '/heart_at_crossroads/assets/backgrounds/bg_webstudio_night.png',
                '/heart_at_crossroads/assets/characters/anna/anna_angry_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_happy_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_happy_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style3.png',
                '/heart_at_crossroads/assets/characters/anna/anna_sad_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_sad_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style2_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_surprised_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_worry_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_worry_style2.png',
                '/heart_at_crossroads/assets/characters/dima/dima_happy_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_sad_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_smile_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_worry_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_happy_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_messenger_ava.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_sad_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_smile_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_worry_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_happy_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_messenger_ava.png',
                '/heart_at_crossroads/assets/characters/mark/mark_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_sad_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_smile_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_worry_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_happy_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_sad_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_smile_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_worry_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_confident_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_happy_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_happy_style1_summer.png',
                '/heart_at_crossroads/assets/characters/vika/vika_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_sad_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_sad_style1_summer.png',
                '/heart_at_crossroads/assets/characters/vika/vika_smile_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_worry_style1.png'
            ];
            let loaded = 0;
            const totalImages = images.length;
            const failedImages = [];
            const updateStatus = () => {
                const percentage = Math.floor((loaded / totalImages) * 100);
                loadingStatus.textContent = `${texts.loading}: ${loaded}/${totalImages} (${percentage}%)`;
            };
            const showErrorMessage = (message) => {
                const errorElement = document.createElement('div');
                errorElement.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(255,0,0,0.7); color: white; padding: 10px; z-index: 9999; border-radius: 5px;';
                errorElement.textContent = message;
                document.body.appendChild(errorElement);
                setTimeout(() => {
                    errorElement.style.opacity = '0';
                    errorElement.style.transition = 'opacity 0.5s';
                    setTimeout(() => errorElement.remove(), 500);
                }, 3000);
            };
            updateStatus();
            try {
                const promises = images.map(src => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            loaded++;
                            updateStatus();
                            console.log(`✅ ${texts.loading}: ${src}`);
                            resolve(true);
                        };
                        img.onerror = () => {
                            loaded++;
                            failedImages.push(src.split('/').pop());
                            updateStatus();
                            console.warn(`❌ ${texts.loadError}: ${src}`);
                            resolve(false);
                        };
                        img.src = src;
                    });
                });
                const results = await Promise.all(promises);
                const successCount = results.filter(success => success).length;
                console.log(`✅ ${texts.loading}: ${successCount}/${totalImages} успешно загружены`);
                if (failedImages.length > 0) {
                    failedImages.slice(0, 3).forEach(img => {
                        showErrorMessage(`${texts.imageNotFound}: ${img}`);
                    });
                    if (failedImages.length > 3) {
                        showErrorMessage(`${texts.imageNotFound}: ${failedImages.length - 3} more...`);
                    }
                }
                return { 
                    success: successCount, 
                    failed: failedImages.length, 
                    failedImages 
                };
            } catch (error) {
                console.error('Ошибка при загрузке изображений:', error);
                throw error;
            } finally {
                loadingStatus.style.opacity = '0';
                loadingStatus.style.transition = 'opacity 0.5s';
                setTimeout(() => loadingStatus.remove(), 500);
            }
        }

        async function loadChapter(chapterId) {
            console.log(`Загрузка главы ${chapterId}`);
            const jsonPath = `/heart_at_crossroads/assets/data/chapter${chapterId}.json`;
            try {
                const response = await fetch(jsonPath, {
                    headers: {
                        'Content-Type': 'application/json; charset=UTF-8',
                        'Accept': 'application/json'
                    }
                });
                if (!response.ok) throw new Error(`Не удалось загрузить главу ${chapterId}: ${response.statusText}`);
                const text = await response.text();
                const data = JSON.parse(text);
                if (!data || !data.scenes || !Array.isArray(data.scenes)) {
                    throw new Error('Некорректный формат JSON');
                }
                scriptData = data;
                console.log(`Данные главы ${chapterId} успешно загружены`);
            } catch (error) {
                console.error('Ошибка загрузки главы:', error);
                throw error;
            }
        }

        function createChoiceButton(choice) {
            const btn = document.createElement('button');
            const hasCostInText = choice.text[stats.language].includes(`${choice.cost}`);
            let buttonText = choice.text[stats.language].replace(" (10 сек)", "").replace(" (10 sec)", "");
            btn.textContent = choice.cost && !hasCostInText 
                ? `${buttonText} (${choice.cost} бриллиантов)` 
                : buttonText;
            btn.className = 'choice-btn';
            if (choice.text[stats.language].length > 30) btn.style.fontSize = '12px';
            if (choice.text[stats.language].length > 60) btn.style.minHeight = '64px';
            return btn;
        }

        function saveChoice(choiceId, effects, memoryTag) {
            choices.push(choiceId);
            if (effects) {
                for (let key in effects) {
                    if (key === 'relationships') {
                        for (let rel in effects[key]) {
                            stats.relationships[rel] = (stats.relationships[rel] || 0) + effects[key][rel];
                        }
                    } else {
                        stats[key] = (stats[key] || 0) + effects[key];
                    }
                }
            }
            if (memoryTag) {
                stats.memories.push(memoryTag);
                const notification = document.createElement('div');
                notification.className = 'memory-notification';
                notification.textContent = stats.language === "ru" ? "Вика запомнит ваш выбор" : "Vika will remember your choice";
                document.getElementById('game-container').appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
            saveSession();
        }

       function showScene(sceneId) {
    console.log(`Показ сцены ${sceneId}`);
    const scene = scriptData.scenes[sceneId];
    if (!scene) {
        console.error('Сцена не найдена:', sceneId);
        return;
    }

    const progressElement = document.getElementById('progress');
    const totalScenes = scriptData.scenes.length;
    const progressPercent = ((scene.id + 1) / totalScenes) * 100;
    progressElement.style.width = `${progressPercent}%`;

    const backgroundElement = document.getElementById('background');
    const charLeft = document.getElementById('character-left');
    const charRight = document.getElementById('character-right');
    const dialogueElement = document.getElementById('dialogue-text');
    const dialogueBox = document.querySelector('.dialogue-box');

    let displayText = scene.text[stats.language];
    if (stats.completionCount >= 1 && scene.second_playthrough_text) {
        displayText = scene.second_playthrough_text[stats.language];
    }

    const newBackground = scene.background || 'none';
    const shouldFade = currentBackground !== newBackground || scene.id === scriptData.scenes.length - 1;

    const applyScene = async () => {
        const bgUrl = newBackground === 'none' ? 'none' : `/heart_at_crossroads/assets/backgrounds/${newBackground}.png`;
        if (bgUrl !== 'none' && !(await checkAssetExists(bgUrl))) {
            console.warn(`Фон ${newBackground}.png не найден`);
            showErrorMessage(stats.language === "ru" ? `Фон ${newBackground} не найден` : `Background ${newBackground} not found`);
        }
        backgroundElement.style.backgroundImage = bgUrl === 'none' ? 'none' : `url('${bgUrl}')`;
        currentBackground = newBackground;

        charLeft.style.backgroundImage = 'none';
        charRight.style.backgroundImage = 'none';
        charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
        charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

        const speakerName = scene.speaker ? scene.speaker[stats.language] : '';
        if (scene.characterLeft) {
            const leftChar = scene.characterLeft.includes('${stats.appearance}') 
                ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
                : scene.characterLeft;
            const leftCharUrl = `/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png`;
            if (!(await checkAssetExists(leftCharUrl))) {
                console.warn(`Персонаж ${leftChar}.png не найден`);
                showErrorMessage(stats.language === "ru" ? `Персонаж ${leftChar} не найден` : `Character ${leftChar} not found`);
            }
            charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
            charLeft.classList.add(speakerName === "Анна" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
        }
        if (scene.characterRight) {
            const rightChar = scene.characterRight.includes('${stats.appearance}') 
                ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
                : scene.characterRight;
            const rightCharUrl = `/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png`;
            if (!(await checkAssetExists(rightCharUrl))) {
                console.warn(`Персонаж ${rightChar}.png не найден`);
                showErrorMessage(stats.language === "ru" ? `Персонаж ${rightChar} не найден` : `Character ${rightChar} not found`);
            }
            charRight.style.backgroundImage = `url('${rightCharUrl}')`;
            charRight.classList.add(speakerName === "Вика" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
        }

        document.getElementById('speaker-name').textContent = speakerName;

        let overlay = null;
        const textLower = displayText.toLowerCase();
        if (textLower.includes('телефон') || textLower.includes('phone') || textLower.includes('telegram') || 
            textLower.includes('whatsapp') || textLower.includes('вконтакте') || textLower.includes('vkontakte')) {
            const sceneData = scriptData.scenes.find(s => s.id === sceneId) || {};
            overlay = createDefaultOverlay(sceneId, sceneData);
        }

        // Очистка старых обработчиков перед вызовом typeText
        console.log('Очистка старых обработчиков перед выводом текста');
        dialogueBox.onclick = null;
        dialogueBox.ontouchstart = null;
        document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());

        // Внутри applyScene:
typeText(displayText, dialogueElement, () => {
    console.log(`[${Date.now()}] Текст сцены ${sceneId} полностью показан`);
    dialogueBox.style.pointerEvents = 'auto';
    if (scene.choices && scene.choices.length > 0) {
        if (scene.choices.some(c => c.timer)) {
            console.log(`[${Date.now()}] Переход к showSceneWithTimer`);
            showSceneWithTimer(scene);
        } else {
            console.log(`[${Date.now()}] Показываем кнопки выбора`);
            scene.choices.forEach(choice => {
                const btn = createChoiceButton(choice);
                if (choice.condition && !checkCondition(choice.condition)) {
                    btn.style.display = 'none';
                } else if (choice.cost && stats.diamonds < choice.cost) {
                    btn.disabled = true;
                } else {
                    const handleChoice = (e) => {
                        e.preventDefault();
                        console.log(`[${Date.now()}] Выбор сделан: ${choice.id}`);
                        if (choice.cost) stats.diamonds -= choice.cost;
                        updateDiamondsDisplay();
                        saveChoice(choice.id, choice.effects, choice.memoryTag);
                        if (choice.effects) showChoiceEffects(choice.effects);
                        if (overlay) overlay.remove();
                        if (choice.nextScene !== undefined) {
                            currentScene = choice.nextScene;
                            saveSession();
                            showScene(currentScene);
                        } else if (choice.nextChapter) {
                            currentChapter = choice.nextChapter;
                            currentScene = 0;
                            loadChapter(currentChapter).then(() => showScene(currentScene));
                        }
                    };
                    btn.addEventListener('touchstart', handleChoice);
                    btn.addEventListener('click', handleChoice);
                }
                dialogueBox.appendChild(btn);
            });
        }
    } else if (scene.nextScene !== undefined) {
        console.log(`[${Date.now()}] Установка обработчика для перехода к сцене ${scene.nextScene}`);
        const handleNext = (e) => {
            e.preventDefault();
            console.log(`[${Date.now()}] Тап: переход к сцене ${scene.nextScene}`);
            currentScene = scene.nextScene;
            saveSession();
            if (overlay) overlay.remove();
            dialogueBox.style.pointerEvents = 'none';
            showScene(currentScene);
        };
        dialogueBox.touchHandler = handleNext;
        dialogueBox.addEventListener('touchstart', handleNext);
        dialogueBox.addEventListener('click', handleNext);
    } else if (scene.id === scriptData.scenes.length - 1) {
        console.log(`[${Date.now()}] Конец главы, переход к следующей`);
        currentChapter++;
        currentScene = 0;
        if (currentChapter <= 10) {
            loadChapter(currentChapter).then(() => showScene(currentScene));
        } else {
            showStartScreen();
        }
    }
});

    if (shouldFade) {
        fadeOut(() => {
            applyScene();
            fadeIn();
        });
    } else {
        applyScene();
    }

    if (scene.leadsToEnding) {
        console.log(`Загрузка концовки: ${scene.leadsToEnding}`);
        loadFinals(scene.leadsToEnding);
    }
}

        function showSceneWithTimer(scene, timeoutMs = 10000) {
            const progressElement = document.getElementById('progress');
            const totalScenes = scriptData.scenes.length;
            const progressPercent = ((scene.id + 1) / totalScenes) * 100;
            progressElement.style.width = `${progressPercent}%`;

            const backgroundElement = document.getElementById('background');
            const charLeft = document.getElementById('character-left');
            const charRight = document.getElementById('character-right');
            const dialogueElement = document.getElementById('dialogue-text');
            const dialogueBox = document.querySelector('.dialogue-box');

            let displayText = scene.text[stats.language];
            if (stats.completionCount >= 1 && scene.second_playthrough_text) {
                displayText = scene.second_playthrough_text[stats.language];
            }

            const newBackground = scene.background || 'none';
            const shouldFade = currentBackground !== newBackground || scene.id === scriptData.scenes.length - 1;

            const applyScene = async () => {
                const bgUrl = newBackground === 'none' ? 'none' : `/heart_at_crossroads/assets/backgrounds/${newBackground}.png`;
                if (bgUrl !== 'none' && !(await checkAssetExists(bgUrl))) {
                    console.warn(`Фон ${newBackground}.png не найден`);
                    showErrorMessage(stats.language === "ru" ? `Фон ${newBackground} не найден` : `Background ${newBackground} not found`);
                }
                backgroundElement.style.backgroundImage = bgUrl === 'none' ? 'none' : `url('${bgUrl}')`;
                currentBackground = newBackground;

                charLeft.style.backgroundImage = 'none';
                charRight.style.backgroundImage = 'none';
                charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
                charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

                const speakerName = scene.speaker ? scene.speaker[stats.language] : '';
                if (scene.characterLeft) {
                    const leftChar = scene.characterLeft.includes('${stats.appearance}') 
                        ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
                        : scene.characterLeft;
                    const leftCharUrl = `/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png`;
                    if (!(await checkAssetExists(leftCharUrl))) {
                        console.warn(`Персонаж ${leftChar}.png не найден`);
                        showErrorMessage(stats.language === "ru" ? `Персонаж ${leftChar} не найден` : `Character ${leftChar} not found`);
                    }
                    charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
                    charLeft.classList.add(speakerName === "Анна" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
                }
                if (scene.characterRight) {
                    const rightChar = scene.characterRight.includes('${stats.appearance}') 
                        ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
                        : scene.characterRight;
                    const rightCharUrl = `/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png`;
                    if (!(await checkAssetExists(rightCharUrl))) {
                        console.warn(`Персонаж ${rightChar}.png не найден`);
                        showErrorMessage(stats.language === "ru" ? `Персонаж ${rightChar} не найден` : `Character ${rightChar} not found`);
                    }
                    charRight.style.backgroundImage = `url('${rightCharUrl}')`;
                    charRight.classList.add(speakerName === "Вика" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
                }

                if (scene.characterLeftOffset) charLeft.style.left = scene.characterLeftOffset;
                if (scene.characterRightOffset) charRight.style.right = scene.characterRightOffset;

                document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
                if (dialogueBox.touchHandler) {
                    dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler);
                    dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
                    dialogueBox.touchHandler = null;
                }

                let overlay = null;
                const textLower = displayText.toLowerCase();
                if (textLower.includes('телефон') || textLower.includes('phone') || textLower.includes('telegram') || 
                    textLower.includes('whatsapp') || textLower.includes('вконтакте') || textLower.includes('vkontakte')) {
                    overlay = createDefaultOverlay(scene.id);
                }

                document.getElementById('speaker-name').textContent = speakerName;

                if (scene.sound) playSound(scene.sound);
                if (scene.music) playMusic(scene.music);

                typeText(displayText, dialogueElement, () => {
                    dialogueBox.style.pointerEvents = 'auto';
                    scene.choices.forEach(choice => {
                        const btn = createChoiceButton(choice);
                        if (choice.condition && !checkCondition(choice.condition)) {
                            btn.style.display = 'none';
                        } else if (choice.cost && stats.diamonds < choice.cost) {
                            btn.disabled = true;
                        } else {
                            const handleChoice = (e) => {
                                e.preventDefault();
                                if (choice.cost) stats.diamonds -= choice.cost;
                                updateDiamondsDisplay();
                                saveChoice(choice.id, choice.effects, choice.memoryTag);
                                if (choice.effects) showChoiceEffects(choice.effects);
                                clearInterval(countdownInterval);
                                clearTimeout(timer);
                                if (overlay) overlay.remove();
                                document.getElementById('timer-countdown')?.remove();
                                if (tickSound) tickSound.pause();
                                if (choice.nextScene !== undefined) {
                                    currentScene = choice.nextScene;
                                    saveSession();
                                    showScene(currentScene);
                                } else if (choice.nextChapter) {
                                    currentChapter = choice.nextChapter;
                                    currentScene = 0;
                                    loadChapter(currentChapter).then(() => showScene(currentScene));
                                }
                            };
                            btn.addEventListener('touchstart', handleChoice);
                            btn.addEventListener('click', handleChoice);
                        }
                        dialogueBox.appendChild(btn);
                    });

                    const timerDuration = scene.choices.find(c => c.timer)?.timer * 1000 || 10000;
                    let timeLeft = timerDuration / 1000;

                    const countdownElement = document.createElement('div');
                    countdownElement.id = 'timer-countdown';
                    countdownElement.textContent = timeLeft;
                    document.getElementById('game-container').appendChild(countdownElement);

                    const tickSound = new Audio('/heart_at_crossroads/assets/sounds/sfx_tick.mp3');
                    tickSound.loop = false;
                    tickSound.play().catch(err => {
                        console.warn('Ошибка воспроизведения sfx_tick:', err);
                        showErrorMessage(stats.language === "ru" ? 'Звук sfx_tick.mp3 не найден' : 'Sound sfx_tick.mp3 not found');
                    });

                    const countdownInterval = setInterval(() => {
                        timeLeft--;
                        countdownElement.textContent = timeLeft;
                        if (overlay) {
                            overlay.classList.add('flash-svg');
                            setTimeout(() => overlay.classList.remove('flash-svg'), 500);
                        }
                        if ('vibrate' in navigator) navigator.vibrate(200);
                        if (timeLeft <= 0) {
                            clearInterval(countdownInterval);
                            tickSound.pause();
                        }
                    }, 1000);

                    const timer = setTimeout(() => {
                        const defaultChoice = scene.choices.find(c => c.id === 'ignore');
                        clearInterval(countdownInterval);
                        if (overlay) overlay.remove();
                        document.getElementById('timer-countdown')?.remove();
                        tickSound.pause();
                        if (defaultChoice && defaultChoice.nextScene !== undefined) {
                            currentScene = defaultChoice.nextScene;
                            saveSession();
                            showScene(currentScene);
                        } else if (scene.id === scriptData.scenes.length - 1) {
                            currentChapter++;
                            currentScene = 0;
                            if (currentChapter <= 10) {
                                loadChapter(currentChapter).then(() => showScene(currentScene));
                            } else {
                                showStartScreen();
                            }
                        } else {
                            console.warn('Нет сцены по умолчанию для таймера!');
                        }
                    }, timerDuration);
                });
            };

            if (shouldFade) {
                fadeOut(() => {
                    applyScene();
                    fadeIn();
                });
            } else {
                applyScene();
            }

            if (scene.leadsToEnding) {
                loadFinals(scene.leadsToEnding);
            }
        } // Добавлена закрывающая скобка для showSceneWithTimer

        function showGallery() {
            const galleryDiv = document.createElement('div');
            galleryDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10; overflow-y: auto;';
            stats.memories.forEach(memory => {
                const img = document.createElement('img');
                img.src = `/heart_at_crossroads/assets/memories/${memory}.png`;
                img.style.cssText = 'display: block; margin: 20px auto; max-width: 80%;';
                img.onerror = () => {
                    console.warn(`Воспоминание ${memory}.png не найдено`);
                    showErrorMessage(stats.language === "ru" ? `Воспоминание ${memory} не найдено` : `Memory ${memory} not found`);
                };
                galleryDiv.appendChild(img);
            });
            const closeBtn = document.createElement('button');
            closeBtn.textContent = stats.language === "ru" ? "Закрыть" : "Close";
            closeBtn.style.cssText = 'position: fixed; top: 10px; right: 10px;';
            closeBtn.onclick = () => galleryDiv.remove();
            galleryDiv.appendChild(closeBtn);
            document.body.appendChild(galleryDiv);
        }

        async function loadFinals(endingId) {
            const response = await fetch('/heart_at_crossroads/assets/data/finals.json');
            const finalsData = await response.json();
            const ending = finalsData.endings.find(e => e.id === endingId);
            if (ending && checkRequirements(ending.requirements)) {
                showEnding(ending);
            } else {
                console.warn('Концовка не найдена или требования не выполнены');
                showStartScreen();
            }
        }

        function checkRequirements(requirements) {
            if (!requirements) return true;
            for (let key in requirements) {
                const value = stats[key] || stats.relationships[key.split('.')[1]] || 0;
                const req = requirements[key];
                if (req.startsWith('>')) {
                    const compareValue = req.includes('+') ? 
                        (stats[req.split('+')[0].slice(1)] + stats[req.split('+')[1]]) : 
                        parseInt(req.slice(1));
                    return value > compareValue;
                }
                return value >= parseInt(req);
            }
            return true;
        }

        function showEnding(ending) {
            const scene = ending.scenes[0];
            const backgroundElement = document.getElementById('background');
            const charLeft = document.getElementById('character-left');
            const charRight = document.getElementById('character-right');
            const dialogueElement = document.getElementById('dialogue-text');
            const speakerName = document.getElementById('speaker-name');

            const bgUrl = `/heart_at_crossroads/assets/backgrounds/${scene.background}.png`;
            checkAssetExists(bgUrl).then(exists => {
                if (!exists) {
                    console.warn(`Фон ${scene.background}.png не найден`);
                    showErrorMessage(stats.language === "ru" ? `Фон ${scene.background} не найден` : `Background ${scene.background} not found`);
                }
                backgroundElement.style.backgroundImage = `url('${bgUrl}')`;
            });

            if (scene.characterLeft) {
                const leftCharUrl = `/heart_at_crossroads/assets/characters/${scene.characterLeft.split('_')[0]}/${scene.characterLeft}.png`;
                checkAssetExists(leftCharUrl).then(exists => {
                    if (!exists) {
                        console.warn(`Персонаж ${scene.characterLeft}.png не найден`);
                        showErrorMessage(stats.language === "ru" ? `Персонаж ${scene.characterLeft} не найден` : `Character ${scene.characterLeft} not found`);
                    }
                    charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
                });
            } else charLeft.style.backgroundImage = 'none';

            if (scene.characterRight) {
                const rightCharUrl = `/heart_at_crossroads/assets/characters/${scene.characterRight.split('_')[0]}/${scene.characterRight}.png`;
                checkAssetExists(rightCharUrl).then(exists => {
                    if (!exists) {
                        console.warn(`Персонаж ${scene.characterRight}.png не найден`);
                        showErrorMessage(stats.language === "ru" ? `Персонаж ${scene.characterRight} не найден` : `Character ${scene.characterRight} not found`);
                    }
                    charRight.style.backgroundImage = `url('${rightCharUrl}')`;
                });
            } else charRight.style.backgroundImage = 'none';

            speakerName.textContent = scene.speaker[stats.language];
            typeText(stats.completionCount >= 1 && scene.second_playthrough_text ? 
                scene.second_playthrough_text[stats.language] : scene.text[stats.language], 
                dialogueElement, () => {
                    showEpilogue(ending.epilogue[stats.language]);
                });

            if (scene.sound) playSound(scene.sound);
            if (scene.music) playMusic(scene.music);
        }

        function showEpilogue(epilogueText) {
            const epilogueDiv = document.createElement('div');
            epilogueDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 10;';
            epilogueDiv.textContent = epilogueText;
            document.body.appendChild(epilogueDiv);
            setTimeout(() => {
                epilogueDiv.remove();
                stats.completionCount++;
                saveSession();
                showStartScreen();
            }, 5000);
        }



     
function checkCondition(condition) {
    if (!condition) return true;
    const [key, operator, value] = condition.split(' ');
    const statValue = stats[key] || stats.relationships[key] || 0;
    const compareValue = parseInt(value);
    switch (operator) {
        case '>': return statValue > compareValue;
        case '<': return statValue < compareValue;
        case '>=': return statValue >= compareValue;
        case '<=': return statValue <= compareValue;
        case '==': return statValue == compareValue;
        case '!=': return statValue != compareValue;
        default: return false;
    }
}

function typeText(text, element, callback) {
    if (isTyping) {
        console.log(`[${Date.now()}] typeText уже идёт, пропускаем`);
        return;
    }
    const callId = Date.now();
    console.log(`[${callId}] Начинаем печатать текст: "${text}"`);
    isTyping = true;
    console.log(`[${callId}] isTyping установлен в true`);
    element.textContent = '';
    if (element.typeTimer) {
        console.log(`[${callId}] Очищаем старый таймер`);
        clearTimeout(element.typeTimer);
    }
    const parts = text.split('||').map(part => part.trim()).filter(part => part.length > 0);
    console.log(`[${callId}] Частей текста: ${parts.length}`);
    let partIndex = 0;
    let i = 0;
    const speed = 50;
    const dialogueBox = document.querySelector('.dialogue-box');

    function clearHandlers() {
        if (dialogueBox.tapHandler) {
            dialogueBox.removeEventListener('touchstart', dialogueBox.tapHandler);
            dialogueBox.removeEventListener('click', dialogueBox.tapHandler);
            console.log(`[${callId}] Очистка обработчиков тапов`);
            dialogueBox.tapHandler = null;
        }
    }
    clearHandlers();

    function type() {
        if (partIndex >= parts.length) {
            console.error(`[${callId}] Ошибка индекса: ${partIndex}, частей: ${parts.length}`);
            isTyping = false;
            console.log(`[${callId}] isTyping сброшен в false (все части готовы)`);
            clearHandlers();
            console.log(`[${callId}] Все части напечатаны, вызываем callback`);
            if (callback) callback();
            return;
        }
        if (i < parts[partIndex].length) {
            element.textContent += parts[partIndex].charAt(i);
            i++;
            console.log(`[${callId}] Печатаем символ ${i} части ${partIndex + 1}: "${parts[partIndex]}"`);
            element.typeTimer = setTimeout(type, speed);
        } else {
            isTyping = false;
            console.log(`[${callId}] isTyping сброшен в false (часть ${partIndex + 1} готова)`);
            console.log(`[${callId}] Завершена часть ${partIndex + 1} из ${parts.length}`);
            if (partIndex === parts.length - 1) {
                console.log(`[${callId}] Последняя часть завершена, вызываем callback`);
                clearHandlers();
                if (callback) {
                    console.log(`[${callId}] Запускаем callback`);
                    callback();
                } else {
                    console.log(`[${callId}] Callback не передан`);
                }
            }
        }
    }

    function handleTap(e) {
        e.preventDefault();
        console.log(`[${callId}] Тап, isTyping: ${isTyping}`);
        if (isTyping) {
            console.log(`[${callId}] Пропускаем анимацию части ${partIndex + 1}`);
            clearTimeout(element.typeTimer);
            element.textContent = parts[partIndex];
            i = parts[partIndex].length;
            isTyping = false;
            console.log(`[${callId}] isTyping сброшен в false (анимация пропущена)`);
            if (partIndex === parts.length - 1) {
                console.log(`[${callId}] Пропущена последняя часть, вызываем callback`);
                clearHandlers();
                if (callback) {
                    console.log(`[${callId}] Запускаем callback после пропуска`);
                    callback();
                } else {
                    console.log(`[${callId}] Callback не передан после пропуска`);
                }
            }
        } else if (partIndex < parts.length - 1) {
            console.log(`[${callId}] Переход к части ${partIndex + 2}`);
            partIndex++;
            i = 0;
            element.textContent = '';
            isTyping = true;
            console.log(`[${callId}] isTyping установлен в true (следующая часть)`);
            type();
        } else {
            console.log(`[${callId}] Все части показаны, вызываем callback`);
            isTyping = false;
            console.log(`[${callId}] isTyping сброшен в false (финальный тап)`);
            clearHandlers();
            if (callback) {
                console.log(`[${callId}] Запускаем callback после финального тапа`);
                callback();
            } else {
                console.log(`[${callId}] Callback не передан после финального тапа`);
            }
        }
    }

    dialogueBox.tapHandler = handleTap;
    dialogueBox.addEventListener('touchstart', handleTap);
    dialogueBox.addEventListener('click', handleTap);
    console.log(`[${callId}] Обработчик тапов установлен`);

    type();
}

  
function fadeOut(callback) {
    const elements = [
        document.getElementById('background'),
        document.getElementById('character-left'),
        document.getElementById('character-right'),
        document.querySelector('.dialogue-box')
    ];
    elements.forEach(el => el.classList.add('fade-out'));
    setTimeout(() => {
        elements.forEach(el => el.classList.remove('fade-out'));
        if (callback) callback();
    }, 1000);
}

function fadeIn() {
    const elements = [
        document.getElementById('background'),
        document.getElementById('character-left'),
        document.getElementById('character-right'),
        document.querySelector('.dialogue-box')
    ];
    elements.forEach(el => {
        el.style.opacity = '0';
        el.style.transition = 'opacity 1s ease';
        setTimeout(() => el.style.opacity = '1', 10);
    });
}

function showChoiceEffects(effects) {
    const feedback = document.createElement('img');
    feedback.className = 'choice-feedback';
    if (effects.crown) feedback.src = '/heart_at_crossroads/assets/ui/crown.png';
    else if (effects.heart) feedback.src = '/heart_at_crossroads/assets/ui/heart.png';
    else if (effects.leaf) feedback.src = '/heart_at_crossroads/assets/ui/leaf.png';
    else return;
    document.getElementById('game-container').appendChild(feedback);
    setTimeout(() => feedback.remove(), 3000);
}

// Закрытие тега <script>
    </script>
</body>
</html>
