<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сердце на перекрёстке</title>
    <style>
        @font-face {
            font-family: 'LobsterTwo';
            src: url('/heart_at_crossroads/assets/fonts/LobsterTwo-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'GreatVibes';
            src: url('/heart_at_crossroads/assets/fonts/GreatVibes-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoodVibesCyr';
            src: url('/heart_at_crossroads/assets/fonts/GoodVibesCyr.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        .parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: 0% center;
            background-repeat: no-repeat;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slideBackground 60s linear infinite;
            z-index: 1;
            transition: opacity 1s ease;
        }
        @keyframes slideBackground {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }
        .character-left, .character-right {
            position: absolute;
            bottom: 0;
            width: 70%;
            max-width: 100vw;
            height: 100vh;
            max-height: 100vh;
            background-position: bottom center;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 2;
            transition: opacity 1s ease, transform 0.3s ease, filter 0.3s ease;
            animation: appear 0.5s ease-in-out forwards;
        }
        @keyframes appear {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes shiver {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .shiver {
            animation: shiver 0.5s infinite;
        }
        .heartbeat {
            animation: heartbeat 1s 3;
        }
        .character-left { left: -15%; transform: translateX(0); }
        .character-right { right: -15%; transform: translateX(0); }
        .character-speaker {
            transform: scale(1.1);
            filter: brightness(1.2);
            z-index: 3;
        }
        .character-non-speaker {
            transform: scale(1);
            filter: brightness(1);
            z-index: 2;
        }
        .dialogue-box {
            position: absolute;
            bottom: 20%;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(93, 64, 55, 0.8), rgba(93, 64, 55, 0.4));
            color: #F5F0E1;
            padding: 40px 20px 20px;
            text-align: center;
            z-index: 3;
            transition: opacity 1s ease, bottom 0.3s ease;
            opacity: 1;
            min-height: 150px;
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        #speaker-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            color: #E6D5C0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #dialogue-text {
            margin: 0;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .choice-btn {
            display: block;
            margin: 10px auto;
            padding: 10px;
            width: 90%;
            background: linear-gradient(to bottom, #F5F0E1, #E6D5C0);
            color: #5D4037;
            border: 1px solid rgba(93, 64, 55, 0.2);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            white-space: normal;
            min-height: 44px;
            height: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 5px rgba(93, 64, 55, 0.3);
        }
        .choice-btn:disabled {
            background: linear-gradient(to bottom, #666, #555);
            opacity: 0.7;
            box-shadow: none;
        }
        .choice-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #E6D5C0, #D4BEA6);
            box-shadow: 0 3px 7px rgba(93, 64, 55, 0.4);
        }
        #menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 4;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            max-width: calc(100% - 20px);
            overflow-x: auto;
            white-space: nowrap;
        }
        #menu div {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        #menu img {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }
        #menu span {
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #menu-btn, #stats {
            margin: 0 5px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.8), rgba(160, 120, 90, 0.8));
            color: #5D4037;
            border: none;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #menu-btn:hover, #stats:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.9), rgba(160, 120, 90, 0.9));
        }
        .choice-feedback {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            z-index: 4;
            animation: flyUp 3s ease-out forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh); opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            width: 5px;
            height: 5px;
            opacity: 0.7;
        }
        @keyframes flyUp {
            0% { bottom: 50%; opacity: 1; }
            50% { bottom: 60%; opacity: 0.8; }
            100% { bottom: 70%; opacity: 0; }
        }
        .fade-out {
            opacity: 0;
            transition: opacity 1s ease;
        }
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('/heart_at_crossroads/assets/backgrounds/start_screen.png') center/cover no-repeat #FFF5E6;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 5;
        }
        #start-screen h1 {
            color: #A67C52;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        #start-screen h1.ru {
            font-family: 'GoodVibesCyr', sans-serif;
        }
        #start-screen h1.en {
            font-family: 'GreatVibes', sans-serif;
        }
        #start-screen h1 span:first-child {
            font-size: 48px;
        }
        #start-screen h1 span:last-child {
            font-size: 40px;
        }
        .start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            position: relative;
        }
        .start-buttons button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .start-buttons button:nth-child(1) {
            left: -30px;
        }
        .start-buttons button:nth-child(2) {
            left: 30px;
        }
        .start-buttons button:nth-child(3) {
            left: -30px;
        }
        #gallery-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: absolute;
            left: -130px;
            top: 50%;
            transform: translateY(-50%);
        }
        .start-buttons button:hover, #gallery-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background: rgba(245, 240, 225, 0.9);
        }
        #password-form {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #password-input {
            padding: 12px;
            font-size: 16px;
            border-radius: 20px;
            border: 1px solid rgba(93, 64, 55, 0.3);
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            width: 220px;
            text-align: center;
        }
        #password-submit {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #back-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(200, 180, 160, 0.6);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .placeholder-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            z-index: 10;
        }
        #progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #333;
            z-index: 4;
            display: none;
        }
        #progress {
            width: 0%;
            height: 100%;
            background: #DEB887;
            transition: width 0.5s ease;
        }
        #language-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid #fff;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            z-index: 6;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .memory-notification {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.7), rgba(160, 120, 90, 0.7));
            color: #5D4037;
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        #debug-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(255, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1 id="title" data-ru="Сердце<br>на перекрёстке" data-en="Heart<br>at the Crossroads">
            <span>Сердце</span>
            <span>на перекрёстке</span>
        </h1>
        <div class="start-buttons">
            <button id="start-game" data-ru="Начать игру" data-en="Start Game">Начать игру</button>
            <button id="continue-game" data-ru="Продолжить" data-en="Continue">Продолжить</button>
            <button id="show-password" data-ru="Ввести пароль" data-en="Enter Password">Ввести пароль</button>
            <button id="gallery-btn" data-ru="Галерея" data-en="Gallery">Галерея</button>
        </div>
        <div id="password-form">
            <input type="text" id="password-input" placeholder="Введите пароль">
            <button id="password-submit" data-ru="Войти" data-en="Login">Войти</button>
        </div>
        <button id="language-btn">
            <span id="language-icon">🇷🇺</span>
        </button>
    </div>
    <div id="game-container">
        <div class="parallax-bg" id="background" style="display: none;"></div>
        <div class="character-left" id="character-left" style="display: none;"></div>
        <div class="character-right" id="character-right" style="display: none;"></div>
        <div class="dialogue-box" id="dialogue-box" style="display: none;">
            <p id="speaker-name"></p>
            <p id="dialogue-text"></p>
        </div>
        <div id="progress-bar" style="display: none;">
            <div id="progress"></div>
        </div>
        <div id="menu" style="display: none;">
            <div id="diamonds">
                <img src="/heart_at_crossroads/assets/ui/diamonds.png" alt="Бриллианты">
                <span id="diamonds-count">10</span>
            </div>
            <button id="menu-btn" data-ru="Меню" data-en="Menu">Меню</button>
            <button id="stats">Статы</button>
        </div>
        <div id="particles" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3;"></div>
    </div>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
   <script>
    // Проверка Telegram
    const isTelegram = !!(window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe);
    if (isTelegram) {
        try {
            Telegram.WebApp.ready();
            console.log('Telegram Web App инициализирован');
        } catch (error) {
            console.error('Ошибка инициализации Telegram:', error);
            alert('Ошибка Telegram Web App. Функции могут быть ограничены.');
        }
    } else {
        console.log('Запуск в браузере');
    }

    const userId = isTelegram ? Telegram.WebApp.initDataUnsafe.user?.id : null;
    let currentChapter = 1;
    let currentScene = 0;
    let choices = [];
    let stats = {
        crown: 0,
        heart: 0,
        leaf: 0,
        diamonds: 10,
        relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
        appearance: "style1",
        isAuthorized: false,
        memories: [],
        language: "ru",
        hasReturnedViaMenu: false,
        completionCount: 0
    };
    let isTyping = false;
    let scriptData = null;
    let currentBackground = null;
    const correctPassword = "umbertoeco";
    const tempPassword = "999000";

    // Функции хранения с проверкой CloudStorage
    const saveToStorage = async (key, value) => {
        const data = JSON.stringify(value);
        try {
            if (isTelegram && Telegram.WebApp.CloudStorage && typeof Telegram.WebApp.CloudStorage.setItem === 'function') {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.setItem(key, data, (error, success) => {
                        if (error) {
                            console.error(`Ошибка CloudStorage.setItem: ${error}`);
                            reject(error);
                        } else {
                            console.log(`Сохранено в CloudStorage: ${key}`);
                            resolve(true);
                        }
                    });
                });
            } else {
                console.log(`Сохранение в localStorage: ${key}`);
                localStorage.setItem(key, data);
                return true;
            }
        } catch (error) {
            console.error(`Ошибка сохранения: ${error}`);
            localStorage.setItem(key, data); // Запасной вариант
            return true;
        }
    };

    const getFromStorage = async (key) => {
        try {
            if (isTelegram && Telegram.WebApp.CloudStorage && typeof Telegram.WebApp.CloudStorage.getItem === 'function') {
                return new Promise((resolve, reject) => {
                    Telegram.WebApp.CloudStorage.getItem(key, (error, result) => {
                        if (error) {
                            console.error(`Ошибка CloudStorage.getItem: ${error}`);
                            reject(error);
                        } else {
                            console.log(`Получено из CloudStorage: ${key} = ${result}`);
                            resolve(result ? JSON.parse(result) : null);
                        }
                    });
                });
            } else {
                const item = localStorage.getItem(key);
                console.log(`Получено из localStorage: ${key} = ${item}`);
                return item ? JSON.parse(item) : null;
            }
        } catch (error) {
            console.error(`Ошибка получения данных: ${error}`);
            const item = localStorage.getItem(key); // Запасной вариант
            return item ? JSON.parse(item) : null;
        }
    };

    // Утилита для событий
    const addEventListeners = (element, events, handler) => {
        events.forEach(event => {
            element.addEventListener(event, handler);
            console.log(`Привязан ${event} к ${element.id}`);
        });
    };

    // Загрузка DOM
    document.addEventListener('DOMContentLoaded', () => {
        const startGameBtn = document.getElementById('start-game');
        const continueGameBtn = document.getElementById('continue-game');
        const showPasswordBtn = document.getElementById('show-password');
        const passwordSubmitBtn = document.getElementById('password-submit');
        const menuBtn = document.getElementById('menu-btn');
        const statsBtn = document.getElementById('stats');
        const galleryBtn = document.getElementById('gallery-btn');
        const languageBtn = document.getElementById('language-btn');
        const languageIcon = document.getElementById('language-icon');

        if (!startGameBtn) console.error('Кнопка start-game не найдена!');
        updateLanguage(stats.language);

        // Обработчики с логированием
        function handleStartGame(e) {
            e.preventDefault();
            console.log('handleStartGame вызван');
            checkTempPassword(() => startNewGame());
        }

        function handleContinueGame(e) {
            e.preventDefault();
            console.log('handleContinueGame вызван');
            checkTempPassword(() => loadSession(() => startGame()));
        }

        function handleShowPassword(e) {
            e.preventDefault();
            console.log('handleShowPassword вызван');
            document.getElementById('password-form').style.display = 'flex';
            document.querySelector('.start-buttons').style.display = 'none';
        }

        async function handlePasswordSubmit(e) {
            e.preventDefault();
            console.log('handlePasswordSubmit вызван');
            const inputPassword = document.getElementById('password-input').value;
            try {
                if (inputPassword === tempPassword || inputPassword === correctPassword) {
                    if (inputPassword === correctPassword) {
                        const authorizedUsers = (await getFromStorage('authorized_users')) || [];
                        if (userId && !authorizedUsers.includes(userId)) {
                            authorizedUsers.push(userId);
                            await saveToStorage('authorized_users', authorizedUsers);
                        }
                        stats.isAuthorized = true;
                    }
                    startNewGame();
                } else {
                    alert(stats.language === "ru" ? 'Неверный пароль!' : 'Incorrect password!');
                }
            } catch (error) {
                console.error('Ошибка обработки пароля:', error);
                alert(stats.language === "ru" ? 'Ошибка авторизации.' : 'Authorization error.');
            }
        }

        function handleMenu(e) {
            e.preventDefault();
            console.log('handleMenu вызван');
            stats.hasReturnedViaMenu = true;
            resetGameState();
            saveSession();
            showStartScreen();
        }

        function handleShowStats(e) {
            e.preventDefault();
            console.log('handleShowStats вызван');
            const statsText = stats.language === "ru" ?
                `Короны: ${stats.crown}\nСердце: ${stats.heart}\nЛист: ${stats.leaf}\nБриллианты: ${stats.diamonds}\nОтношения:\nМарк: ${stats.relationships.mark}\nЛера: ${stats.relationships.lera}\nВика: ${stats.relationships.vika}\nСергей: ${stats.relationships.sergey}\nАнна: ${stats.relationships.anna}\nДима: ${stats.relationships.dima}\nЛёша: ${stats.relationships.lesha}` :
                `Crowns: ${stats.crown}\nHeart: ${stats.heart}\nLeaf: ${stats.leaf}\nDiamonds: ${stats.diamonds}\nRelationships:\nMark: ${stats.relationships.mark}\nLera: ${stats.relationships.lera}\nVika: ${stats.relationships.vika}\nSergey: ${stats.relationships.sergey}\nAnna: ${stats.relationships.anna}\nDima: ${stats.relationships.dima}\nLesha: ${stats.relationships.lesha}`;
            alert(statsText);
        }

        function handleLanguageSwitch(e) {
            e.preventDefault();
            console.log('handleLanguageSwitch вызван');
            stats.language = stats.language === "ru" ? "en" : "ru";
            languageIcon.textContent = stats.language === "ru" ? "🇷🇺" : "🇬🇧";
            updateLanguage(stats.language);
            saveSession();
        }

        // Привязка событий
        addEventListeners(startGameBtn, ['click', 'touchstart'], handleStartGame);
        addEventListeners(continueGameBtn, ['click', 'touchstart'], handleContinueGame);
        addEventListeners(showPasswordBtn, ['click', 'touchstart'], handleShowPassword);
        addEventListeners(passwordSubmitBtn, ['click', 'touchstart'], handlePasswordSubmit);
        addEventListeners(menuBtn, ['click', 'touchstart'], handleMenu);
        addEventListeners(statsBtn, ['click', 'touchstart'], handleShowStats);
        addEventListeners(galleryBtn, ['click', 'touchstart'], (e) => e.preventDefault());
        addEventListeners(languageBtn, ['click', 'touchstart'], handleLanguageSwitch);

        // Кнопка "Назад"
        const backButton = document.createElement('button');
        backButton.id = 'back-button';
        backButton.textContent = stats.language === "ru" ? "Назад" : "Back";
        addEventListeners(backButton, ['click', 'touchstart'], (e) => {
            e.preventDefault();
            console.log('backButton вызван');
            document.getElementById('password-form').style.display = 'none';
            document.querySelector('.start-buttons').style.display = 'flex';
        });
        document.getElementById('password-form').appendChild(backButton);

        // Инициализация
        getFromStorage('last_session')
            .then(session => {
                console.log('Сессия загружена:', session);
                if (session) showStartScreen();
                else checkAuthorization();
            })
            .catch(error => {
                console.error('Ошибка загрузки сессии:', error);
                showStartScreen(); // Продолжаем с начальным экраном даже при ошибке
            });
    });

    // Вспомогательные функции
    function showStartScreen() {
        console.log('showStartScreen вызван');
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('language-btn').style.display = 'block';
        document.getElementById('game-container').style.display = 'none';
    }

    function resetGameState() {
        console.log('resetGameState вызван');
        currentChapter = 1;
        currentScene = 0;
        choices = [];
        stats = {
            crown: 0,
            heart: 0,
            leaf: 0,
            diamonds: 10,
            relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
            appearance: "style1",
            isAuthorized: stats.isAuthorized,
            memories: [],
            language: stats.language,
            hasReturnedViaMenu: true,
            completionCount: stats.completionCount
        };
        currentBackground = null;
    }

    function updateLanguage(lang) {
        console.log('updateLanguage вызван с языком:', lang);
        document.getElementById('start-game').textContent = document.getElementById('start-game').getAttribute(`data-${lang}`);
        document.getElementById('continue-game').textContent = document.getElementById('continue-game').getAttribute(`data-${lang}`);
        document.getElementById('show-password').textContent = document.getElementById('show-password').getAttribute(`data-${lang}`);
        document.getElementById('password-submit').textContent = document.getElementById('password-submit').getAttribute(`data-${lang}`);
        document.getElementById('menu-btn').textContent = document.getElementById('menu-btn').getAttribute(`data-${lang}`);
        document.getElementById('gallery-btn').textContent = document.getElementById('gallery-btn').getAttribute(`data-${lang}`);
        const title = document.getElementById('title');
        title.innerHTML = lang === "ru" ? '<span>Сердце</span><span>на перекрёстке</span>' : '<span>Heart</span><span>at the Crossroads</span>';
        title.className = lang === "ru" ? "ru" : "en";
    }

    async function checkAuthorization() {
        try {
            const authorizedUsers = (await getFromStorage('authorized_users')) || [];
            if (userId && authorizedUsers.includes(userId)) {
                stats.isAuthorized = true;
                startGame();
            } else {
                showStartScreen();
            }
        } catch (error) {
            console.error('Ошибка авторизации:', error);
            showStartScreen();
        }
    }

    async function checkTempPassword(callback) {
        try {
            const granted = await getFromStorage('tempAccessGranted');
            if (granted) {
                console.log('Временный доступ уже предоставлен');
                callback();
            } else {
                const input = prompt(stats.language === "ru" ? 'Игра закрыта на доработку. Введите пароль:' : 'Game is under refinement. Enter password:');
                if (input === tempPassword || input === correctPassword) {
                    await saveToStorage('tempAccessGranted', true);
                    if (input === correctPassword) stats.isAuthorized = true;
                    console.log('Пароль верный, доступ предоставлен');
                    callback();
                } else {
                    alert(stats.language === "ru" ? 'Неверный пароль!' : 'Incorrect password!');
                }
            }
        } catch (error) {
            console.error('Ошибка проверки пароля:', error);
            alert(stats.language === "ru" ? 'Ошибка доступа.' : 'Access error.');
        }
    }

    function startNewGame() {
        console.log('startNewGame вызван');
        resetGameState();
        saveSession();
        startGame();
    }

    async function loadSession(callback) {
        try {
            const session = await getFromStorage('last_session');
            if (session) {
                currentChapter = session.currentChapter;
                currentScene = session.currentScene;
                choices = session.choices;
                stats = { ...stats, ...session.stats };
                console.log('Сессия загружена:', session);
            }
            if (callback) callback();
        } catch (error) {
            console.error('Ошибка загрузки сессии:', error);
        }
    }

    async function saveSession() {
        const session = { currentChapter, currentScene, choices, stats };
        try {
            await saveToStorage('last_session', session);
            updateDiamondsDisplay();
            console.log('Сессия сохранена');
        } catch (error) {
            console.error('Ошибка сохранения сессии:', error);
        }
    }

    async function startGame() {
        try {
            console.log('startGame вызван');
            showDebugMessage('Инициализация игры...');
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('language-btn').style.display = 'none';

            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'loading-overlay';
            loadingOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:10;display:flex;justify-content:center;align-items:center;color:#fff;';
            loadingOverlay.innerHTML = '<span>Загрузка...</span>';
            document.body.appendChild(loadingOverlay);

            await preloadAssets(currentChapter);
            await loadChapter(currentChapter);

            document.getElementById('background').style.display = 'block';
            document.getElementById('character-left').style.display = 'block';
            document.getElementById('character-right').style.display = 'block';
            document.getElementById('dialogue-box').style.display = 'block';
            document.getElementById('menu').style.display = 'flex';
            document.getElementById('progress-bar').style.display = 'block';

            document.getElementById('stats').style.display = stats.isAuthorized ? 'block' : 'none';
            updateDiamondsDisplay();

            loadingOverlay.remove();
            showScene(currentScene);
        } catch (error) {
            console.error('Ошибка в startGame:', error);
            showDebugMessage(`Ошибка: ${error.message}`);
            alert(stats.language === "ru" ? 'Ошибка запуска игры.' : 'Game start error.');
            document.getElementById('loading-overlay')?.remove();
            showStartScreen();
        }
    }

    function updateDiamondsDisplay() {
        document.getElementById('diamonds-count').textContent = stats.diamonds;
    }

    function showDebugMessage(message) {
        let debugDiv = document.getElementById('debug-message');
        if (!debugDiv) {
            debugDiv = document.createElement('div');
            debugDiv.id = 'debug-message';
            document.body.appendChild(debugDiv);
        }
        debugDiv.textContent = message;
        setTimeout(() => debugDiv.remove(), 5000);
    }

    function preloadAssets(chapterId) {
        console.log('Начало preloadAssets для chapter:', chapterId);
        const loadingStatus = document.createElement('div');
        loadingStatus.id = 'loading-status';
        loadingStatus.style.cssText = 'position:fixed;bottom:10px;left:10px;color:white;font-size:12px;z-index:11;';
        document.body.appendChild(loadingStatus);
        
        const images = [
            '/heart_at_crossroads/assets/backgrounds/start_screen.png',
            '/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png',
            '/heart_at_crossroads/assets/backgrounds/bg_coffee_shop.png',
            '/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png',
            '/heart_at_crossroads/assets/backgrounds/bg_street_day_trash.png',
            '/heart_at_crossroads/assets/backgrounds/bg_street_dusk_end.png',
            '/heart_at_crossroads/assets/backgrounds/bg_street_night.png',
            '/heart_at_crossroads/assets/backgrounds/bg_webstudio_day.png',
            '/heart_at_crossroads/assets/backgrounds/bg_webstudio_night.png',
            '/heart_at_crossroads/assets/characters/anna/anna_sad_style2.png',
            '/heart_at_crossroads/assets/characters/anna/anna_neutral_style2.png',
            '/heart_at_crossroads/assets/characters/anna/anna_happy_style2.png',
            '/heart_at_crossroads/assets/characters/vika/vika_smile_style1.png',
            '/heart_at_crossroads/assets/characters/vika/vika_neutral_style1.png',
            '/heart_at_crossroads/assets/characters/vika/vika_happy_style1.png',
            '/heart_at_crossroads/assets/characters/vika/vika_confident_style1.png',
            '/heart_at_crossroads/assets/characters/dima/dima_happy_style1.png',
            '/heart_at_crossroads/assets/characters/mark/mark_neutral_style1.png',
            '/heart_at_crossroads/assets/characters/sergey/sergey_smile_style1.png',
            '/heart_at_crossroads/assets/ui/diamonds.png',
            '/heart_at_crossroads/assets/ui/crown.png',
            '/heart_at_crossroads/assets/ui/heart.png',
            '/heart_at_crossroads/assets/ui/leaf.png'
        ];
        let loaded = 0;
        
        return Promise.all(images.map(src => {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = src;
                img.onload = () => {
                    loaded++;
                    loadingStatus.textContent = `Загрузка: ${loaded}/${images.length}`;
                    console.log(`Загружено: ${src}`);
                    resolve();
                };
                img.onerror = () => {
                    console.warn(`Не удалось загрузить ${src}`);
                    loaded++;
                    loadingStatus.textContent = `Загрузка: ${loaded}/${images.length}`;
                    resolve();
                };
            });
        })).finally(() => {
            loadingStatus.remove();
        });
    }

    async function loadChapter(chapterId) {
        console.log(`Загрузка главы ${chapterId}`);
        const jsonPath = `/heart_at_crossroads/assets/data/chapter${chapterId}.json`;
        try {
            const response = await fetch(jsonPath, {
                headers: {
                    'Content-Type': 'application/json; charset=UTF-8',
                    'Accept': 'application/json'
                }
            });
            if (!response.ok) throw new Error(`Не удалось загрузить главу ${chapterId}: ${response.statusText}`);
            const text = await response.text();
            const data = JSON.parse(text);
            if (!data || !data.scenes || !Array.isArray(data.scenes)) {
                throw new Error('Некорректный формат JSON');
            }
            scriptData = data;
            console.log(`Данные главы ${chapterId} успешно загружены`);
        } catch (error) {
            console.error('Ошибка загрузки главы:', error);
            throw error;
        }
    }

    function createChoiceButton(choice) {
        const btn = document.createElement('button');
        const hasCostInText = choice.text[stats.language].includes(`${choice.cost}`);
        btn.textContent = choice.cost && !hasCostInText 
            ? `${choice.text[stats.language]} (${choice.cost} бриллиантов)` 
            : choice.text[stats.language];
        btn.className = 'choice-btn';
        if (choice.text[stats.language].length > 30) btn.style.fontSize = '12px';
        if (choice.text[stats.language].length > 60) btn.style.minHeight = '64px';
        return btn;
    }

    function saveChoice(choiceId, effects, memoryTag) {
        choices.push(choiceId);
        if (effects) {
            for (let key in effects) {
                if (key === 'relationships') {
                    for (let rel in effects[key]) {
                        stats.relationships[rel] = (stats.relationships[rel] || 0) + effects[key][rel];
                    }
                } else {
                    stats[key] = (stats[key] || 0) + effects[key];
                }
            }
        }
        if (memoryTag) {
            stats.memories.push(memoryTag);
            const notification = document.createElement('div');
            notification.className = 'memory-notification';
            notification.textContent = stats.language === "ru" ? "Вика запомнит ваш выбор" : "Vika will remember your choice";
            document.getElementById('game-container').appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        saveSession();
    }

    function showScene(sceneId) {
        if (!scriptData || !scriptData.scenes) {
            console.error('Данные сценария не загружены');
            showDebugMessage("Ошибка: данные сценария не загружены.");
            return;
        }

        let scene = typeof sceneId === 'number' ? scriptData.scenes[sceneId] : scriptData.scenes.find(s => s.id === sceneId);
        if (!scene) {
            if (currentChapter >= 2) {
                showChapterPlaceholder();
                return;
            }
            console.warn('Сцена не найдена. Конец главы.');
            const isLastScene = scriptData.scenes.length - 1 === currentScene;
            const isLastChapter = currentChapter === 1;
            if (isLastScene && isLastChapter) {
                stats.completionCount += 1;
                saveSession();
                alert(stats.language === "ru" 
                    ? `Вы прошли игру! Это ваше ${stats.completionCount}-е прохождение.` 
                    : `You completed the game! This is your ${stats.completionCount}th playthrough.`);
                handleMenu(new Event('click'));
            }
            return;
        }

        if (!checkSceneCondition(scene)) {
            currentScene++;
            showScene(currentScene);
            return;
        }

        if (scene.choices && scene.choices.some(choice => choice.timer)) {
            const timeoutMs = (scene.choices[0].timer || 10) * 1000;
            showSceneWithTimer(scene, timeoutMs);
            return;
        }

        const progressElement = document.getElementById('progress');
        const totalScenes = scriptData.scenes.length;
        const progressPercent = ((scene.id + 1) / totalScenes) * 100;
        progressElement.style.width = `${progressPercent}%`;

        const backgroundElement = document.getElementById('background');
        const charLeft = document.getElementById('character-left');
        const charRight = document.getElementById('character-right');
        const dialogueElement = document.getElementById('dialogue-text');
        const dialogueBox = document.querySelector('.dialogue-box');

        let displayText = scene.text[stats.language];
        if (stats.completionCount >= 1 && scene.second_playthrough_text) {
            displayText = scene.second_playthrough_text[stats.language];
        }

        const newBackground = scene.background || 'none';
        const shouldFade = currentBackground !== newBackground || scene.id === scriptData.scenes.length - 1;

        const applyScene = () => {
            backgroundElement.style.backgroundImage = newBackground === 'none' ? 'none' : `url('/heart_at_crossroads/assets/backgrounds/${newBackground}.png')`;
            currentBackground = newBackground;
            charLeft.style.backgroundImage = 'none';
            charRight.style.backgroundImage = 'none';
            charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
            charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

            const speakerName = scene.speaker ? scene.speaker[stats.language] : '';
            if (scene.characterLeft) {
                const leftChar = scene.characterLeft.includes('${stats.appearance}') 
                    ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
                    : scene.characterLeft;
                charLeft.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png')`;
                charLeft.classList.add(speakerName === "Анна" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
            }
            if (scene.characterRight) {
                const rightChar = scene.characterRight.includes('${stats.appearance}') 
                    ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
                    : scene.characterRight;
                charRight.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png')`;
                charRight.classList.add(speakerName === "Вика" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
            }

            if (scene.characterLeftOffset) charLeft.style.left = scene.characterLeftOffset;
            if (scene.characterRightOffset) charRight.style.right = scene.characterRightOffset;

            document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
            if (dialogueBox.touchHandler) {
                dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler);
                dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
                dialogueBox.touchHandler = null;
            }

            document.getElementById('speaker-name').textContent = speakerName;
            typeText(displayText, dialogueElement, () => {
                if (scene.id === 7) showMessengerOverlay();

                if (scene.choices && scene.choices.length > 0) {
                    document.body.ontouchstart = null;
                    document.body.onclick = null;
                    scene.choices.forEach(choice => {
                        const btn = createChoiceButton(choice);
                        if (choice.condition && !checkCondition(choice.condition)) {
                            btn.style.display = 'none';
                        } else if (choice.cost && stats.diamonds < choice.cost) {
                            btn.disabled = true;
                        } else {
                            const handleChoice = (e) => {
                                e.preventDefault();
                                if (choice.cost) stats.diamonds -= choice.cost;
                                updateDiamondsDisplay();
                                saveChoice(choice.id, choice.effects, choice.memoryTag);
                                if (choice.effects) showChoiceEffects(choice.effects);
                                if (choice.nextScene !== undefined) {
                                    currentScene = choice.nextScene;
                                    saveSession();
                                    showScene(currentScene);
                                } else if (choice.nextChapter) {
                                    currentChapter = choice.nextChapter;
                                    currentScene = 0;
                                    loadChapter(currentChapter).then(() => showScene(currentScene));
                                }
                            };
                            btn.addEventListener('touchstart', handleChoice);
                            btn.addEventListener('click', handleChoice);
                        }
                        dialogueBox.appendChild(btn);
                    });
                } else if (scene.nextScene !== undefined) {
                    dialogueBox.touchHandler = (e) => {
                        e.preventDefault();
                        if (!isTyping) {
                            currentScene = scene.nextScene;
                            saveSession();
                            showScene(currentScene);
                        }
                    };
                    dialogueBox.addEventListener('touchstart', dialogueBox.touchHandler);
                    dialogueBox.addEventListener('click', dialogueBox.touchHandler);
                } else if (scene.nextChapter) {
                    currentChapter = scene.nextChapter;
                    currentScene = 0;
                    loadChapter(currentChapter).then(() => showScene(currentScene));
                }
            });
        };

        if (shouldFade) {
            fadeOut(() => {
                applyScene();
                fadeIn();
            });
        } else {
            applyScene();
        }
    }

     function showSceneWithTimer(scene, timeoutMs = 5000) {
    const progressElement = document.getElementById('progress');
    const totalScenes = scriptData.scenes.length;
    const progressPercent = ((scene.id + 1) / totalScenes) * 100;
    progressElement.style.width = `${progressPercent}%`;

    const backgroundElement = document.getElementById('background');
    const charLeft = document.getElementById('character-left');
    const charRight = document.getElementById('character-right');
    const dialogueElement = document.getElementById('dialogue-text');
    const dialogueBox = document.querySelector('.dialogue-box');

    let displayText = scene.text[stats.language];
    if (stats.completionCount >= 1 && scene.second_playthrough_text) {
        displayText = scene.second_playthrough_text[stats.language];
    }

    const newBackground = scene.background || 'none';
    const shouldFade = currentBackground !== newBackground || scene.id === scriptData.scenes.length - 1;

    const applyScene = () => {
        backgroundElement.style.backgroundImage = newBackground === 'none' ? 'none' : `url('/heart_at_crossroads/assets/backgrounds/${newBackground}.png')`;
        currentBackground = newBackground;
        charLeft.style.backgroundImage = 'none';
        charRight.style.backgroundImage = 'none';
        charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
        charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

        const speakerName = scene.speaker ? scene.speaker[stats.language] : '';
        if (scene.characterLeft) {
            const leftChar = scene.characterLeft.includes('${stats.appearance}') 
                ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
                : scene.characterLeft;
            charLeft.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png')`;
            charLeft.classList.add(speakerName === "Анна" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
        }
        if (scene.characterRight) {
            const rightChar = scene.characterRight.includes('${stats.appearance}') 
                ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
                : scene.characterRight;
            charRight.style.backgroundImage = `url('/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png')`;
            charRight.classList.add(speakerName === "Вика" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
        }

        if (scene.characterLeftOffset) charLeft.style.left = scene.characterLeftOffset;
        if (scene.characterRightOffset) charRight.style.right = scene.characterRightOffset;

        document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
        if (dialogueBox.touchHandler) {
            dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler);
            dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
            dialogueBox.touchHandler = null;
        }

        document.getElementById('speaker-name').textContent = speakerName;
        console.log('Установка текста с таймером:', displayText);
        typeText(displayText, dialogueElement, () => {
            if (scene.id === 7) showMessengerOverlay(); // Оверлей на 3 секунды

            dialogueBox.style.pointerEvents = 'auto'; // Разблокируем кнопки сразу после текста
            scene.choices.forEach(choice => {
                const btn = createChoiceButton(choice);
                if (choice.condition && !checkCondition(choice.condition)) {
                    btn.style.display = 'none';
                } else if (choice.cost && stats.diamonds < choice.cost) {
                    btn.disabled = true;
                } else {
                    const handleChoice = (e) => {
                        e.preventDefault();
                        console.log('Выбор сделан:', choice.id);
                        if (choice.cost) stats.diamonds -= choice.cost;
                        updateDiamondsDisplay();
                        saveChoice(choice.id, choice.effects, choice.memoryTag);
                        if (choice.effects) showChoiceEffects(choice.effects);
                        clearTimeout(timer);
                        if (choice.nextScene !== undefined) {
                            currentScene = choice.nextScene;
                            saveSession();
                            showScene(currentScene);
                        } else if (choice.nextChapter) {
                            currentChapter = choice.nextChapter;
                            currentScene = 0;
                            loadChapter(currentChapter).then(() => showScene(currentScene));
                        }
                    };
                    btn.addEventListener('touchstart', handleChoice);
                    btn.addEventListener('click', handleChoice);
                }
                dialogueBox.appendChild(btn);
            });

            // Таймер с переходом по умолчанию к "ignore" (scene 10)
            const timer = setTimeout(() => {
                console.log('Таймер истёк, переход к умолчанию');
                const defaultChoice = scene.choices.find(c => c.id === 'ignore');
                if (defaultChoice && defaultChoice.nextScene !== undefined) {
                    currentScene = defaultChoice.nextScene;
                    saveSession();
                    showScene(currentScene);
                } else {
                    console.warn('Нет сцены по умолчанию для таймера!');
                }
            }, timeoutMs);
        });
    };

    if (shouldFade) {
        fadeOut(() => {
            applyScene();
            fadeIn();
        });
    } else {
        applyScene();
    }
}
    function showMessengerOverlay() {
        const existingOverlay = document.getElementById('messenger-overlay');
        if (existingOverlay) existingOverlay.remove();

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('id', 'messenger-overlay');
        svg.setAttribute('width', '300');
        svg.setAttribute('height', '500');
        svg.setAttribute('viewBox', '0 0 300 500');
        svg.style.position = 'absolute';
        svg.style.top = '50%';
        svg.style.left = '50%';
        svg.style.transform = 'translate(-50%, -50%)';
        svg.style.zIndex = '4';

        svg.innerHTML = `
            <rect x="20" y="20" width="260" height="460" rx="30" fill="#333" stroke="#555" stroke-width="2"/>
            <rect x="30" y="50" width="240" height="400" rx="10" fill="#fff"/>
            <rect x="30" y="50" width="240" height="400" fill="#E8F1F5"/>
            <g class="messages">
                <rect id="msg1" x="50" y="100" width="150" height="40" rx="10" fill="#DCF8C6"/>
                <text id="text1" x="60" y="125" fill="#333" font-size="14">Привет!</text>
                <rect id="msg2" x="100" y="160" width="130" height="40" rx="10" fill="#FFF"/>
                <text id="text2" x="110" y="185" fill="#333" font-size="14">Тусим вечером?</text>
                <rect id="msg3" x="50" y="220" width="160" height="40" rx="10" fill="#DCF8C6"/>
                <text id="text3" x="60" y="245" fill="#333" font-size="14">Дима будет!</text>
            </g>
        `;

        document.getElementById('game-container').appendChild(svg);

        gsap.from("#msg1, #text1", { y: 20, opacity: 0, duration: 1, delay: 0.5 });
        gsap.from("#msg2, #text2", { y: 20, opacity: 0, duration: 1, delay: 1 });
        gsap.from("#msg3, #text3", { y: 20, opacity: 0, duration: 1, delay: 1.5 });

        setTimeout(() => {
            if (document.getElementById('messenger-overlay')) {
                document.getElementById('messenger-overlay').remove();
            }
        }, 3000);
    }

    function showChoiceEffects(effects) {
        const validStats = ['crown', 'heart', 'leaf', 'diamonds'];
        for (let key in effects) {
            if (validStats.includes(key)) {
                const feedback = document.createElement('img');
                feedback.className = 'choice-feedback';
                feedback.src = `/heart_at_crossroads/assets/ui/${key}.png`;
                feedback.onerror = () => console.warn(`Изображение для ${key} не найдено`);
                document.getElementById('game-container').appendChild(feedback);
                setTimeout(() => feedback.remove(), 3000);
            }
        }
    }

    function showChapterPlaceholder() {
        const existingPlaceholder = document.querySelector('.placeholder-message');
        if (existingPlaceholder) existingPlaceholder.remove();
        const placeholder = document.createElement('div');
        placeholder.className = 'placeholder-message';
        placeholder.textContent = stats.language === "ru" ? 
            'Временная заглушка: эта глава в разработке. Перезапустите игру.' : 
            'Temporary placeholder: this chapter is in development. Restart the game.';
        document.getElementById('game-container').appendChild(placeholder);
        document.getElementById('character-left').style.backgroundImage = 'none';
        document.getElementById('character-right').style.backgroundImage = 'none';
        document.getElementById('speaker-name').textContent = '';
        document.getElementById('dialogue-text').textContent = '';
        const restartHandler = (e) => {
            e.preventDefault();
            placeholder.remove();
            currentChapter = 1;
            currentScene = 0;
            loadChapter(1).then(() => showScene(currentScene));
        };
        document.body.ontouchstart = restartHandler;
        document.body.onclick = restartHandler;
    }

    function checkSceneCondition(scene) {
        return !scene.condition || checkCondition(scene.condition);
    }

    function checkCondition(condition) {
        for (let key in condition) {
            const value = key.startsWith('relationships.') ? stats.relationships[key.split('.')[1]] || 0 : stats[key] || 0;
            const cond = condition[key];
            if (cond === "true") return value === true;
            if (cond === "false") return value === false;
            if (cond.startsWith('>=')) return value >= parseInt(cond.slice(2));
            if (cond.startsWith('>')) return value > parseInt(cond.slice(1));
            if (cond.startsWith('<=')) return value <= parseInt(cond.slice(2));
            if (cond.startsWith('<')) return value < parseInt(cond.slice(1));
            if (key === 'crown' && cond === '>heart+leaf') return value > (stats.heart + stats.leaf);
            if (key === 'completionCount') {
                if (cond === 'first') return value === 0;
                if (cond === 'second') return value === 1;
                if (cond === 'third') return value === 2;
                return value === parseInt(cond);
            }
            return value === parseInt(cond);
        }
        return true;
    }

    function typeText(text, element, callback) {
        element.textContent = '';
        if (element.typeTimer) clearTimeout(element.typeTimer);

        isTyping = true;
        let i = 0;
        const speed = 50;

        function type() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                element.typeTimer = setTimeout(type, speed);
            } else {
                isTyping = false;
                delete element.typeTimer;
                if (callback) callback();
            }
        }
        type();

        const dialogueBox = document.querySelector('.dialogue-box');
        dialogueBox.removeEventListener('touchstart', dialogueBox.skipHandler);
        dialogueBox.removeEventListener('click', dialogueBox.skipHandler);
        dialogueBox.skipHandler = (e) => {
            e.preventDefault();
            if (isTyping) {
                clearTimeout(element.typeTimer);
                element.textContent = text;
                isTyping = false;
                if (callback) callback();
            }
        };
        dialogueBox.addEventListener('touchstart', dialogueBox.skipHandler, { once: true });
        dialogueBox.addEventListener('click', dialogueBox.skipHandler, { once: true });
    }

    function fadeOut(callback) {
        const bg = document.getElementById('background');
        const charLeft = document.getElementById('character-left');
        const charRight = document.getElementById('character-right');
        const dialogue = document.getElementById('dialogue-box');
        bg.classList.add('fade-out');
        charLeft.classList.add('fade-out');
        charRight.classList.add('fade-out');
        dialogue.classList.add('fade-out');
        setTimeout(callback, 1000);
    }

    function fadeIn() {
        const bg = document.getElementById('background');
        const charLeft = document.getElementById('character-left');
        const charRight = document.getElementById('character-right');
        const dialogue = document.getElementById('dialogue-box');
        bg.classList.remove('fade-out');
        charLeft.classList.remove('fade-out');
        charRight.classList.remove('fade-out');
        dialogue.classList.remove('fade-out');
    }

    function handleMenu(e) {
        e.preventDefault();
        stats.hasReturnedViaMenu = true;
        resetGameState();
        saveSession();
        showStartScreen();
    }
</script>
</body>
</html>
