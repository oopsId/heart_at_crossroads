<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–µ—Ä–¥—Ü–µ –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–µ</title>
    <style>
        /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        @font-face {
            font-family: 'LobsterTwo';
            src: url('/heart_at_crossroads/assets/fonts/LobsterTwo-Bold.ttf') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        @font-face {
            font-family: 'GreatVibes';
            src: url('/heart_at_crossroads/assets/fonts/GreatVibes-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoodVibesCyr';
            src: url('/heart_at_crossroads/assets/fonts/GoodVibesCyr.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            max-width: 100vw;
            max-height: 100vh;
        }
        .parallax-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: 0% center;
            background-repeat: no-repeat;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slideBackground 60s linear infinite;
            z-index: 1;
            transition: opacity 1s ease;
        }
        @keyframes slideBackground {
            0% { background-position: 0% center; }
            50% { background-position: 100% center; }
            100% { background-position: 0% center; }
        }
        .character-left, .character-right {
            position: absolute;
            bottom: 0;
            width: 70%;
            max-width: 100vw;
            height: 100vh;
            max-height: 100vh;
            background-position: bottom center;
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 2;
            transition: opacity 1s ease, transform 0.3s ease, filter 0.3s ease;
            animation: appear 0.5s ease-in-out forwards;
        }
        @keyframes appear {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes shiver {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        .shiver {
            animation: shiver 0.5s infinite;
        }
        .heartbeat {
            animation: heartbeat 1s 3;
        }
        .character-left { left: -15%; transform: translateX(0); }
        .character-right { right: -15%; transform: translateX(0); }
        .character-speaker {
            transform: scale(1.1);
            filter: brightness(1.2);
            z-index: 3;
        }
        .character-non-speaker {
            transform: scale(1);
            filter: brightness(1);
            z-index: 2;
        }
        .dialogue-box {
            position: absolute;
            bottom: 20%;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(93, 64, 55, 0.8), rgba(93, 64, 55, 0.4));
            color: #F5F0E1;
            padding: 2px 20px 20px;
            text-align: center;
            z-index: 3;
            transition: opacity 1s ease, bottom 0.3s ease;
            opacity: 1;
            min-height: 150px;
            max-height: 50vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            box-sizing: border-box;
        }
        #speaker-name {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #E6D5C0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #dialogue-text {
            margin: 5px 0;
            font-size: 16px;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .choice-btn {
            display: block;
            margin: 10px auto;
            padding: 10px;
            width: 90%;
            background: linear-gradient(to bottom, #F5F0E1, #E6D5C0);
            color: #5D4037;
            border: 1px solid rgba(93, 64, 55, 0.2);
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            white-space: normal;
            min-height: 44px;
            height: auto;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 2px 5px rgba(93, 64, 55, 0.3);
        }
        .choice-btn:disabled {
            background: linear-gradient(to bottom, #666, #555);
            opacity: 0.7;
            box-shadow: none;
        }
        .choice-btn:hover:not(:disabled) {
            background: linear-gradient(to bottom, #E6D5C0, #D4BEA6);
            box-shadow: 0 3px 7px rgba(93, 64, 55, 0.4);
        }
        #menu {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 4;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-end;
            max-width: calc(100% - 20px);
            overflow-x: auto;
            white-space: nowrap;
        }
        #menu div {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        #menu img {
            width: 24px;
            height: 24px;
            margin-right: 5px;
        }
        #menu span {
            color: white;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        #menu-btn, #stats {
            margin: 0 5px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.8), rgba(160, 120, 90, 0.8));
            color: #5D4037;
            border: none;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        #menu-btn:hover, #stats:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.9), rgba(160, 120, 90, 0.9));
        }
        .choice-feedback {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            z-index: 4;
            animation: flyUp 3s ease-out forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh); opacity: 1; }
            100% { transform: translateY(100vh); opacity: 0; }
        }
        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            width: 5px;
            height: 5px;
            opacity: 0.7;
        }
        @keyframes flyUp {
            0% { bottom: 50%; opacity: 1; }
            50% { bottom: 60%; opacity: 0.8; }
            100% { bottom: 70%; opacity: 0; }
        }
        .fade-out {
            opacity: 0;
            transition: opacity 1s ease;
        }
    #start-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('/heart_at_crossroads/assets/backgrounds/start_screen.png') no-repeat center center fixed;
    background-size: cover;
    z-index: 3000; /* –£–≤–µ–ª–∏—á–µ–Ω–æ —Å 5 –¥–æ 3000 */
    pointer-events: auto;
    touch-action: auto;
       }
        #start-screen h1 {
            color: #A67C52;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 40px;
            text-align: center;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        #start-screen h1.ru {
            font-family: 'GoodVibesCyr', sans-serif;
        }
        #start-screen h1.en {
            font-family: 'GreatVibes', sans-serif;
        }
        #start-screen h1 span:first-child {
            font-size: 48px;
        }
        #start-screen h1 span:last-child {
            font-size: 40px;
        }
        .start-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            margin-bottom: 30px;
            position: relative;
        }
        .start-buttons button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
        }
        .start-buttons button:nth-child(1) {
            left: -30px;
        }
        .start-buttons button:nth-child(2) {
            left: 30px;
        }
        .start-buttons button:nth-child(3) {
            left: -30px;
        }
        #gallery-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: absolute;
            left: -130px;
            top: 50%;
            transform: translateY(-50%);
        }
        .start-buttons button:hover, #gallery-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            background: rgba(245, 240, 225, 0.9);
        }
        #password-form {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #password-input {
            padding: 12px;
            font-size: 16px;
            border-radius: 20px;
            border: 1px solid rgba(93, 64, 55, 0.3);
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            width: 220px;
            text-align: center;
        }
        #password-submit {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(245, 240, 225, 0.7);
            color: #5D4037;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #back-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(200, 180, 160, 0.6);
            color: #5D4037;
            font-size: 14px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .placeholder-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            z-index: 10;
        }
        #progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: #333;
            z-index: 4;
            display: none;
        }
        #progress {
            width: 0%;
            height: 100%;
            background: #DEB887;
            transition: width 0.5s ease;
        }
        #language-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 1px solid #fff;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            z-index: 6;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .memory-notification {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(to bottom, rgba(222, 184, 135, 0.7), rgba(160, 120, 90, 0.7));
            color: #5D4037;
            padding: 10px;
            border-radius: 5px;
            z-index: 5;
            font-size: 14px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        #debug-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(255, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
        #timer-countdown {
        position: absolute;
        bottom: calc(20% + 180px); /* –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—ã—à–µ */
        left: 50%;
        transform: translateX(-50%);
        font-size: 60px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä */
        color: #ff4444;
        font-weight: bold;
        z-index: 5; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º z-index, —á—Ç–æ–±—ã –±—ã–ª –Ω–∞–¥ –¥–∏–∞–ª–æ–≥–æ–≤—ã–º –æ–∫–Ω–æ–º */
        }
        @keyframes flash {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5); }
            100% { filter: brightness(1); }
        }
        .flash-svg { animation: flash 0.5s ease; }
        .choice-btn { z-index: 5; }
        .error-message {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
        }
        .phone-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            width: 240px;
            height: 400px;
            pointer-events: none;
        }


   #gallery-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url('/heart_at_crossroads/assets/backgrounds/shoebox_texture.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border: 2px solid #8C6F4A;
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        display: none;
        opacity: 0;
        z-index: 2000;
        overflow: hidden;
        padding: 20px;
        box-sizing: border-box;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #gallery-container::after {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        width: calc(100% + 4px);
        height: calc(100% + 4px);
        border: 2px dashed #8C6F4A;
        pointer-events: none;
    }

    .gallery-header {
        color: #F5E6C9;
        font-size: 3rem; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 1.5 —Ä–∞–∑–∞ (–±—ã–ª–æ 2rem) */
        text-align: center;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        opacity: 0;
    }

   .cards-container {
    position: relative;
    height: 600px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    perspective: 1000px;
    transform-style: preserve-3d;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible; /* –£–±–∏—Ä–∞–µ–º –æ–±—Ä–µ–∑–∫—É –∫–∞—Ä—Ç–æ—á–µ–∫ */
}

.cards-container {
    position: relative;
    height: 600px;
    width: 100%;
    max-width: 500px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
    margin: 0 auto;
    perspective: 1000px;
    transform-style: preserve-3d;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: visible;
}

    .premium-card:not(.front) {
        height: 50px;
        opacity: 0.7;
        background: linear-gradient(to bottom, #E0C18E, #BFA78A);
        border-top: 2px solid #FFF;
    }

    .premium-card.front {
        z-index: 100;
        height: 350px;
        opacity: 1;
        background: linear-gradient(to bottom, #FFF5E1, #F5D7A8);
        filter: brightness(1.2);
        box-shadow: 0 6px 20px rgba(245, 215, 168, 0.5);
    }

    .premium-card.peek {
        height: 175px; /* –ü–æ–ª–æ–≤–∏–Ω–∞ –≤—ã—Å–æ—Ç—ã */
        opacity: 1;
        z-index: 90;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .premium-card.locked {
        background: linear-gradient(to bottom, rgba(245, 230, 201, 0.7), rgba(230, 215, 168, 0.7));
    }

    .premium-card .card-name, .premium-card .unlock-text {
        position: absolute;
        bottom: 0;
        width: 100%;
        text-align: center;
        padding: 5px;
        color: #333;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        font-size: 1.2rem;
    }

    .premium-card.locked .unlock-text {
        color: #777;
        font-size: 0.9rem;
    }

    .card-shine-effect {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.1) 100%);
        pointer-events: none;
        z-index: 5;
    }

    .card-unlock-button {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(to bottom, #8C6F4A, #5A3F2A);
        color: #F5E6C9;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
        cursor: pointer;
        z-index: 2;
    }

    .card-unlock-button:hover, .card-unlock-button:active {
        transform: translateX(-50%) scale(1.05);
        box-shadow: 0 6px 15px rgba(90, 63, 42, 0.4);
    }

    .card-detail {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1.5);
        z-index: 3000;
        transition: transform 0.4s ease-out;
    }

    .series-title {
        font-size: 1.5rem;
    }

    .camera-btn {
        background: none;
        border: none;
        cursor: pointer;
        position: relative;
        margin-top: 20px;
    }

    .camera-btn svg {
        width: 60px;
        height: 60px;
    }

    .camera-flash {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 40px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
        border-radius: 50%;
        opacity: 0;
        pointer-events: none;
    }

    .camera-btn span {
        position: absolute;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        color: #e0c18e;
        font-size: 2.25rem; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤ 1.5 —Ä–∞–∑–∞ (–±—ã–ª–æ 1.5rem) */
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
    </style>
</head>
<body>
    <div id="start-screen">
        <h1 id="title" data-ru="–°–µ—Ä–¥—Ü–µ<br>–Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–µ" data-en="Heart<br>at the Crossroads">
            <span>–°–µ—Ä–¥—Ü–µ</span>
            <span>–Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–µ</span>
        </h1>
        <div class="start-buttons">
            <button id="start-game" data-ru="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É" data-en="Start Game">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            <button id="continue-game" data-ru="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" data-en="Continue">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            <button id="show-password" data-ru="–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å" data-en="Enter Password">–í–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å</button>
            <button id="gallery-btn" data-ru="–ì–∞–ª–µ—Ä–µ—è" data-en="Gallery">–ì–∞–ª–µ—Ä–µ—è</button>
        </div>
        <div id="password-form">
            <input type="text" id="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
            <button id="password-submit" data-ru="–í–æ–π—Ç–∏" data-en="Login">–í–æ–π—Ç–∏</button>
        </div>
        
        <button id="language-btn">
            <span id="language-icon">üá∑üá∫</span>
        </button>
    </div>
	
	<div id="gallery-container" style="display: none;">
        <!-- –î–æ—á–µ—Ä–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
       </div>
	
    <div id="game-container">
        <div class="parallax-bg" id="background" style="display: none;"></div>
        <div class="character-left" id="character-left" style="display: none;"></div>
        <div class="character-right" id="character-right" style="display: none;"></div>
        <div class="dialogue-box" id="dialogue-box" style="display: none;">
            <p id="speaker-name"></p>
            <p id="dialogue-text"></p>
        </div>
        <div id="progress-bar" style="display: none;">
            <div id="progress"></div>
        </div>
        <div id="menu" style="display: none;">
            <div id="diamonds">
                <img src="/heart_at_crossroads/assets/ui/diamonds.png" alt="–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã">
                <span id="diamonds-count">100</span>
            </div>
            <button id="menu-btn" data-ru="–ú–µ–Ω—é" data-en="Menu">–ú–µ–Ω—é</button>
            <button id="stats">–°—Ç–∞—Ç—ã</button>
        </div>
        <div id="particles" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 3;"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
    <script>
         // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞
        const cardSeries = {
            "romance": {
                title: "–†–æ–º–∞–Ω—Ç–∏–∫–∞",
                titleEn: "Romance",
                cards: [                    { id: "card_sergey_and_wife", name: "–°–µ—Ä–≥–µ–π –∏ –µ–≥–æ –∂–µ–Ω–∞", nameEn: "Sergey and his wife", unlock: "–≤—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ", unlockEn: "second playthrough" },                    { id: "card_anna_and_dima_final", name: "–ê–Ω–Ω–∞ –∏ –î–∏–º–∞: —Ñ–æ—Ç–æ –∏–∑ —Ñ–∏–Ω–∞–ª–∞", nameEn: "Anna and Dima: final photo", unlock: "–≤—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ", unlockEn: "second playthrough" },                    { id: "card_mark_childhood", name: "–ú–∞—Ä–∫ –≤ –¥–µ—Ç—Å—Ç–≤–µ", nameEn: "Mark as a child", unlock: "50", unlockEn: "50" },                    { id: "card_katya_and_anna_bff_birthday", name: "–ö–∞—Ç—è –∏ –ê–Ω–Ω–∞: –ø–æ–¥—Ä—É–≥–∏ –Ω–∞ –¥–Ω–µ —Ä–æ–∂–¥–µ–Ω—å—è", nameEn: "Katya and Anna: friends at a birthday party", unlock: "50", unlockEn: "50" }                ],
                style: "–ü—Ä–æ—à–ª–æ–µ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞",
                styleEn: "The past remains forever"
            }
        };

        // –î–æ–±–∞–≤–ª—è–µ–º SVG —É–∫—Ä–∞—à–µ–Ω–∏—è
        const svgDecorations = {
            rosePetal: `<svg width="50" height="50" viewBox="0 0 50 50" xmlns="http://www.w3.org/2000/svg">
                <path d="M10,25 Q25,5 40,25 Q25,45 10,25 Z" fill="#f8d7da" stroke="#e8b5b9" stroke-width="1" opacity="0.8" />
                <path d="M15,25 Q25,10 35,25 Q25,40 15,25 Z" fill="#f0c1c4" stroke="none" opacity="0.6" />
            </svg>`,
            filmScratch: `<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <filter id="noise">
                    <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch" />
                    <feColorMatrix type="matrix" values="0 0 0 0 0, 0 0 0 0 0, 0 0 0 0 0, 0 0 0 0.15 0" />
                </filter>
                <rect width="100%" height="100%" filter="url(#noise)" opacity="0.08" />
                <line x1="${Math.random() * 100}%" y1="0" x2="${Math.random() * 100}%" y2="100%" stroke="white" stroke-width="0.5" opacity="0.2" />
                <line x1="${Math.random() * 100}%" y1="0" x2="${Math.random() * 100}%" y2="100%" stroke="white" stroke-width="0.8" opacity="0.1" />
            </svg>`
        };

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram
        const isTelegram = !!(window.Telegram && window.Telegram.WebApp && Telegram.WebApp.initDataUnsafe);
        if (isTelegram) {
            try {
                Telegram.WebApp.ready();
                console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram:', error);
                alert('–û—à–∏–±–∫–∞ Telegram Web App. –§—É–Ω–∫—Ü–∏–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã.');
            }
        } else {
            console.log('–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
        }

        const userId = isTelegram ? Telegram.WebApp.initDataUnsafe.user?.id : null;
        let currentChapter = 1;
        let currentScene = 0;
        let choices = [];
        let stats = {
            crown: 0,
            heart: 0,
            leaf: 0,
            diamonds: 100,
            relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
            appearance: "style1",
            isAuthorized: false,
            memories: [],
            language: "ru",
            hasReturnedViaMenu: false,
            completionCount: 0
        };
        let isTyping = false;
        let scriptData = null;
        let currentBackground = null;
        const correctPassword = "umbertoeco";
        const tempPassword = "999000";

        function playSound(sound) {
            if (sound) {
                const audio = new Audio(`/heart_at_crossroads/assets/sounds/${sound}`);
                audio.play()
                    .catch(error => {
                        console.error(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞ ${sound}:`, error);
                        showErrorMessage(stats.language === "ru" ? `–ó–≤—É–∫ ${sound} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Sound ${sound} not found`);
                    });
            }
        }

        function playMusic(music) {
            if (music) {
                if (window.currentMusic) window.currentMusic.pause();
                window.currentMusic = new Audio(`/heart_at_crossroads/assets/sounds/${music}`);
                window.currentMusic.loop = true;
                window.currentMusic.play()
                    .catch(error => {
                        console.error(`–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –º—É–∑—ã–∫–∏ ${music}:`, error);
                        showErrorMessage(stats.language === "ru" ? `–ú—É–∑—ã–∫–∞ ${music} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞` : `Music ${music} not found`);
                    });
            }
        }

        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 3000);
        }

        // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è
        function saveToStorage(key, value) {
            return new Promise((resolve, reject) => {
                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.isVersionAtLeast && 
                        window.Telegram.WebApp.isVersionAtLeast('6.0')) {
                        window.Telegram.WebApp.CloudStorage.setItem(key, value)
                            .then(() => {
                                console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Telegram CloudStorage: ${key}`);
                                resolve();
                            })
                            .catch(err => {
                                console.warn('–û—à–∏–±–∫–∞ Telegram CloudStorage, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ localStorage:', err);
                                localStorage.setItem(key, value);
                                console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage: ${key}`);
                                resolve();
                            });
                    } else {
                        localStorage.setItem(key, value);
                        console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage: ${key}`);
                        resolve();
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ in-memory storage:', error);
                    if (!window._inMemoryStorage) window._inMemoryStorage = {};
                    window._inMemoryStorage[key] = value;
                    console.log(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ in-memory storage: ${key}`);
                    resolve();
                }
            });
        }

        function getFromStorage(key) {
            return new Promise((resolve, reject) => {
                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.isVersionAtLeast && 
                        window.Telegram.WebApp.isVersionAtLeast('6.0')) {
                        window.Telegram.WebApp.CloudStorage.getItem(key)
                            .then(value => {
                                console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ Telegram CloudStorage: ${key}`);
                                resolve(value);
                            })
                            .catch(err => {
                                console.warn('–û—à–∏–±–∫–∞ Telegram CloudStorage, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ localStorage:', err);
                                const value = localStorage.getItem(key);
                                console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ localStorage: ${key}`);
                                resolve(value);
                            });
                    } else {
                        const value = localStorage.getItem(key);
                        console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ localStorage: ${key}`);
                        resolve(value);
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è, –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ in-memory storage:', error);
                    if (!window._inMemoryStorage) window._inMemoryStorage = {};
                    const value = window._inMemoryStorage[key] || null;
                    console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ in-memory storage: ${key}`);
                    resolve(value);
                }
            });
        }

        function saveSession() {
            const sessionData = JSON.stringify({
                currentScene,
                currentChapter,
                stats,
                choices
            });
            saveToStorage('gameSession', sessionData)
                .then(() => {
                    console.log('–°–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏:', error);
                    showDebugMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏');
                });
        }

        // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
        const addEventListeners = (element, events, handler) => {
            events.forEach(event => {
                element.addEventListener(event, handler);
                console.log(`–ü—Ä–∏–≤—è–∑–∞–Ω ${event} –∫ ${element.id}`);
            });
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ DOM
        document.addEventListener('DOMContentLoaded', () => {
            const startGameBtn = document.getElementById('start-game');
            const continueGameBtn = document.getElementById('continue-game');
            const showPasswordBtn = document.getElementById('show-password');
            const passwordSubmitBtn = document.getElementById('password-submit');
            const menuBtn = document.getElementById('menu-btn');
            const statsBtn = document.getElementById('stats');
            const galleryBtn = document.getElementById('gallery-btn');
            const languageBtn = document.getElementById('language-btn');
            const languageIcon = document.getElementById('language-icon');

            if (!startGameBtn) console.error('–ö–Ω–æ–ø–∫–∞ start-game –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            updateLanguage(stats.language);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            function handleStartGame(e) {
                e.preventDefault();
                console.log('handleStartGame –≤—ã–∑–≤–∞–Ω');
                checkTempPassword(() => startNewGame());
            }

            function handleContinueGame(e) {
                e.preventDefault();
                console.log('handleContinueGame –≤—ã–∑–≤–∞–Ω');
                checkTempPassword(() => loadSession(() => startGame()));
            }

            function handleShowPassword(e) {
                e.preventDefault();
                console.log('handleShowPassword –≤—ã–∑–≤–∞–Ω');
                document.getElementById('password-form').style.display = 'flex';
                document.querySelector('.start-buttons').style.display = 'none';
            }

            async function handlePasswordSubmit(e) {
                e.preventDefault();
                console.log('handlePasswordSubmit –≤—ã–∑–≤–∞–Ω');
                const inputPassword = document.getElementById('password-input').value;
                try {
                    if (inputPassword === tempPassword || inputPassword === correctPassword) {
                        if (inputPassword === correctPassword) {
                            let authorizedUsers = JSON.parse(await getFromStorage('authorized_users') || '[]');
                            if (userId && !authorizedUsers.includes(userId)) {
                                authorizedUsers.push(userId);
                                await saveToStorage('authorized_users', JSON.stringify(authorizedUsers));
                            }
                            stats.isAuthorized = true;
                        }
                        startNewGame();
                    } else {
                        alert(stats.language === "ru" ? '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!' : 'Incorrect password!');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞—Ä–æ–ª—è:', error);
                    alert(stats.language === "ru" ? '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.' : 'Authorization error.');
                }
            }

            function handleMenu(e) {
                e.preventDefault();
                console.log('handleMenu –≤—ã–∑–≤–∞–Ω');
                stats.hasReturnedViaMenu = true;
                resetGameState();
                saveSession();
                showStartScreen();
            }

            function handleShowStats(e) {
                e.preventDefault();
                console.log('handleShowStats –≤—ã–∑–≤–∞–Ω');
                const statsText = stats.language === "ru" ?
                    `–ö–æ—Ä–æ–Ω—ã: ${stats.crown}\n–°–µ—Ä–¥—Ü–µ: ${stats.heart}\n–õ–∏—Å—Ç: ${stats.leaf}\n–ë—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã: ${stats.diamonds}\n–û—Ç–Ω–æ—à–µ–Ω–∏—è:\n–ú–∞—Ä–∫: ${stats.relationships.mark}\n–õ–µ—Ä–∞: ${stats.relationships.lera}\n–í–∏–∫–∞: ${stats.relationships.vika}\n–°–µ—Ä–≥–µ–π: ${stats.relationships.sergey}\n–ê–Ω–Ω–∞: ${stats.relationships.anna}\n–î–∏–º–∞: ${stats.relationships.dima}\n–õ—ë—à–∞: ${stats.relationships.lesha}` :
                    `Crowns: ${stats.crown}\nHeart: ${stats.heart}\nLeaf: ${stats.leaf}\nDiamonds: ${stats.diamonds}\nRelationships:\nMark: ${stats.relationships.mark}\nLera: ${stats.relationships.lera}\nVika: ${stats.relationships.vika}\nSergey: ${stats.relationships.sergey}\nAnna: ${stats.relationships.anna}\nDima: ${stats.relationships.dima}\nLesha: ${stats.relationships.lesha}`;
                alert(statsText);
            }

            function handleShowGallery(e) {
            e.preventDefault();
            console.log('handleShowGallery –≤—ã–∑–≤–∞–Ω');
            showPremiumGallery();
                }

            function handleLanguageSwitch(e) {
                e.preventDefault();
                console.log('handleLanguageSwitch –≤—ã–∑–≤–∞–Ω');
                stats.language = stats.language === "ru" ? "en" : "ru";
                languageIcon.textContent = stats.language === "ru" ? "üá∑üá∫" : "üá¨üáß";
                updateLanguage(stats.language);
                saveSession();
            }

            // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
            addEventListeners(startGameBtn, ['click', 'touchstart'], handleStartGame);
            addEventListeners(continueGameBtn, ['click', 'touchstart'], handleContinueGame);
            addEventListeners(showPasswordBtn, ['click', 'touchstart'], handleShowPassword);
            addEventListeners(passwordSubmitBtn, ['click', 'touchstart'], handlePasswordSubmit);
            addEventListeners(menuBtn, ['click', 'touchstart'], handleMenu);
            addEventListeners(statsBtn, ['click', 'touchstart'], handleShowStats);
            addEventListeners(galleryBtn, ['click', 'touchstart'], (e) => e.preventDefault());
            addEventListeners(galleryBtn, ['click', 'touchstart'], handleShowGallery);
            addEventListeners(languageBtn, ['click', 'touchstart'], handleLanguageSwitch);

            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
            const backButton = document.createElement('button');
            backButton.id = 'back-button';
            backButton.textContent = stats.language === "ru" ? "–ù–∞–∑–∞–¥" : "Back";
            addEventListeners(backButton, ['click', 'touchstart'], (e) => {
                e.preventDefault();
                console.log('backButton –≤—ã–∑–≤–∞–Ω');
                document.getElementById('password-form').style.display = 'none';
                document.querySelector('.start-buttons').style.display = 'flex';
            });
            document.getElementById('password-form').appendChild(backButton);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            getFromStorage('last_session')
                .then(session => {
                    console.log('–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', session);
                    if (session) showStartScreen();
                    else checkAuthorization();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
                    showStartScreen();
                });
        });

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function clearEventListeners(element, events) {
        events.forEach(event => {
        element.removeEventListener(event, element[event + 'Handler']);
        element[event + 'Handler'] = null;
       });
       }

    function showStartScreen() {
    console.log('showStartScreen –≤—ã–∑–≤–∞–Ω');
    const startScreen = document.getElementById('start-screen');
    const gameContainer = document.getElementById('game-container');
    const galleryContainer = document.getElementById('gallery-container');
    const languageBtn = document.getElementById('language-btn');

    startScreen.style.display = 'flex';
    languageBtn.style.display = 'block';
    gameContainer.style.display = 'none';
    galleryContainer.style.display = 'none'; // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≥–∞–ª–µ—Ä–µ—è —Å–∫—Ä—ã—Ç–∞
}

        function resetGameState() {
            console.log('resetGameState –≤—ã–∑–≤–∞–Ω');
            currentChapter = 1;
            currentScene = 0;
            choices = [];
            stats = {
                crown: 0,
                heart: 0,
                leaf: 0,
                diamonds: 10,
                relationships: { mark: 0, lera: 0, vika: 0, sergey: 0, anna: 0, dima: 0, lesha: 0 },
                appearance: "style1",
                isAuthorized: stats.isAuthorized,
                memories: [],
                language: stats.language,
                hasReturnedViaMenu: true,
                completionCount: stats.completionCount
            };
            currentBackground = null;
        }

        function updateLanguage(lang) {
            console.log('updateLanguage –≤—ã–∑–≤–∞–Ω —Å —è–∑—ã–∫–æ–º:', lang);
            document.getElementById('start-game').textContent = document.getElementById('start-game').getAttribute(`data-${lang}`);
            document.getElementById('continue-game').textContent = document.getElementById('continue-game').getAttribute(`data-${lang}`);
            document.getElementById('show-password').textContent = document.getElementById('show-password').getAttribute(`data-${lang}`);
            document.getElementById('password-submit').textContent = document.getElementById('password-submit').getAttribute(`data-${lang}`);
            document.getElementById('menu-btn').textContent = document.getElementById('menu-btn').getAttribute(`data-${lang}`);
            document.getElementById('gallery-btn').textContent = document.getElementById('gallery-btn').getAttribute(`data-${lang}`);
            const title = document.getElementById('title');
            title.innerHTML = lang === "ru" ? '<span>–°–µ—Ä–¥—Ü–µ</span><span>–Ω–∞ –ø–µ—Ä–µ–∫—Ä—ë—Å—Ç–∫–µ</span>' : '<span>Heart</span><span>at the Crossroads</span>';
            title.className = lang === "ru" ? "ru" : "en";
        }

        async function checkAuthorization() {
            try {
                const authorizedUsers = (await getFromStorage('authorized_users')) || [];
                if (userId && authorizedUsers.includes(userId)) {
                    stats.isAuthorized = true;
                    startGame();
                } else {
                    showStartScreen();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                showStartScreen();
            }
        }

        async function checkTempPassword(callback) {
            try {
                const granted = await getFromStorage('tempAccessGranted');
                if (granted) {
                    console.log('–í—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø —É–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
                    callback();
                } else {
                    const input = prompt(stats.language === "ru" ? '–ò–≥—Ä–∞ –∑–∞–∫—Ä—ã—Ç–∞ –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:' : 'Game is under refinement. Enter password:');
                    if (input === tempPassword || input === correctPassword) {
                        await saveToStorage('tempAccessGranted', true);
                        if (input === correctPassword) stats.isAuthorized = true;
                        console.log('–ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –¥–æ—Å—Ç—É–ø –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
                        callback();
                    } else {
                        alert(stats.language === "ru" ? '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!' : 'Incorrect password!');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', error);
                alert(stats.language === "ru" ? '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞.' : 'Access error.');
            }
        }

        function startNewGame() {
            console.log('startNewGame –≤—ã–∑–≤–∞–Ω');
            resetGameState();
            saveSession();
            startGame();
        }

        async function loadSession(callback) {
            try {
                const session = await getFromStorage('last_session');
                if (session) {
                    currentChapter = session.currentChapter;
                    currentScene = session.currentScene;
                    choices = session.choices;
                    stats = { ...stats, ...session.stats };
                    console.log('–°–µ—Å—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', session);
                }
                if (callback) callback();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Å—Å–∏–∏:', error);
            }
        }

               function showMessengerOverlay(sceneId) {
    console.log(`–°–æ–∑–¥–∞–Ω–∏–µ –æ–≤–µ—Ä–ª–µ—è –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId}`);
    const existingOverlay = document.getElementById('messenger-overlay');
    if (existingOverlay) existingOverlay.remove();

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('id', 'messenger-overlay');
    svg.setAttribute('width', '240');
    svg.setAttribute('height', '400');
    svg.setAttribute('viewBox', '0 0 300 500');
    svg.classList.add('phone-overlay'); // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –∏–∑ CSS

    let avatarSrc, senderName, messages;
    if (sceneId === 7) {
        avatarSrc = "/heart_at_crossroads/assets/characters/lesha/lyosha_messenger_ava.png";
        senderName = "–õ—ë—à–∞";
        messages = [
            { id: "msg1", x: 50, y: 120, width: 160, textX: 60, textY: 145, text: stats.language === "ru" ? "–¢—É—Å–∏–º –≤–µ—á–µ—Ä–æ–º" : "Party tonight" },
            { id: "msg2", x: 50, y: 180, width: 100, textX: 60, textY: 205, text: stats.language === "ru" ? "–î–∏–º–∞ –±—É–¥–µ—Ç" : "Dima‚Äôs coming" },
            { id: "msg3", x: 50, y: 240, width: 90, textX: 60, textY: 265, text: stats.language === "ru" ? "–ü—Ä–∏—Ö–æ–¥–∏" : "Be there" }
        ];
    } else if (sceneId === 21) {
        avatarSrc = "/heart_at_crossroads/assets/characters/mark/mark_messenger_ava.png";
        senderName = "–ú–∞—Ä–∫";
        const fullText = stats.language === "ru" ? "–¢—ã –∫—Ä–∞—Å–∏–≤–∞—è, –∫–æ–≥–¥–∞ —Ç–µ—Ä—è–µ—à—å—Å—è" : "You‚Äôre beautiful when you‚Äôre lost";
        const maxCharsPerLine = 15;
        const lines = [];
        let currentLine = "";
        fullText.split(" ").forEach(word => {
            if ((currentLine + word).length <= maxCharsPerLine) {
                currentLine += (currentLine ? " " : "") + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        });
        if (currentLine) lines.push(currentLine);
        messages = lines.map((line, idx) => ({
            id: `msg${idx + 1}`,
            x: 50,
            y: 120 + idx * 40,
            width: 180,
            textX: 60,
            textY: 145 + idx * 40,
            text: line
        }));
    } else {
        // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å—Ü–µ–Ω —Å "—Ç–µ–ª–µ—Ñ–æ–Ω–æ–º"
        const sceneData = scriptData.scenes.find(s => s.id === sceneId) || {};
        avatarSrc = `/heart_at_crossroads/assets/characters/${sceneData.speaker?.[stats.language]?.toLowerCase() || 'unknown'}/${sceneData.speaker?.[stats.language]?.toLowerCase() || 'unknown'}_messenger_ava.png`;
        senderName = sceneData.speaker?.[stats.language] || "Unknown";
        messages = [{
            id: "msg1",
            x: 50,
            y: 120,
            width: 200,
            textX: 60,
            textY: 145,
            text: sceneData.text?.[stats.language]?.substring(0, 50) || "–°–æ–æ–±—â–µ–Ω–∏–µ..."
        }];
    }

    svg.innerHTML = `
        <!-- –ö–æ—Ä–ø—É—Å —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ -->
        <rect x="20" y="20" width="260" height="460" rx="30" fill="#333" stroke="#555" stroke-width="2"/>
        <!-- –≠–∫—Ä–∞–Ω —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞ —Å —Ñ–æ–Ω–æ–≤—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
        <rect x="30" y="50" width="240" height="400" rx="10" fill="#fff"/>
        <image xlink:href="/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png" x="30" y="50" width="240" height="400" preserveAspectRatio="xMidYMid slice" opacity="0.3"/>
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ Telegram —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–≤–∞—Ç–∞—Ä–∫–æ–π -->
        <rect x="30" y="50" width="240" height="50" fill="#fff"/>
        <clipPath id="avatarClip">
            <circle cx="60" cy="75" r="15"/>
        </clipPath>
        <image xlink:href="${avatarSrc}" x="45" y="60" width="30" height="30" clip-path="url(#avatarClip)" onerror="console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏: ${avatarSrc}')"/>
        <circle cx="60" cy="75" r="15" fill="none" stroke="#ccc" stroke-width="1"/>
        <text x="85" y="85" fill="#000" font-size="16" font-family="Arial, sans-serif">${senderName}</text>
        <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–∞—è –ª–∏–Ω–∏—è -->
        <line x1="30" y1="100" x2="270" y2="100" stroke="#ccc" stroke-width="1"/>
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <g class="messages">
            ${messages.map((msg, idx) => `
                <rect id="msg${idx + 1}" x="${msg.x}" y="${msg.y}" width="${msg.width}" height="${40 * (Math.ceil(msg.text.length / 15) || 1)}" rx="10" fill="#E1F5C4"/>
                <text id="text${idx + 1}" x="${msg.textX}" y="${msg.textY}" fill="#000" font-size="14" font-family="Arial, sans-serif">${msg.text}</text>
            `).join('')}
            <!-- –ü—É—Å—Ç–æ–µ –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
            <rect id="msg${messages.length + 1}" x="120" y="${messages.length * 60 + 180}" width="100" height="40" rx="10" fill="#fff" stroke="#ccc" stroke-width="1"/>
            <text id="text${messages.length + 1}" x="130" y="${messages.length * 60 + 205}" fill="#000" font-size="14" font-family="Arial, sans-serif" opacity="0">...</text>
        </g>
    `;

    console.log(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ SVG –≤ DOM –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId}`);
    document.getElementById('game-container').appendChild(svg);

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    console.log(`–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId}`);
    gsap.from(svg, { y: -20, opacity: 0, duration: 0.5 });
    messages.forEach((msg, idx) => {
        gsap.from(`#msg${idx + 1}, #text${idx + 1}`, { y: 20, opacity: 0, duration: 1, delay: 0.5 + idx * 0.5 });
    });
    gsap.from(`#msg${messages.length + 1}`, { y: 20, opacity: 0, duration: 1, delay: 0.5 + messages.length * 0.5 });
    gsap.to(`#text${messages.length + 1}`, { 
        opacity: 1, 
        duration: 0, 
        delay: 0.5 + messages.length * 0.5 + 0.5, 
        onStart: function() {
            let text = "...";
            let index = 0;
            let interval = setInterval(() => {
                document.getElementById(`text${messages.length + 1}`).textContent = text.slice(0, index);
                index++;
                if (index > text.length) clearInterval(interval);
            }, 100);
        }
    });

    return svg;
}

function createDefaultOverlay(sceneId, sceneData = {}) {
    console.log(`–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ–≤–µ—Ä–ª–µ—è –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId}`);
    const overlay = document.createElement('div');
    overlay.classList.add('phone-overlay');
    overlay.style.background = 'url(/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png) no-repeat center/cover';
    
    const speaker = sceneData.speaker ? sceneData.speaker[stats.language] : 'Unknown';
    const avatar = document.createElement('img');
    avatar.src = `/heart_at_crossroads/assets/characters/${speaker.toLowerCase()}/${speaker.toLowerCase()}_messenger_ava.png`;
    avatar.style.width = '40px';
    avatar.style.height = '40px';
    avatar.style.position = 'absolute';
    avatar.style.top = '20px';
    avatar.style.left = '20px';
    avatar.onerror = () => console.warn(`–ê–≤–∞—Ç–∞—Ä –¥–ª—è ${speaker} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
    overlay.appendChild(avatar);

    const name = document.createElement('div');
    name.textContent = speaker;
    name.style.position = 'absolute';
    name.style.top = '25px';
    name.style.left = '70px';
    name.style.color = '#fff';
    name.style.fontSize = '16px';
    overlay.appendChild(name);

    const message = document.createElement('div');
    message.textContent = sceneData.text ? sceneData.text[stats.language].substring(0, 100) : '';
    message.style.position = 'absolute';
    message.style.top = '70px';
    message.style.left = '20px';
    message.style.right = '20px';
    message.style.color = '#fff';
    message.style.fontSize = '14px';
    overlay.appendChild(message);

    document.getElementById('game-container').appendChild(overlay);
    return overlay;
}


        async function startGame() {
            try {
                console.log('startGame –≤—ã–∑–≤–∞–Ω');
                showDebugMessage('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
                document.getElementById('game-container').style.display = 'block';
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('language-btn').style.display = 'none';

                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'loading-overlay';
                loadingOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:10;display:flex;justify-content:center;align-items:center;color:#fff;';
                loadingOverlay.innerHTML = '<span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
                document.body.appendChild(loadingOverlay);

                await preloadAssets(currentChapter);
                await loadChapter(currentChapter);

                document.getElementById('background').style.display = 'block';
                document.getElementById('character-left').style.display = 'block';
                document.getElementById('character-right').style.display = 'block';
                document.getElementById('dialogue-box').style.display = 'block';
                document.getElementById('menu').style.display = 'flex';
                document.getElementById('progress-bar').style.display = 'block';

                document.getElementById('stats').style.display = stats.isAuthorized ? 'block' : 'none';
                updateDiamondsDisplay();

                loadingOverlay.remove();
                showScene(currentScene);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ startGame:', error);
                showDebugMessage(`–û—à–∏–±–∫–∞: ${error.message}`);
                alert(stats.language === "ru" ? '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã.' : 'Game start error.');
                document.getElementById('loading-overlay')?.remove();
                showStartScreen();
            }
        }

        function updateDiamondsDisplay() {
            document.getElementById('diamonds-count').textContent = stats.diamonds;
        }

        function showDebugMessage(message) {
            let debugDiv = document.getElementById('debug-message');
            if (!debugDiv) {
                debugDiv = document.createElement('div');
                debugDiv.id = 'debug-message';
                document.body.appendChild(debugDiv);
            }
            debugDiv.textContent = message;
            setTimeout(() => debugDiv.remove(), 5000);
        }

        function checkAssetExists(url) {
            return fetch(url, { method: 'HEAD' })
                .then(res => res.ok)
                .catch(() => false);
        }
        

        async function preloadAssets(chapterId, options = {}) {
            console.log(`–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –≥–ª–∞–≤—ã: ${chapterId}`);
            const language = options.language || 'ru';
            const texts = {
                loading: language === 'ru' ? '–ó–∞–≥—Ä—É–∑–∫–∞' : 'Loading',
                imageNotFound: language === 'ru' ? '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : 'Image not found',
                loadError: language === 'ru' ? '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å' : 'Failed to load'
            };
            const loadingStatus = document.createElement('div');
            loadingStatus.id = 'loading-status';
            loadingStatus.style.cssText = 'position: fixed; bottom: 10px; left: 10px; color: white; font-size: 12px; z-index: 11; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 3px;';
            document.body.appendChild(loadingStatus);
            const images = [
                '/heart_at_crossroads/assets/backgrounds/start_screen.png',
                '/heart_at_crossroads/assets/backgrounds/bg_apartment_morning.png',
                '/heart_at_crossroads/assets/backgrounds/bg_coffee_shop.png',
                '/heart_at_crossroads/assets/backgrounds/bg_phone_messenger.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_day_trash.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_dusk_end.png',
                '/heart_at_crossroads/assets/backgrounds/bg_street_night.png',
                '/heart_at_crossroads/assets/backgrounds/bg_webstudio_day.png',
                '/heart_at_crossroads/assets/backgrounds/bg_webstudio_night.png',
                '/heart_at_crossroads/assets/characters/anna/anna_angry_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_happy_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_happy_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_neutral_style3.png',
                '/heart_at_crossroads/assets/characters/anna/anna_sad_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_sad_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_smile_style2_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_surprised_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style1_summer.png',
                '/heart_at_crossroads/assets/characters/anna/anna_thoughtful_style2.png',
                '/heart_at_crossroads/assets/characters/anna/anna_worry_style1.png',
                '/heart_at_crossroads/assets/characters/anna/anna_worry_style2.png',
                '/heart_at_crossroads/assets/characters/dima/dima_happy_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_sad_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_smile_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/dima/dima_worry_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_happy_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_messenger_ava.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_sad_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_smile_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/lesha/lyosha_worry_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_happy_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_messenger_ava.png',
                '/heart_at_crossroads/assets/characters/mark/mark_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_sad_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_smile_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/mark/mark_worry_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_happy_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_sad_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_smile_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/sergey/sergey_worry_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_confident_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_happy_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_happy_style1_summer.png',
                '/heart_at_crossroads/assets/characters/vika/vika_neutral_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_sad_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_sad_style1_summer.png',
                '/heart_at_crossroads/assets/characters/vika/vika_smile_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_surprised_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_thoughtful_style1.png',
                '/heart_at_crossroads/assets/characters/vika/vika_worry_style1.png'
            ];
            let loaded = 0;
            const totalImages = images.length;
            const failedImages = [];
            const updateStatus = () => {
                const percentage = Math.floor((loaded / totalImages) * 100);
                loadingStatus.textContent = `${texts.loading}: ${loaded}/${totalImages} (${percentage}%)`;
            };
            const showErrorMessage = (message) => {
                const errorElement = document.createElement('div');
                errorElement.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(255,0,0,0.7); color: white; padding: 10px; z-index: 9999; border-radius: 5px;';
                errorElement.textContent = message;
                document.body.appendChild(errorElement);
                setTimeout(() => {
                    errorElement.style.opacity = '0';
                    errorElement.style.transition = 'opacity 0.5s';
                    setTimeout(() => errorElement.remove(), 500);
                }, 3000);
            };
            updateStatus();
            try {
                const promises = images.map(src => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            loaded++;
                            updateStatus();
                            console.log(`‚úÖ ${texts.loading}: ${src}`);
                            resolve(true);
                        };
                        img.onerror = () => {
                            loaded++;
                            failedImages.push(src.split('/').pop());
                            updateStatus();
                            console.warn(`‚ùå ${texts.loadError}: ${src}`);
                            resolve(false);
                        };
                        img.src = src;
                    });
                });
                const results = await Promise.all(promises);
                const successCount = results.filter(success => success).length;
                console.log(`‚úÖ ${texts.loading}: ${successCount}/${totalImages} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã`);
                if (failedImages.length > 0) {
                    failedImages.slice(0, 3).forEach(img => {
                        showErrorMessage(`${texts.imageNotFound}: ${img}`);
                    });
                    if (failedImages.length > 3) {
                        showErrorMessage(`${texts.imageNotFound}: ${failedImages.length - 3} more...`);
                    }
                }
                return { 
                    success: successCount, 
                    failed: failedImages.length, 
                    failedImages 
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', error);
                throw error;
            } finally {
                loadingStatus.style.opacity = '0';
                loadingStatus.style.transition = 'opacity 0.5s';
                setTimeout(() => loadingStatus.remove(), 500);
            }
        }

        async function loadChapter(chapterId) {
    console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤—ã ${chapterId}`);
    const jsonPath = `/heart_at_crossroads/assets/data/chapter${chapterId}.json`;
    try {
        const response = await fetch(jsonPath, {
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
                'Accept': 'application/json'
            }
        });
        if (!response.ok) {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ${jsonPath}: ${response.status} ${response.statusText}`);
            showErrorMessage(stats.language === "ru" ? `–ì–ª–∞–≤–∞ ${chapterId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞` : `Chapter ${chapterId} not found`);
            showStartScreen();
            return false;
        }
        const text = await response.text();
        const data = JSON.parse(text);
        if (!data || !data.scenes || !Array.isArray(data.scenes)) {
            throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON');
        }
        scriptData = data;
        console.log(`–ì–ª–∞–≤–∞ ${chapterId} –∑–∞–≥—Ä—É–∂–µ–Ω–∞:`, scriptData);
        return true;
    } catch (error) {
        console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã ${chapterId}:`, error);
        showErrorMessage(stats.language === "ru" ? `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã ${chapterId}` : `Error loading chapter ${chapterId}`);
        showStartScreen();
        return false;
    }
}

        function createChoiceButton(choice) {
            const btn = document.createElement('button');
            const hasCostInText = choice.text[stats.language].includes(`${choice.cost}`);
            let buttonText = choice.text[stats.language].replace(" (10 —Å–µ–∫)", "").replace(" (10 sec)", "");
            btn.textContent = choice.cost && !hasCostInText 
                ? `${buttonText} (${choice.cost} –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤)` 
                : buttonText;
            btn.className = 'choice-btn';
            if (choice.text[stats.language].length > 30) btn.style.fontSize = '12px';
            if (choice.text[stats.language].length > 60) btn.style.minHeight = '64px';
            return btn;
        }

        function saveChoice(choiceId, effects, memoryTag) {
            choices.push(choiceId);
            if (effects) {
                for (let key in effects) {
                    if (key === 'relationships') {
                        for (let rel in effects[key]) {
                            stats.relationships[rel] = (stats.relationships[rel] || 0) + effects[key][rel];
                        }
                    } else {
                        stats[key] = (stats[key] || 0) + effects[key];
                    }
                }
            }
            if (memoryTag) {
                stats.memories.push(memoryTag);
                const notification = document.createElement('div');
                notification.className = 'memory-notification';
                notification.textContent = stats.language === "ru" ? "–í–∏–∫–∞ –∑–∞–ø–æ–º–Ω–∏—Ç –≤–∞—à –≤—ã–±–æ—Ä" : "Vika will remember your choice";
                document.getElementById('game-container').appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
            saveSession();
        }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
function updateProgress(sceneId, totalScenes) {
    console.log(`[updateProgress] –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å: ${sceneId + 1}/${totalScenes}`);
    const progressElement = document.getElementById('progress');
    const progressPercent = ((sceneId + 1) / totalScenes) * 100;
    progressElement.style.width = `${progressPercent}%`;
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
async function setupBackground(newBackground, language) {
    console.log(`[setupBackground] –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω: ${newBackground}`);
    const bgUrl = newBackground === 'none' ? 'none' : `/heart_at_crossroads/assets/backgrounds/${newBackground}.png`;
    if (bgUrl !== 'none') {
        const exists = await checkAssetExists(bgUrl);
        console.log(`[setupBackground] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ–Ω–∞ ${bgUrl}: ${exists ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);
        if (!exists) {
            console.warn(`–§–æ–Ω ${newBackground}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            showErrorMessage(language === "ru" ? `–§–æ–Ω ${newBackground} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Background ${newBackground} not found`);
        }
    }
    document.getElementById('background').style.backgroundImage = bgUrl === 'none' ? 'none' : `url('${bgUrl}')`;
    return newBackground;
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
async function setupCharacters(scene, language, stats) {
    console.log(`[setupCharacters] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —Å—Ü–µ–Ω—ã ${scene.id}`);
    const charLeft = document.getElementById('character-left');
    const charRight = document.getElementById('character-right');
    const speakerName = scene.speaker ? scene.speaker[language] : '';

    charLeft.style.backgroundImage = 'none';
    charRight.style.backgroundImage = 'none';
    charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
    charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

    if (scene.characterLeft) {
        const leftChar = scene.characterLeft.includes('${stats.appearance}')
            ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
            : scene.characterLeft;
        const leftCharUrl = `/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png`;
        const exists = await checkAssetExists(leftCharUrl);
        console.log(`[setupCharacters] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${leftCharUrl}: ${exists ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);
        if (!exists) {
            console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${leftChar}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            showErrorMessage(language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${leftChar} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${leftChar} not found`);
        }
        charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
        charLeft.classList.add(speakerName === "–ê–Ω–Ω–∞" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
    }

    if (scene.characterRight) {
        const rightChar = scene.characterRight.includes('${stats.appearance}')
            ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
            : scene.characterRight;
        const rightCharUrl = `/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png`;
        const exists = await checkAssetExists(rightCharUrl);
        console.log(`[setupCharacters] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${rightCharUrl}: ${exists ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);
        if (!exists) {
            console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${rightChar}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            showErrorMessage(language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${rightChar} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${rightChar} not found`);
        }
        charRight.style.backgroundImage = `url('${rightCharUrl}')`;
        charRight.classList.add(speakerName === "–í–∏–∫–∞" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
    }

    document.getElementById('speaker-name').textContent = speakerName;
    console.log(`[setupCharacters] –ò–º—è —Å–ø–∏–∫–µ—Ä–∞: ${speakerName}`);
}

// –°–æ–∑–¥–∞–Ω–∏–µ –æ–≤–µ—Ä–ª–µ—è
   function createOverlayIfNeeded(sceneId, displayText, hasTimer = false) {
    console.log(`[createOverlayIfNeeded] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω—ã ${sceneId}, hasTimer: ${hasTimer}`);
    const sceneData = scriptData.scenes.find(s => s.id === sceneId) || {};
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–µ phone –≤ –¥–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω—ã
    const hasPhoneField = sceneData.phone === 1;
    
    if (hasPhoneField) {
        if (hasTimer) {
            console.log(`[createOverlayIfNeeded] –°–æ–∑–¥–∞—ë–º showMessengerOverlay –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId} (phone=1, hasTimer=true)`);
            return showMessengerOverlay(sceneId);
        } else {
            console.log(`[createOverlayIfNeeded] –°–æ–∑–¥–∞—ë–º createDefaultOverlay –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId} (phone=1, hasTimer=false)`);
            return createDefaultOverlay(sceneId, sceneData);
        }
        }
      return null;
      }

// –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
function clearDialogueHandlers(dialogueBox) {
    console.log('[clearDialogueHandlers] –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤');
    dialogueBox.onclick = null;
    dialogueBox.ontouchstart = null;
    document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
function handleChoices(scene, dialogueBox, overlay) {
    dialogueBox.style.pointerEvents = 'auto';
    if (!scene.choices || scene.choices.length === 0) return;

    console.log(`[handleChoices] –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–ª—è —Å—Ü–µ–Ω—ã ${scene.id}`);
    if (scene.choices.some(c => c.timer)) {
        console.log(`[${Date.now()}] –ü–µ—Ä–µ—Ö–æ–¥ –∫ showSceneWithTimer`);
        showSceneWithTimer(scene);
    } else {
        console.log(`[${Date.now()}] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞`);
        scene.choices.forEach(choice => {
            const btn = createChoiceButton(choice);
            if (choice.condition && !checkCondition(choice.condition)) {
                btn.style.display = 'none';
            } else if (choice.cost && stats.diamonds < choice.cost) {
                btn.disabled = true;
            } else {
                const handleChoice = (e) => {
                    e.preventDefault();
                    console.log(`[${Date.now()}] –í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω: ${choice.id}`);
                    if (choice.cost) stats.diamonds -= choice.cost;
                    updateDiamondsDisplay();
                    saveChoice(choice.id, choice.effects, choice.memoryTag);
                    if (choice.effects) showChoiceEffects(choice.effects);
                    if (overlay) overlay.remove();
                    if (choice.nextScene !== undefined) {
                        currentScene = choice.nextScene;
                        saveSession();
                        showScene(currentScene);
                    } else if (choice.nextChapter) {
                        currentChapter = choice.nextChapter;
                        currentScene = 0;
                        loadChapter(currentChapter).then(() => showScene(currentScene));
                    }
                };
                btn.addEventListener('touchstart', handleChoice);
                btn.addEventListener('click', handleChoice);
            }
            dialogueBox.appendChild(btn);
        });
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω—ã
       function handleNextScene(scene, dialogueBox, overlay) {
    if (!scene.nextScene) return;

    console.log(`[${Date.now()}] –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å—Ü–µ–Ω–µ ${scene.nextScene}`);
    console.log(`[handleNextScene] –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: scene.id=${scene.id}, dialogueBox=${dialogueBox ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}, overlay=${overlay ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);
    if (!dialogueBox) {
        console.error('[handleNextScene] dialogueBox –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    const handleNext = (e) => {
        e.preventDefault();
        console.log(`[${Date.now()}] –¢–∞–ø: –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ü–µ–Ω–µ ${scene.nextScene}`);
        currentScene = scene.nextScene;
        saveSession();
        if (overlay) overlay.remove();
        dialogueBox.style.pointerEvents = 'none';
        dialogueBox.removeEventListener('touchstart', handleNext, { passive: false });
        dialogueBox.removeEventListener('click', handleNext);
        showScene(currentScene);
    };

    // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    if (dialogueBox.touchHandler) {
        dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler, { passive: false });
        dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
        console.log('[handleNextScene] –û—á–∏—â–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ touchHandler');
    }

    dialogueBox.touchHandler = handleNext;
    dialogueBox.addEventListener('touchstart', handleNext, { passive: false });
    dialogueBox.addEventListener('click', handleNext);
    dialogueBox.style.pointerEvents = 'auto';
    console.log(`[handleNextScene] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, pointerEvents: ${dialogueBox.style.pointerEvents}`);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ü–∞ –≥–ª–∞–≤—ã
   function handleChapterEnd(scene) {
    if (scene.id !== scriptData.scenes.length - 1) return;

    console.log(`[${Date.now()}] –ö–æ–Ω–µ—Ü –≥–ª–∞–≤—ã ${currentChapter}, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π`);
    currentChapter++;
    currentScene = 0;
    loadChapter(currentChapter).then(success => {
        if (success) {
            console.log(`–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ü–µ–Ω–µ ${currentScene} –≥–ª–∞–≤—ã ${currentChapter}`);
            showScene(currentScene);
        } else {
            console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–∞–≤—É ${currentChapter}`);
        }
    });
}

    async function showScene(sceneId) {
    console.log(`–ü–æ–∫–∞–∑ —Å—Ü–µ–Ω—ã ${sceneId}`);
    const scene = scriptData.scenes.find(s => s.id === sceneId);
    if (!scene) {
        console.error('–°—Ü–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', sceneId);
        return;
    }

    const progressElement = document.getElementById('progress');
    const totalScenes = scriptData.scenes.length;
    const progressPercent = ((sceneId + 1) / totalScenes) * 100;
    progressElement.style.width = `${progressPercent}%`;

    const dialogueBox = document.querySelector('.dialogue-box');
    const dialogueElement = document.getElementById('dialogue-text');
    let displayText = scene.text[stats.language];
    if (stats.completionCount >= 1 && scene.second_playthrough_text) {
        displayText = scene.second_playthrough_text[stats.language];
    }
    console.log(`[showScene] –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${displayText}`);

    const newBackground = scene.background || 'none';
    const shouldFade = currentBackground !== newBackground || sceneId === scriptData.scenes.length - 1;

    const applyScene = async () => {
        console.log('[applyScene] –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ü–µ–Ω—É');
        currentBackground = await setupBackground(newBackground, stats.language);
        await setupCharacters(scene, stats.language, stats);

        const overlay = createOverlayIfNeeded(sceneId, displayText, scene.choices && scene.choices.some(c => c.timer));
        clearDialogueHandlers(dialogueBox);
        dialogueBox.style.pointerEvents = 'none';

        console.log('[applyScene] –ó–∞–ø—É—Å–∫–∞–µ–º typeText');
        typeText(displayText, dialogueElement, () => {
            console.log(`[${Date.now()}] –¢–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã ${sceneId} –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫–∞–∑–∞–Ω`);
            console.log(`[showScene] –ü—Ä–æ–≤–µ—Ä–∫–∞: scene.id=${sceneId}, totalScenes=${totalScenes}, nextScene=${scene.nextScene}`);
            dialogueBox.style.pointerEvents = 'auto';
            handleChoices(scene, dialogueBox, overlay);
            handleNextScene(scene, dialogueBox, overlay);
            handleChapterEnd(scene);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω–µ—Ü –≥–ª–∞–≤—ã –∏–ª–∏ –≤–µ—Ç–∫–∏
            if (!scene.choices && scene.nextScene === null) {
                console.log(`[showScene] nextScene === null, —Å—á–∏—Ç–∞–µ–º –∫–æ–Ω—Ü–æ–º –≥–ª–∞–≤—ã`);
                currentChapter++;
                currentScene = 0;
                loadChapter(currentChapter).then(success => {
                    if (success) {
                        console.log(`[showScene] –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—à–ª–∏ –∫ –≥–ª–∞–≤–µ ${currentChapter}, —Å—Ü–µ–Ω–∞ ${currentScene}`);
                        showScene(currentScene);
                    } else {
                        console.warn(`[showScene] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–∞–≤—É ${currentChapter}`);
                        showStartScreen();
                    }
                });
            } else if (!scene.choices && scene.nextScene === undefined) {
                console.warn(`[showScene] –ù–µ—Ç choices/nextScene –¥–ª—è —Å—Ü–µ–Ω—ã ${sceneId}, –Ω–æ nextScene –Ω–µ null`);
                if (sceneId === scriptData.scenes.length - 1) {
                    console.log(`[showScene] –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ü–µ–Ω–∞, –∑–∞–≤–µ—Ä—à–∞–µ–º –≥–ª–∞–≤—É`);
                    currentChapter++;
                    currentScene = 0;
                    loadChapter(currentChapter).then(success => {
                        if (success) showScene(currentScene);
                    });
                } else {
                    console.log(`[showScene] –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω–µ`);
                    addTapHandler(dialogueBox, () => {
                        if (overlay) overlay.remove();
                        currentScene = sceneId + 1;
                        saveSession();
                        showScene(currentScene);
                    });
                }
            }
        });
    };

    if (shouldFade) {
        fadeOut(() => {
            applyScene();
            fadeIn();
        });
    } else {
        await applyScene();
    }

    if (scene.leadsToEnding) {
        console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ü–æ–≤–∫–∏: ${scene.leadsToEnding}`);
        loadFinals(scene.leadsToEnding);
    }
}


                        function showSceneWithTimer(scene, timeoutMs = 10000) {
    console.log(`[showSceneWithTimer] –ü–æ–∫–∞–∑ —Å—Ü–µ–Ω—ã ${scene.id} —Å —Ç–∞–π–º–µ—Ä–æ–º (${timeoutMs}–º—Å)`);

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const progressElement = document.getElementById('progress');
    const backgroundElement = document.getElementById('background');
    const charLeft = document.getElementById('character-left');
    const charRight = document.getElementById('character-right');
    const dialogueElement = document.getElementById('dialogue-text');
    const dialogueBox = document.querySelector('.dialogue-box');

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
    const totalScenes = scriptData.scenes.length;
    const progressPercent = ((scene.id + 1) / totalScenes) * 100;
    progressElement.style.width = `${progressPercent}%`;

    // –í—ã–±–æ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
    let displayText = scene.text[stats.language];
    if (stats.completionCount >= 1 && scene.second_playthrough_text) {
        displayText = scene.second_playthrough_text[stats.language];
    }
    console.log(`[showSceneWithTimer] –¢–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${displayText}`);

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞—Ç—É—Ö–∞–Ω–∏—è
    const newBackground = scene.background || 'none';
    const shouldFade = currentBackground !== newBackground || scene.id === scriptData.scenes.length - 1;

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å—Ü–µ–Ω—ã
    const applyScene = async () => {
        console.log('[applyScene] –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ü–µ–Ω—É —Å —Ç–∞–π–º–µ—Ä–æ–º');

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–∞
        const bgUrl = newBackground === 'none' ? 'none' : `/heart_at_crossroads/assets/backgrounds/${newBackground}.png`;
        if (bgUrl !== 'none' && !(await checkAssetExists(bgUrl))) {
            console.warn(`–§–æ–Ω ${newBackground}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
            showErrorMessage(stats.language === "ru" ? `–§–æ–Ω ${newBackground} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Background ${newBackground} not found`);
        }
        backgroundElement.style.backgroundImage = bgUrl === 'none' ? 'none' : `url('${bgUrl}')`;
        currentBackground = newBackground;

        // –û—á–∏—Å—Ç–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        charLeft.style.backgroundImage = 'none';
        charRight.style.backgroundImage = 'none';
        charLeft.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');
        charRight.classList.remove('character-speaker', 'character-non-speaker', 'shiver', 'heartbeat');

        const speakerName = scene.speaker ? scene.speaker[stats.language] : '';
        if (scene.characterLeft) {
            const leftChar = scene.characterLeft.includes('${stats.appearance}') 
                ? scene.characterLeft.replace('${stats.appearance}', stats.appearance)
                : scene.characterLeft;
            const leftCharUrl = `/heart_at_crossroads/assets/characters/${leftChar.split('_')[0]}/${leftChar}.png`;
            if (!(await checkAssetExists(leftCharUrl))) {
                console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${leftChar}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                showErrorMessage(stats.language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${leftChar} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${leftChar} not found`);
            }
            charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
            charLeft.classList.add(speakerName === "–ê–Ω–Ω–∞" || speakerName === "Anna" ? 'character-speaker' : 'character-non-speaker');
        }
        if (scene.characterRight) {
            const rightChar = scene.characterRight.includes('${stats.appearance}') 
                ? scene.characterRight.replace('${stats.appearance}', stats.appearance)
                : scene.characterRight;
            const rightCharUrl = `/heart_at_crossroads/assets/characters/${rightChar.split('_')[0]}/${rightChar}.png`;
            if (!(await checkAssetExists(rightCharUrl))) {
                console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${rightChar}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                showErrorMessage(stats.language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${rightChar} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${rightChar} not found`);
            }
            charRight.style.backgroundImage = `url('${rightCharUrl}')`;
            charRight.classList.add(speakerName === "–í–∏–∫–∞" || speakerName === "Vika" ? 'character-speaker' : 'character-non-speaker');
        }

        // –°–º–µ—â–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
        if (scene.characterLeftOffset) charLeft.style.left = scene.characterLeftOffset;
        if (scene.characterRightOffset) charRight.style.right = scene.characterRightOffset;

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
        if (dialogueBox.touchHandler) {
            dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler, { passive: false });
            dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
            dialogueBox.touchHandler = null;
            console.log('[showSceneWithTimer] –û—á–∏—â–µ–Ω—ã —Å—Ç–∞—Ä—ã–µ touchHandler');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –æ–≤–µ—Ä–ª–µ—è –¥–ª—è —Å—Ü–µ–Ω—ã —Å —Ç–∞–π–º–µ—Ä–æ–º (–¢–û–õ–¨–ö–û showMessengerOverlay)
        let overlay = null;
        if (scene.choices && scene.choices.some(c => c.timer)) {
            overlay = showMessengerOverlay(scene.id); // –ò—Å–ø–æ–ª—å–∑—É–µ–º showMessengerOverlay –¥–ª—è —Å—Ü–µ–Ω —Å —Ç–∞–π–º–µ—Ä–æ–º
            console.log(`[showSceneWithTimer] –°–æ–∑–¥–∞–Ω –æ–≤–µ—Ä–ª–µ–π —Å —Ç–∞–π–º–µ—Ä–æ–º –¥–ª—è —Å—Ü–µ–Ω—ã ${scene.id}`);
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–º–µ–Ω–∏ —Å–ø–∏–∫–µ—Ä–∞
        document.getElementById('speaker-name').textContent = speakerName;

        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞ –∏ –º—É–∑—ã–∫–∏
        if (scene.sound) playSound(scene.sound);
        if (scene.music) playMusic(scene.music);

        // –ü–µ—á–∞—Ç—å —Ç–µ–∫—Å—Ç–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞
        typeText(displayText, dialogueElement, () => {
            console.log(`[${Date.now()}] –¢–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã ${scene.id} –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫–∞–∑–∞–Ω`);
            dialogueBox.style.pointerEvents = 'auto'; // –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å

            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞
            scene.choices.forEach(choice => {
                const btn = createChoiceButton(choice);
                if (choice.condition && !checkCondition(choice.condition)) {
                    btn.style.display = 'none';
                } else if (choice.cost && stats.diamonds < choice.cost) {
                    btn.disabled = true;
                } else {
                    const handleChoice = (e) => {
                        e.preventDefault();
                        console.log(`[${Date.now()}] –í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω: ${choice.id}`);
                        if (choice.cost) stats.diamonds -= choice.cost;
                        updateDiamondsDisplay();
                        saveChoice(choice.id, choice.effects, choice.memoryTag);
                        if (choice.effects) showChoiceEffects(choice.effects);
                        clearInterval(countdownInterval);
                        clearTimeout(timer);
                        if (overlay) overlay.remove();
                        document.getElementById('timer-countdown')?.remove();
                        if (tickSound) tickSound.pause();
                        if (choice.nextScene !== undefined) {
                            currentScene = choice.nextScene;
                            saveSession();
                            showScene(currentScene);
                        } else if (choice.nextChapter) {
                            currentChapter = choice.nextChapter;
                            currentScene = 0;
                            loadChapter(currentChapter).then(() => showScene(currentScene));
                        }
                    };
                    btn.addEventListener('touchstart', handleChoice, { passive: false });
                    btn.addEventListener('click', handleChoice);
                }
                dialogueBox.appendChild(btn);
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–µ—Ä–∞
            const timerDuration = scene.choices.find(c => c.timer)?.timer * 1000 || timeoutMs;
            let timeLeft = timerDuration / 1000;

            const countdownElement = document.createElement('div');
            countdownElement.id = 'timer-countdown';
            countdownElement.textContent = timeLeft;
            document.getElementById('game-container').appendChild(countdownElement);

            // –ó–≤—É–∫ —Ç–∏–∫–∞—é—â–µ–≥–æ —Ç–∞–π–º–µ—Ä–∞
            const tickSound = new Audio('/heart_at_crossroads/assets/sounds/sfx_tick.mp3');
            tickSound.loop = false;
            tickSound.play().catch(err => {
                console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è sfx_tick:', err);
                showErrorMessage(stats.language === "ru" ? '–ó–≤—É–∫ sfx_tick.mp3 –Ω–µ –Ω–∞–π–¥–µ–Ω' : 'Sound sfx_tick.mp3 not found');
            });

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            const countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;
                if (overlay) {
                    overlay.classList.add('flash-svg');
                    setTimeout(() => overlay.classList.remove('flash-svg'), 500);
                }
                if ('vibrate' in navigator) navigator.vibrate(200);
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    tickSound.pause();
                }
            }, 1000);

            // –î–µ–π—Å—Ç–≤–∏–µ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–∞–π–º–µ—Ä–∞
            const timer = setTimeout(() => {
                const defaultChoice = scene.choices.find(c => c.id === 'ignore');
                console.log(`[${Date.now()}] –¢–∞–π–º–µ—Ä –∏—Å—Ç—ë–∫, –≤—ã–±–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ${defaultChoice?.id || '–Ω–µ –Ω–∞–π–¥–µ–Ω'}`);
                clearInterval(countdownInterval);
                if (overlay) overlay.remove();
                document.getElementById('timer-countdown')?.remove();
                tickSound.pause();
                if (defaultChoice && defaultChoice.nextScene !== undefined) {
                    currentScene = defaultChoice.nextScene;
                    saveSession();
                    showScene(currentScene);
                } else if (scene.id === scriptData.scenes.length - 1) {
                    currentChapter++;
                    currentScene = 0;
                    loadChapter(currentChapter).then(success => {
                        if (success) showScene(currentScene);
                    });
                } else {
                    console.warn('–ù–µ—Ç —Å—Ü–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ç–∞–π–º–µ—Ä–∞!');
                }
            }, timerDuration);
        });
    };

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∑–∞—Ç—É—Ö–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if (shouldFade) {
        fadeOut(() => {
            applyScene();
            fadeIn();
        });
    } else {
        applyScene();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ü–æ–≤–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å
    if (scene.leadsToEnding) {
        console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ü–æ–≤–∫–∏: ${scene.leadsToEnding}`);
        loadFinals(scene.leadsToEnding);
    }
}

        function showPremiumGallery() {
    console.log('showPremiumGallery –≤—ã–∑–≤–∞–Ω, stats.memories:', stats.memories);
    if (!window.gsap) {
        console.error("GSAP –Ω–µ –Ω–∞–π–¥–µ–Ω, fallback –Ω–∞ –ø—Ä–æ—Å—Ç—É—é –≥–∞–ª–µ—Ä–µ—é.");
        return showSimpleGallery();
    }

    const isRussian = stats.language === "ru";
    const fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
    const galleryContainer = document.getElementById('gallery-container');
    const startScreen = document.getElementById('start-screen');
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.style.overflow = 'hidden';
    
    galleryContainer.style.display = 'flex';
    galleryContainer.setAttribute('data-gallery', 'true');
    startScreen.style.display = 'none';

    galleryContainer.innerHTML = '';

    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏"
    const galleryHeader = document.createElement('div');
    galleryHeader.className = 'gallery-header';
    galleryHeader.style.fontFamily = fontFamily;
    galleryHeader.textContent = isRussian ? "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏" : "Collection Cards";

    // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ "–ü—Ä–æ—à–ª–æ–µ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞"
    const subHeader = document.createElement('div');
    subHeader.style.cssText = `
        color: #F5E6C9; font-size: 2rem; text-align: center; 
        margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    `;
    subHeader.style.fontFamily = fontFamily;
    subHeader.textContent = isRussian ? "–ü—Ä–æ—à–ª–æ–µ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞" : "The past remains forever";

    // –ù–∞–¥–ø–∏—Å—å "–°–µ—Ä–∏—è: –†–æ–º–∞–Ω—Ç–∏–∫–∞ 0/4"
    const seriesTitle = document.createElement('div');
    seriesTitle.className = 'series-title';
    seriesTitle.style.cssText = `
        color: #e0c18e; font-size: 1.5rem; margin-bottom: 1rem; 
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3); text-align: center;
    `;
    seriesTitle.style.fontFamily = fontFamily;
    const unlockedCount = cardSeries["romance"].cards.filter(card => stats.memories?.includes(card.id)).length;
    seriesTitle.textContent = isRussian 
        ? `–°–µ—Ä–∏—è: –†–æ–º–∞–Ω—Ç–∏–∫–∞ ${unlockedCount}/4`
        : `Series: Romance ${unlockedCount}/4`;

    // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ä–∏–π "–†–æ–º–∞–Ω—Ç–∏–∫–∞"
    const seriesButton = document.createElement('button');
    seriesButton.style.cssText = `
        background: linear-gradient(to bottom, #8C6F4A, #5A3F2A);
        color: #F5E6C9; border: none; padding: 8px 16px; border-radius: 20px;
        font-weight: bold; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px; cursor: pointer;
    `;
    seriesButton.style.fontFamily = fontFamily;
    seriesButton.textContent = isRussian ? "–†–æ–º–∞–Ω—Ç–∏–∫–∞" : "Romance";

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
    const cardsContainer = document.createElement('div');
    cardsContainer.className = 'cards-container';

    // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
    const prevButton = document.createElement('button');
    prevButton.textContent = '<';
    prevButton.style.cssText = `
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        background: #8C6F4A; color: #F5E6C9; border: none; padding: 10px 15px;
        border-radius: 50%; font-size: 1.5rem; cursor: pointer;
    `;

    const nextButton = document.createElement('button');
    nextButton.textContent = '>';
    nextButton.style.cssText = `
        position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
        background: #8C6F4A; color: #F5E6C9; border: none; padding: 10px 15px;
        border-radius: 50%; font-size: 1.5rem; cursor: pointer;
    `;

    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è
    const closeButton = document.createElement('button');
    closeButton.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="#e0c18e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>`;
    closeButton.style.cssText = `
        position: absolute; top: 1rem; right: 1rem; background: transparent;
        border: none; color: #e0c18e; font-size: 1.5rem; cursor: pointer;
        opacity: 0; width: 40px; height: 40px; display: flex;
        align-items: center; justify-content: center; border-radius: 50%;
        transition: background 0.3s;
    `;
    closeButton.onmouseover = () => closeButton.style.background = 'rgba(224, 193, 142, 0.2)';
    closeButton.onmouseout = () => closeButton.style.background = 'transparent';

    // –°–±–æ—Ä–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    galleryContainer.appendChild(galleryHeader);
    galleryContainer.appendChild(subHeader);
    galleryContainer.appendChild(seriesTitle);
    galleryContainer.appendChild(seriesButton);
    galleryContainer.appendChild(prevButton);
    galleryContainer.appendChild(nextButton);
    galleryContainer.appendChild(cardsContainer);
    galleryContainer.appendChild(closeButton);

    // –ó–≤—É–∫–∏
    const clickSound = new Audio('/heart_at_crossroads/assets/sounds/sfx_camera_click.mp3');
    clickSound.load();

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    gsap.to(galleryContainer, {
        opacity: 1,
        duration: 0.5,
        ease: "power2.out",
        onComplete: () => {
            gsap.to(galleryHeader, { opacity: 1, y: 0, duration: 0.8, ease: "back.out(1.7)" });
            gsap.to(subHeader, { opacity: 1, y: 0, duration: 0.8, delay: 0.1, ease: "back.out(1.7)" });
            gsap.to(seriesTitle, { opacity: 1, y: 0, duration: 0.8, delay: 0.2, ease: "back.out(1.7)" });
            gsap.to(seriesButton, { opacity: 1, duration: 0.8, delay: 0.3, ease: "power2.out" });
            gsap.to(prevButton, { opacity: 1, duration: 0.5, delay: 0.4, ease: "power2.out" });
            gsap.to(nextButton, { opacity: 1, duration: 0.5, delay: 0.4, ease: "power2.out" });
            gsap.to(closeButton, { opacity: 1, duration: 0.5, delay: 0.4, ease: "power2.out" });
            switchSeries('romance', cardsContainer, clickSound, isRussian);
        }
    });

    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
    let currentFrontIndex = 0;
    const cardCount = cardSeries['romance'].cards.length;

    function updateCards() {
        cardSeries['romance'].cards.forEach((card, index) => {
            const cardElement = cardsContainer.querySelector(`[data-card-id="${card.id}"]`);
            const relativeIndex = (index - currentFrontIndex + cardCount) % cardCount;
            const zStep = 150;
            const angleStep = 15;
            const screenWidth = window.innerWidth;
            const cardWidth = 250;
            const maxVisibleWidth = Math.min(screenWidth - 20, 500);

            gsap.to(cardElement, {
                z: relativeIndex * zStep,
                rotateY: relativeIndex * angleStep,
                opacity: 1 - relativeIndex * 0.2,
                scale: Math.min(1 - relativeIndex * 0.05, maxVisibleWidth / cardWidth),
                zIndex: cardCount - relativeIndex,
                duration: 0.8,
                ease: "power2.inOut"
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    addEventListeners(seriesButton, ['click', 'touchstart'], () => {
        switchSeries('romance', cardsContainer, clickSound, isRussian);
        clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
    });

    addEventListeners(prevButton, ['click', 'touchstart'], () => {
        currentFrontIndex = (currentFrontIndex - 1 + cardCount) % cardCount;
        updateCards();
        clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
    });

    addEventListeners(nextButton, ['click', 'touchstart'], () => {
        currentFrontIndex = (currentFrontIndex + 1) % cardCount;
        updateCards();
        clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
    });

    addEventListeners(closeButton, ['click', 'touchstart'], () => {
        document.body.style.overflow = ''; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É
        closeGallery();
        clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
    });
}


   function switchSeries(seriesKey, cardsContainer, clickSound, isRussian) {
    console.log('switchSeries –≤—ã–∑–≤–∞–Ω –¥–ª—è:', seriesKey);
    const series = cardSeries[seriesKey];
    if (!series) return;

    cardsContainer.innerHTML = '';
    const cardCount = series.cards.length;
    const zStep = 150; // –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ç–∞–ø–∞
    const angleStep = 15; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —É–≥–æ–ª –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
    const screenWidth = window.innerWidth;
    const cardWidth = 250; // –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
    const maxVisibleWidth = Math.min(screenWidth - 20, 500); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ —ç–∫—Ä–∞–Ω–∞

    series.cards.forEach((card, index) => {
        const cardElement = createCardElement(card, seriesKey, cardsContainer, clickSound, isRussian);
        const zPosition = index * zStep;
        const rotateY = index * angleStep;

        gsap.set(cardElement, {
            z: zPosition,
            rotateY: rotateY,
            opacity: 1 - index * 0.2,
            scale: Math.min(1 - index * 0.05, maxVisibleWidth / cardWidth),
        });

        cardElement.style.zIndex = cardCount - index;
        cardsContainer.appendChild(cardElement);

        addEventListeners(cardElement, ['click', 'touchstart'], (e) => {
            e.preventDefault();
            if (stats.memories?.includes(card.id)) {
                showCardDetail(card, isRussian, clickSound);
            }
            // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–æ–∂–Ω–æ –ª–∏—Å—Ç–∞—Ç—å –∫–Ω–æ–ø–∫–∞–º–∏, –Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å
        });
    });
}

function createCardElement(card, seriesKey, cardsContainer, clickSound, isRussian) {
    const isUnlocked = stats.memories?.includes(card.id);
    const cardElement = document.createElement('div');
    cardElement.className = 'premium-card';
    cardElement.dataset.cardId = card.id;
    if (!isUnlocked) cardElement.classList.add('locked');

    if (isUnlocked) {
        const cardImg = document.createElement('img');
        cardImg.src = `/heart_at_crossroads/assets/memories/${card.id}.png`;
        cardImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        cardElement.appendChild(cardImg);

        const shineEffect = document.createElement('div');
        shineEffect.className = 'card-shine-effect';
        cardElement.appendChild(shineEffect);

        const cardName = document.createElement('div');
        cardName.className = 'card-name';
        cardName.style.fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
        cardName.textContent = isRussian ? card.name : card.nameEn;
        cardElement.appendChild(cardName);
    } else {
        const lockImg = document.createElement('img');
        lockImg.src = '/heart_at_crossroads/assets/memories/card_locked.png';
        lockImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        cardElement.appendChild(lockImg);

        const unlockText = document.createElement('div');
        unlockText.className = 'unlock-text';
        unlockText.style.fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
        const diamondIcon = `<img src="/heart_at_crossroads/assets/ui/diamonds.png" style="width: 16px; height: 16px; vertical-align: middle;">`;
        unlockText.innerHTML = isRussian 
            ? `–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: ${card.unlock} ${diamondIcon}` 
            : `Unlock: ${card.unlockEn} ${diamondIcon}`;
        cardElement.appendChild(unlockText);

        const unlockButton = document.createElement('button');
        unlockButton.className = 'card-unlock-button';
        unlockButton.style.fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
        unlockButton.textContent = isRussian ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "Unlock";
        unlockButton.onclick = (e) => {
            e.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è
            unlockCard(card, cardsContainer, clickSound, isRussian);
        };
        cardElement.appendChild(unlockButton);
    }

    return cardElement;
}

    function unlockCard(card, cardsContainer, clickSound, isRussian) {
    const unlockCost = card.unlock; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    const hasEnoughDiamonds = stats.diamonds >= unlockCost; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ stats.diamonds —Ö—Ä–∞–Ω–∏—Ç –±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã
    const isSecondPlaythrough = stats.playthroughs > 1; // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ stats.playthroughs –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è

    if (hasEnoughDiamonds || isSecondPlaythrough) {
        if (hasEnoughDiamonds) {
            stats.diamonds -= unlockCost; // –°–ø–∏—Å—ã–≤–∞–µ–º –±—Ä–∏–ª–ª–∏–∞–Ω—Ç—ã
            console.log(`–ü–æ—Ç—Ä–∞—á–µ–Ω–æ ${unlockCost} –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤`);
        } else {
            console.log("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –∑–∞ –≤—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ");
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
        if (!stats.memories) stats.memories = [];
        stats.memories.push(card.id);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ –≥–∞–ª–µ—Ä–µ–µ
        const cardElement = cardsContainer.querySelector(`[data-card-id="${card.id}"]`);
        cardElement.classList.remove('locked');
        cardElement.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

        const cardImg = document.createElement('img');
        cardImg.src = `/heart_at_crossroads/assets/memories/${card.id}.png`;
        cardImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        cardElement.appendChild(cardImg);

        const shineEffect = document.createElement('div');
        shineEffect.className = 'card-shine-effect';
        cardElement.appendChild(shineEffect);

        const cardName = document.createElement('div');
        cardName.className = 'card-name';
        cardName.style.fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
        cardName.textContent = isRussian ? card.name : card.nameEn;
        cardElement.appendChild(cardName);

        // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        const unlockSound = new Audio('/heart_at_crossroads/assets/sounds/sfx_card_unlock.mp3');
        unlockSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
        clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
    } else {
        console.log("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–æ–≤ –∏–ª–∏ –Ω–µ –≤—Ç–æ—Ä–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ");
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    }
}
    function showUnlockNotification(card, isRussian) {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: linear-gradient(to bottom, #D9C2A7, #BFA78A); border: 2px dashed #8C6F4A;
            border-radius: 10px; padding: 20px; color: #333; text-align: center;
            z-index: 2000; max-width: 300px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            opacity: 0;
        `;
        notification.innerHTML = `
            <div style="font-size: 1.5rem; color: #8C6F4A; margin-bottom: 10px; font-family: ${isRussian ? 'GoodVibesCyr' : 'GreatVibes'}, cursive;">
                ${isRussian ? '–ö–∞—Ä—Ç–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!' : 'Card Unlocked!'}
            </div>
            <div style="font-size: 1.2rem; margin-bottom: 15px; font-family: ${isRussian ? 'GoodVibesCyr' : 'GreatVibes'}, cursive;">
                ${isRussian ? card.name : card.nameEn}
            </div>
            <img src="/heart_at_crossroads/assets/memories/${card.id}.png" alt="Card" style="width: 100%; border-radius: 5px; margin-bottom: 15px;">
            <button style="
                background: linear-gradient(to bottom, #8C6F4A, #5A3F2A);
                color: #F5E6C9; border: none; padding: 10px 20px; border-radius: 20px;
                font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                font-family: ${isRussian ? 'GoodVibesCyr' : 'GreatVibes'}, cursive;
            ">${isRussian ? '–°—É–ø–µ—Ä!' : 'Awesome!'}</button>
        `;
        document.body.appendChild(notification);

        gsap.to(notification, {
            opacity: 1,
            duration: 0.5,
            ease: "power2.out",
            onComplete: () => {
                const closeBtn = notification.querySelector('button');
                closeBtn.onclick = () => {
                    gsap.to(notification, {
                        opacity: 0,
                        duration: 0.3,
                        ease: "power2.in",
                        onComplete: () => document.body.removeChild(notification)
                    });
                };
            }
        });
    }

    function showCardDetail(card, isRussian, clickSound) {
        const detailContainer = document.createElement('div');
        detailContainer.className = 'card-detail';
        detailContainer.style.cssText = `
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 350px; height: 350px; background: linear-gradient(to bottom, #F5E6C9, #E6D7A8);
            border-radius: 5px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7); z-index: 3000;
        `;

        const img = document.createElement('img');
        img.src = `/heart_at_crossroads/assets/memories/${card.id}.png`;
        img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        detailContainer.appendChild(img);

        const name = document.createElement('div');
        name.style.fontFamily = isRussian ? 'GoodVibesCyr, cursive' : 'GreatVibes, cursive';
        name.textContent = isRussian ? card.name : card.nameEn;
        name.style.cssText = 'position: absolute; bottom: 0; width: 100%; text-align: center; padding: 5px; color: #333; font-size: 1.2rem;';
        detailContainer.appendChild(name);

        document.body.appendChild(detailContainer);
        document.getElementById('gallery-container').style.background = 'rgba(0, 0, 0, 0.8)';

        addEventListeners(detailContainer, ['click', 'touchstart'], () => {
            document.body.removeChild(detailContainer);
            document.getElementById('gallery-container').style.background = "url('/heart_at_crossroads/assets/images/shoebox_texture.png') center / cover no-repeat";
            clickSound.play().catch(err => console.warn("–û—à–∏–±–∫–∞ –∑–≤—É–∫–∞:", err));
        });
    }
	    
         function closeGallery() {
    console.log('closeGallery –≤—ã–∑–≤–∞–Ω');
    const galleryContainer = document.getElementById('gallery-container');
    const startScreen = document.getElementById('start-screen');

    if (galleryContainer) {
        gsap.to(galleryContainer, {
            opacity: 0,
            duration: 0.5,
            ease: "power2.in",
            onComplete: () => {
                galleryContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                galleryContainer.style.display = 'none';
                startScreen.style.display = 'flex'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
                startScreen.style.pointerEvents = 'auto';
                startScreen.style.zIndex = '3000';
            }
        });
    }

    if (startScreen) {
        startScreen.style.display = 'flex';
        startScreen.style.pointerEvents = 'auto';
        startScreen.style.zIndex = '3000';
    }
}


                       function showSimpleGallery() {
            console.log("–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –≥–∞–ª–µ—Ä–µ—é –±–µ–∑ GSAP");
            const galleryDiv = document.createElement('div');
            galleryDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0, 0, 0, 0.9); z-index: 10; overflow-y: auto;
            `;

            const galleryTitle = document.createElement('h2');
            galleryTitle.style.cssText = `
                color: #e0c18e; text-align: center; margin: 20px 0; 
                font-family: ${stats.language === "ru" ? 'GoodVibesCyr' : 'GreatVibes'}, cursive; font-size: 36px;
            `;
            galleryTitle.textContent = stats.language === "ru" ? "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏" : "Collection Cards";
            galleryDiv.appendChild(galleryTitle);

            if (stats.memories?.length > 0) {
                stats.memories.forEach(memory => {
                    const cardWrapper = document.createElement('div');
                    cardWrapper.style.cssText = 'display: inline-block; margin: 15px; position: relative;';
                    const img = document.createElement('img');
                    img.src = `/heart_at_crossroads/assets/memories/${memory}.png`;
                    img.style.cssText = 'display: block; max-width: 300px; border: 8px solid #e0c18e; border-radius: 5px;';
                    img.onerror = () => {
                        console.warn(`–í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ ${memory}.png –Ω–µ –Ω–∞–π–¥–µ–Ω–æ`);
                        cardWrapper.remove();
                    };
                    cardWrapper.appendChild(img);
                    galleryDiv.appendChild(cardWrapper);
                });
            } else {
                const noCardsMsg = document.createElement('p');
                noCardsMsg.style.cssText = 'color: #e0c18e; text-align: center; margin: 50px 0;';
                noCardsMsg.textContent = stats.language === "ru" ? "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫" : "You don't have any unlocked cards yet";
                galleryDiv.appendChild(noCardsMsg);
            }

            const closeBtn = document.createElement('button');
            closeBtn.textContent = stats.language === "ru" ? "–ó–∞–∫—Ä—ã—Ç—å" : "Close";
            closeBtn.style.cssText = `
                position: fixed; top: 10px; right: 10px; background: #333; 
                color: #e0c18e; border: 1px solid #e0c18e; padding: 5px 15px; cursor: pointer;
            `;
            closeBtn.onclick = () => galleryDiv.remove();
            galleryDiv.appendChild(closeBtn);
            document.body.appendChild(galleryDiv);
        }



        async function loadFinals(endingId) {
            const response = await fetch('/heart_at_crossroads/assets/data/finals.json');
            const finalsData = await response.json();
            const ending = finalsData.endings.find(e => e.id === endingId);
            if (ending && checkRequirements(ending.requirements)) {
                showEnding(ending);
            } else {
                console.warn('–ö–æ–Ω—Ü–æ–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã');
                showStartScreen();
            }
        }

        function checkRequirements(requirements) {
            if (!requirements) return true;
            for (let key in requirements) {
                const value = stats[key] || stats.relationships[key.split('.')[1]] || 0;
                const req = requirements[key];
                if (req.startsWith('>')) {
                    const compareValue = req.includes('+') ? 
                        (stats[req.split('+')[0].slice(1)] + stats[req.split('+')[1]]) : 
                        parseInt(req.slice(1));
                    return value > compareValue;
                }
                return value >= parseInt(req);
            }
            return true;
        }

        function showEnding(ending) {
            const scene = ending.scenes[0];
            const backgroundElement = document.getElementById('background');
            const charLeft = document.getElementById('character-left');
            const charRight = document.getElementById('character-right');
            const dialogueElement = document.getElementById('dialogue-text');
            const speakerName = document.getElementById('speaker-name');

            const bgUrl = `/heart_at_crossroads/assets/backgrounds/${scene.background}.png`;
            checkAssetExists(bgUrl).then(exists => {
                if (!exists) {
                    console.warn(`–§–æ–Ω ${scene.background}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    showErrorMessage(stats.language === "ru" ? `–§–æ–Ω ${scene.background} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Background ${scene.background} not found`);
                }
                backgroundElement.style.backgroundImage = `url('${bgUrl}')`;
            });

            if (scene.characterLeft) {
                const leftCharUrl = `/heart_at_crossroads/assets/characters/${scene.characterLeft.split('_')[0]}/${scene.characterLeft}.png`;
                checkAssetExists(leftCharUrl).then(exists => {
                    if (!exists) {
                        console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${scene.characterLeft}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                        showErrorMessage(stats.language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${scene.characterLeft} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${scene.characterLeft} not found`);
                    }
                    charLeft.style.backgroundImage = `url('${leftCharUrl}')`;
                });
            } else charLeft.style.backgroundImage = 'none';

            if (scene.characterRight) {
                const rightCharUrl = `/heart_at_crossroads/assets/characters/${scene.characterRight.split('_')[0]}/${scene.characterRight}.png`;
                checkAssetExists(rightCharUrl).then(exists => {
                    if (!exists) {
                        console.warn(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${scene.characterRight}.png –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                        showErrorMessage(stats.language === "ru" ? `–ü–µ—Ä—Å–æ–Ω–∞–∂ ${scene.characterRight} –Ω–µ –Ω–∞–π–¥–µ–Ω` : `Character ${scene.characterRight} not found`);
                    }
                    charRight.style.backgroundImage = `url('${rightCharUrl}')`;
                });
            } else charRight.style.backgroundImage = 'none';

            speakerName.textContent = scene.speaker[stats.language];
            typeText(stats.completionCount >= 1 && scene.second_playthrough_text ? 
                scene.second_playthrough_text[stats.language] : scene.text[stats.language], 
                dialogueElement, () => {
                    showEpilogue(ending.epilogue[stats.language]);
                });

            if (scene.sound) playSound(scene.sound);
            if (scene.music) playMusic(scene.music);
        }

        function showEpilogue(epilogueText) {
            const epilogueDiv = document.createElement('div');
            epilogueDiv.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); color: white; display: flex; justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 10;';
            epilogueDiv.textContent = epilogueText;
            document.body.appendChild(epilogueDiv);
            setTimeout(() => {
                epilogueDiv.remove();
                stats.completionCount++;
                saveSession();
                showStartScreen();
            }, 5000);
        }



     
function checkCondition(condition) {
    if (!condition) return true;
    const [key, operator, value] = condition.split(' ');
    const statValue = stats[key] || stats.relationships[key] || 0;
    const compareValue = parseInt(value);
    switch (operator) {
        case '>': return statValue > compareValue;
        case '<': return statValue < compareValue;
        case '>=': return statValue >= compareValue;
        case '<=': return statValue <= compareValue;
        case '==': return statValue == compareValue;
        case '!=': return statValue != compareValue;
        default: return false;
    }
}

 function typeText(text, element, callback) {
    if (isTyping) {
        console.log(`[${Date.now()}] typeText —É–∂–µ –∏–¥—ë—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
        return;
    }
    const callId = Date.now();
    console.log(`[${callId}] –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—á–∞—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç: "${text}"`);
    isTyping = true;
    console.log(`[${callId}] isTyping —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true`);
    element.textContent = '';
    if (element.typeTimer) {
        console.log(`[${callId}] –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä`);
        clearTimeout(element.typeTimer);
    }
    const parts = text.split('||').map(part => part.trim()).filter(part => part.length > 0);
    console.log(`[${callId}] –ß–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞: ${parts.length}, parts: ${JSON.stringify(parts)}`);
    let partIndex = 0;
    let i = 0;
    const speed = 50;
    const dialogueBox = document.querySelector('.dialogue-box');
    if (!dialogueBox) console.error(`[${callId}] dialogueBox –Ω–µ –Ω–∞–π–¥–µ–Ω!`);

    function clearHandlers() {
        if (dialogueBox) {
            if (dialogueBox.tapHandler) {
                dialogueBox.removeEventListener('touchstart', dialogueBox.tapHandler, { passive: false });
                dialogueBox.removeEventListener('click', dialogueBox.tapHandler);
                console.log(`[${callId}] –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–∞–ø–æ–≤ (tapHandler)`);
                dialogueBox.tapHandler = null;
            }
            if (dialogueBox.touchHandler) {
                dialogueBox.removeEventListener('touchstart', dialogueBox.touchHandler, { passive: false });
                dialogueBox.removeEventListener('click', dialogueBox.touchHandler);
                console.log(`[${callId}] –û—á–∏—Å—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Ç–∞–ø–æ–≤ (touchHandler)`);
                dialogueBox.touchHandler = null;
            }
        } else {
            console.error(`[${callId}] dialogueBox –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤`);
        }
    }
    clearHandlers();

    function type() {
        console.log(`[${callId}] type(): partIndex=${partIndex}, i=${i}, parts.length=${parts.length}`);
        if (partIndex >= parts.length) {
            isTyping = false;
            console.log(`[${callId}] isTyping —Å–±—Ä–æ—à–µ–Ω –≤ false (–≤—Å–µ —á–∞—Å—Ç–∏ –≥–æ—Ç–æ–≤—ã)`);
            clearHandlers();
            console.log(`[${callId}] –í—Å–µ —á–∞—Å—Ç–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω—ã, –≤—ã–∑—ã–≤–∞–µ–º callback`);
            if (callback) {
                console.log(`[${callId}] Callback —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º`);
                callback();
            } else {
                console.log(`[${callId}] Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω`);
            }
            return;
        }
        if (i < parts[partIndex].length) {
            element.textContent += parts[partIndex].charAt(i);
            i++;
            console.log(`[${callId}] –ü–µ—á–∞—Ç–∞–µ–º —Å–∏–º–≤–æ–ª ${i} —á–∞—Å—Ç–∏ ${partIndex + 1}: "${parts[partIndex]}"`);
            element.typeTimer = setTimeout(type, speed);
        } else {
            isTyping = false;
            console.log(`[${callId}] isTyping —Å–±—Ä–æ—à–µ–Ω –≤ false (—á–∞—Å—Ç—å ${partIndex + 1} –≥–æ—Ç–æ–≤–∞)`);
            console.log(`[${callId}] –ó–∞–≤–µ—Ä—à–µ–Ω–∞ —á–∞—Å—Ç—å ${partIndex + 1} –∏–∑ ${parts.length}`);
            if (partIndex === parts.length - 1) {
                console.log(`[${callId}] –ü–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º callback`);
                clearHandlers();
                if (callback) {
                    console.log(`[${callId}] Callback —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∑–∞–ø—É—Å–∫–∞–µ–º`);
                    callback();
                } else {
                    console.log(`[${callId}] Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω`);
                }
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏
                console.log(`[${callId}] –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞—Å—Ç–∏ ${partIndex + 2}`);
                partIndex++;
                i = 0;
                element.textContent = '';
                isTyping = true;
                type();
            }
        }
    }

    function handleTap(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log(`[${callId}] –¢–∞–ø, isTyping: ${isTyping}, partIndex=${partIndex}`);
        if (isTyping) {
            console.log(`[${callId}] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —á–∞—Å—Ç–∏ ${partIndex + 1}`);
            clearTimeout(element.typeTimer);
            element.textContent = parts[partIndex];
            i = parts[partIndex].length;
            isTyping = false;
            console.log(`[${callId}] isTyping —Å–±—Ä–æ—à–µ–Ω –≤ false (–∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–∞)`);
            if (partIndex === parts.length - 1) {
                console.log(`[${callId}] –ü—Ä–æ–ø—É—â–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —á–∞—Å—Ç—å, –≤—ã–∑—ã–≤–∞–µ–º callback`);
                clearHandlers();
                if (callback) {
                    console.log(`[${callId}] –ó–∞–ø—É—Å–∫–∞–µ–º callback –ø–æ—Å–ª–µ –ø—Ä–æ–ø—É—Å–∫–∞`);
                    callback();
                } else {
                    console.log(`[${callId}] Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –ø–æ—Å–ª–µ –ø—Ä–æ–ø—É—Å–∫–∞`);
                }
            } else {
                console.log(`[${callId}] –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞—Å—Ç–∏ ${partIndex + 2} –ø–æ—Å–ª–µ –ø—Ä–æ–ø—É—Å–∫–∞`);
                partIndex++;
                i = 0;
                element.textContent = '';
                isTyping = true;
                type();
            }
        } else if (partIndex < parts.length - 1) {
            console.log(`[${callId}] –ü–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞—Å—Ç–∏ ${partIndex + 2}`);
            partIndex++;
            i = 0;
            element.textContent = '';
            isTyping = true;
            console.log(`[${callId}] isTyping —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ true (—Å–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å)`);
            type();
        } else {
            console.log(`[${callId}] –í—Å–µ —á–∞—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω—ã, –≤—ã–∑—ã–≤–∞–µ–º callback`);
            isTyping = false;
            console.log(`[${callId}] isTyping —Å–±—Ä–æ—à–µ–Ω –≤ false (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–∞–ø)`);
            clearHandlers();
            if (callback) {
                console.log(`[${callId}] –ó–∞–ø—É—Å–∫–∞–µ–º callback –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–∞–ø–∞`);
                callback();
            } else {
                console.log(`[${callId}] Callback –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–∞–ø–∞`);
            }
        }
    }

    if (dialogueBox) {
        dialogueBox.tapHandler = handleTap;
        dialogueBox.addEventListener('touchstart', handleTap, { passive: false });
        dialogueBox.addEventListener('click', handleTap);
        console.log(`[${callId}] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞–ø–æ–≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`);
        dialogueBox.style.pointerEvents = 'auto'; // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –∫–ª–∏–∫–∞–±–µ–ª–µ–Ω
    } else {
        console.error(`[${callId}] –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–∞–ø–æ–≤: dialogueBox –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`);
    }

    type();
}


        
function fadeOut(callback) {
    const elements = [
        document.getElementById('background'),
        document.getElementById('character-left'),
        document.getElementById('character-right'),
        document.querySelector('.dialogue-box')
    ];
    elements.forEach(el => el.classList.add('fade-out'));
    setTimeout(() => {
        elements.forEach(el => el.classList.remove('fade-out'));
        if (callback) callback();
    }, 1000);
}

function fadeIn() {
    const elements = [
        document.getElementById('background'),
        document.getElementById('character-left'),
        document.getElementById('character-right'),
        document.querySelector('.dialogue-box')
    ];
    elements.forEach(el => {
        el.style.opacity = '0';
        el.style.transition = 'opacity 1s ease';
        setTimeout(() => el.style.opacity = '1', 10);
    });
}

function showChoiceEffects(effects) {
    const feedback = document.createElement('img');
    feedback.className = 'choice-feedback';
    if (effects.crown) feedback.src = '/heart_at_crossroads/assets/ui/crown.png';
    else if (effects.heart) feedback.src = '/heart_at_crossroads/assets/ui/heart.png';
    else if (effects.leaf) feedback.src = '/heart_at_crossroads/assets/ui/leaf.png';
    else return;
    document.getElementById('game-container').appendChild(feedback);
    setTimeout(() => feedback.remove(), 3000);
}

</script>
